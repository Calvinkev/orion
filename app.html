<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="api-base-url" content="/api">
    <title>Orion - Music Promotion Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
            background: #0f172a;
        }

        .hide { display: none !important; }

        /* Toast and Modal Animations */
        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes wheelSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(3600deg); }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 206, 209, 0.5); }
            50% { box-shadow: 0 0 40px rgba(0, 206, 209, 0.8), 0 0 60px rgba(0, 206, 209, 0.6); }
        }

        .lucky-wheel-container {
            position: relative;
            width: 320px;
            height: 320px;
            margin: 0 auto;
        }

        .lucky-wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            border: 8px solid #00CED1;
            box-shadow: 0 0 30px rgba(0, 206, 209, 0.4), inset 0 0 20px rgba(0, 0, 0, 0.2);
            background: conic-gradient(
                from 0deg,
                #e0f7fa 0deg 45deg,
                #b2ebf2 45deg 90deg,
                #80deea 90deg 135deg,
                #4dd0e1 135deg 180deg,
                #00CED1 180deg 225deg,
                #00ACC1 225deg 270deg,
                #0097a7 270deg 315deg,
                #00838f 315deg 360deg
            );
            transition: transform 0.1s ease-out;
        }

        .lucky-wheel.spinning {
            animation: wheelSpin 4s cubic-bezier(0.17, 0.67, 0.12, 0.99) forwards;
        }

        .wheel-segment {
            position: absolute;
            width: 50%;
            height: 50%;
            top: 50%;
            left: 50%;
            transform-origin: 0% 0%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
        }

        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #00BFFF, #00CED1);
            border-radius: 50%;
            border: 6px solid white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            z-index: 10;
        }

        .wheel-pointer {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 40px solid #00CED1;
            filter: drop-shadow(0 4px 10px rgba(0, 0, 0, 0.3));
            z-index: 20;
        }

        .spin-button {
            background: linear-gradient(135deg, #00BFFF, #00CED1);
            color: white;
            border: none;
            padding: 20px 60px;
            font-size: 24px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(0, 206, 209, 0.4);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .spin-button:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 30px rgba(0, 206, 209, 0.6);
        }

        .spin-button:active {
            transform: scale(0.98);
        }

        .spin-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: scale(1);
        }

        /* Scroll Animation Keyframes */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes zoomIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        /* Animation classes for scroll-triggered elements */
        .animate-on-scroll {
            opacity: 0;
            transition: opacity 0.6s ease, transform 0.6s ease;
        }

        .animate-on-scroll.animated {
            opacity: 1;
        }

        .slide-up {
            animation: slideInUp 0.8s ease forwards;
        }

        .slide-left {
            animation: slideInLeft 0.8s ease forwards;
        }

        .slide-right {
            animation: slideInRight 0.8s ease forwards;
        }

        .zoom-in {
            animation: zoomIn 0.8s ease forwards;
        }

        .feature-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 206, 209, 0.3);
        }

        .vip-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .vip-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 30px rgba(0, 206, 209, 0.4);
        }

        /* Login Page - Modern Full Page Design with Split Layout */
        /* ==========================================
           LOGIN & REGISTER PAGES - COMPLETE REDESIGN
           ========================================== */
        
        /* Main Container */
        .auth-page {
            min-height: 100vh;
            display: flex;
            background-color: #0f172a;
        }
        
        /* Brand Panel (Left Side) */
        .auth-brand {
            width: 50%;
            background: linear-gradient(135deg, rgba(0, 206, 209, 0.3) 0%, #0f172a 100%);
            color: white;
            padding: 48px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .auth-brand-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 48px;
        }
        
        .auth-brand-logo svg {
            color: #00CED1;
        }
        
        .auth-brand h1 {
            font-size: 2.2rem;
            font-weight: 800;
            line-height: 1.2;
            margin-bottom: 16px;
        }
        
        .auth-brand p {
            font-size: 1rem;
            opacity: 0.85;
            line-height: 1.6;
            max-width: 380px;
        }
        
        /* Form Panel (Right Side) */
        .auth-form-panel {
            width: 50%;
            background: #1e293b;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 48px;
            overflow-y: auto;
        }
        
        .auth-form-container {
            width: 100%;
            max-width: 380px;
        }
        
        .auth-form-header {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .auth-form-header h2 {
            font-size: 1.6rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 8px;
        }
        
        .auth-form-header p {
            color: #94a3b8;
            font-size: 0.9rem;
        }
        
        /* Form Elements */
        .auth-form .field {
            margin-bottom: 16px;
        }
        
        .auth-form .field label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            color: #e2e8f0;
            margin-bottom: 6px;
        }
        
        .auth-form .field label .req {
            color: #00CED1;
            margin-left: 2px;
        }
        
        .auth-form .field input[type="text"],
        .auth-form .field input[type="password"],
        .auth-form .field input[type="tel"],
        .auth-form .field input[type="email"] {
            display: block;
            width: 100%;
            padding: 12px 14px;
            font-size: 15px;
            border: 1px solid #475569;
            border-radius: 8px;
            background: #0f172a;
            color: #ffffff;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }
        
        .auth-form .field input:focus {
            border-color: #00CED1;
            box-shadow: 0 0 0 3px rgba(0, 206, 209, 0.12);
        }
        
        .auth-form .field input::placeholder {
            color: #9CA3AF;
        }
        
        .auth-form .field .hint {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 4px;
        }
        
        /* Password Field with Toggle */
        .auth-form .field-password {
            position: relative;
        }
        
        .auth-form .field-password input {
            padding-right: 44px;
        }
        
        .auth-form .field-password .toggle-pw {
            position: absolute;
            right: 12px;
            bottom: 12px;
            background: none;
            border: none;
            cursor: pointer;
            color: #9CA3AF;
            padding: 0;
            line-height: 1;
        }
        
        .auth-form .field-password .toggle-pw:hover {
            color: #e2e8f0;
        }
        
        /* Gender Radio Group */
        .auth-form .gender-options {
            display: flex;
            gap: 24px;
            margin-top: 6px;
        }
        
        .auth-form .gender-options label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 400;
            color: #e2e8f0;
        }
        
        .auth-form .gender-options input[type="radio"] {
            width: 18px;
            height: 18px;
            accent-color: #00CED1;
            margin: 0;
        }
        
        /* Checkbox */
        .auth-form .checkbox-field {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin: 20px 0;
        }
        
        .auth-form .checkbox-field input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #00CED1;
            margin-top: 2px;
            flex-shrink: 0;
        }
        
        .auth-form .checkbox-field span {
            font-size: 0.85rem;
            color: #cbd5e1;
            line-height: 1.4;
        }
        
        .auth-form .checkbox-field a {
            color: #00CED1;
            text-decoration: none;
            font-weight: 500;
        }
        
        .auth-form .checkbox-field a:hover {
            text-decoration: underline;
        }
        
        /* Form Actions Row */
        .auth-form .actions-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 0.85rem;
        }
        
        .auth-form .actions-row label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #cbd5e1;
            cursor: pointer;
        }
        
        .auth-form .actions-row input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #00CED1;
        }
        
        .auth-form .actions-row button {
            background: none;
            border: none;
            color: #00CED1;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .auth-form .actions-row button:hover {
            text-decoration: underline;
        }
        
        /* Submit Button */
        .auth-form .submit-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 14px 20px;
            background: #00CED1;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .auth-form .submit-btn:hover {
            background: #00ACC1;
        }
        
        /* Form Footer */
        .auth-form-footer {
            text-align: center;
            margin-top: 24px;
            font-size: 0.85rem;
            color: #94a3b8;
        }
        
        .auth-form-footer button {
            background: none;
            border: none;
            color: #00CED1;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .auth-form-footer button:hover {
            text-decoration: underline;
        }
        
        .auth-form-footer .back-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #e2e8f0;
            margin-top: 8px;
        }
        
        .auth-form-footer .back-link:hover {
            color: #00CED1;
        }
        
        /* ===== MOBILE RESPONSIVE ===== */
        @media (max-width: 900px) {
            .auth-page {
                flex-direction: column;
            }
            
            .auth-brand {
                width: 100%;
                padding: 32px 24px;
            }
            
            .auth-brand-logo {
                margin-bottom: 24px;
            }
            
            .auth-brand h1 {
                font-size: 1.6rem;
            }
            
            .auth-brand p {
                font-size: 0.9rem;
            }
            
            .auth-form-panel {
                width: 100%;
                padding: 32px 24px;
            }
            
            .auth-form-container {
                max-width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .auth-brand {
                padding: 24px 20px;
            }
            
            .auth-brand h1 {
                font-size: 1.4rem;
            }
            
            .auth-form-panel {
                padding: 24px 20px;
            }
            
            .auth-form-header h2 {
                font-size: 1.4rem;
            }
            
            .auth-form .gender-options {
                gap: 16px;
            }
            
            .auth-form .actions-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
        }

        /* General Button Styles */
        .btn {
            width: 100%;
            padding: 14px;
            background: #00CED1;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #00ACC1;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            border-bottom: 1px solid rgba(0,206,209,0.2);
            color: white;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        .header h1 {
            font-size: 24px;
            color: #ffffff;
        }

        .menu-btn {
            background: none;
            border: none;
            color: #ffffff;
            cursor: pointer;
            font-size: 24px;
        }

        .back-btn {
            background: none;
            border: none;
            color: #ffffff;
            cursor: pointer;
            font-size: 24px;
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #00CED1 100%);
            padding: 50px 24px;
            border-radius: 0 0 30px 30px;
            box-shadow: 0 10px 30px rgba(0, 206, 209, 0.3);
            position: relative;
            overflow: hidden;
            border-bottom: 3px solid #00CED1;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
            animation: pulse 15s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(-10%, -10%) scale(1.1); }
        }

        .hero h2 {
            font-size: 42px;
            font-weight: 800;
            color: #ffffff;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 4px 10px rgba(0, 206, 209, 0.8);
            position: relative;
            z-index: 1;
            animation: fadeInDown 0.8s ease-out;
            background: linear-gradient(135deg, #ffffff 0%, #00CED1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hero p {
            color: rgba(255, 255, 255, 0.85);
            line-height: 1.7;
            font-size: 15px;
            position: relative;
            z-index: 1;
            max-width: 100%;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Section */
        .section {
            padding: 20px;
        }

        .section-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 16px;
            color: #ffffff;
        }

        /* Menu Cards */
        .menu-grid {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding-bottom: 16px;
        }

        .menu-grid::-webkit-scrollbar {
            display: none;
        }

        .menu-card {
            min-width: 140px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid rgba(0,206,209,0.3);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .menu-card:hover {
            background: linear-gradient(135deg, #334155 0%, #475569 100%);
            border-color: rgba(0, 206, 209, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 206, 209, 0.3);
        }

        .menu-card:hover .menu-card-text {
            color: #ffffff;
        }

        .menu-card-icon {
            font-size: 36px;
            margin-bottom: 8px;
        }

        .menu-card-text {
            color: #00CED1;
            font-weight: 600;
            transition: color 0.3s;
        }

        /* VIP Cards */
        .vip-scroll {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding-bottom: 16px;
        }

        .vip-scroll::-webkit-scrollbar {
            display: none;
        }

        .vip-card {
            min-width: 320px;
            background: #1e293b;
            border: 2px solid #d4af37;
            border-radius: 24px;
            padding: 24px;
            color: #d4af37;
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.15);
        }

        .vip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .vip-level {
            font-size: 28px;
            font-weight: bold;
            color: #d4af37;
        }

        .vip-icon {
            font-size: 48px;
        }

        .vip-detail {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 14px;
            color: #d4af37;
        }

        /* Reviews Section */
        .reviews-section {
            margin-top: 20px;
        }

        .reviews-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .review-card {
            background: #1e293b;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        .review-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .review-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .review-info {
            flex: 1;
        }

        .review-name {
            font-weight: 600;
            font-size: 16px;
            color: #ffffff;
            margin-bottom: 4px;
        }

        .review-stars {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .review-stars .stars {
            font-size: 18px;
            line-height: 1;
        }
        .review-stars .stars.level-1 {
            color: #808080; /* Grey */
        }
        .review-stars .stars.level-2 {
            color: #c0c0c0; /* Silver */
        }
        .review-stars .stars.level-3 {
            color: #b08d57; /* Bronze */
        }
        .review-stars .stars.level-4 {
            color: #10b981; /* Emerald Green */
        }
        .review-stars .stars.level-5 {
            color: #ffd700; /* Gold */
        }

        .review-stars .rating-number {
            color: #94a3b8;
            font-size: 14px;
            font-weight: 600;
        }

        .review-comment {
            color: #cbd5e1;
            font-size: 14px;
            line-height: 1.6;
            margin-top: 8px;
        }

        /* Profile Card */
        .profile-card {
            background: #1e293b;
            border-radius: 24px;
            padding: 24px;
            color: #ffffff;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            background: #1e293b;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        .profile-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin-left: auto;
        }

        /* Wallet Cards */
        .wallet-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 2px solid #00CED1;
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .wallet-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #00BFFF 0%, #00CED1 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0, 206, 209, 0.3);
        }

        .wallet-info {
            flex: 1;
        }

        .wallet-label {
            color: #94a3b8;
            font-size: 14px;
        }

        .wallet-amount {
            font-size: 24px;
            font-weight: bold;
            color: #ffffff;
        }

        /* Optimization Grid */
        .opt-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .opt-cell {
            aspect-ratio: 1;
            background: #1e293b;
            border: 1px solid rgba(0,206,209,0.3);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
        }

        .opt-cell.center {
            background: linear-gradient(135deg, #00BFFF 0%, #00CED1 100%);
            border: 2px solid #00CED1;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 206, 209, 0.3);
        }

        /* Task Card */
        .task-card {
            background: #1e293b;
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 16px;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .task-status {
            background: linear-gradient(135deg, #00BFFF 0%, #00CED1 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 206, 209, 0.3);
        }

        .task-app {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }

        .task-app-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 2px solid #00CED1;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            box-shadow: 0 4px 12px rgba(0, 191, 255, 0.3);
        }

        .task-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            padding: 16px 0;
            border-top: 1px solid #334155;
            border-bottom: 1px solid #334155;
            margin-bottom: 16px;
        }

        .task-stat {
            text-align: center;
        }

        .task-stat-label {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 4px;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-top: 1px solid rgba(255,255,255,0.1);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 16px;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.3);
        }

        .nav-btn {
            background: none;
            border: none;
            color: #ffffff;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: color 0.3s;
        }

        .nav-btn:hover {
            color: #00CED1;
        }

        .nav-btn-center {
            background: linear-gradient(135deg, #00CED1 0%, #00ACC1 100%);
            border-radius: 50%;
            padding: 24px;
            margin-top: -40px;
            border: 2px solid rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            box-shadow: 0 4px 12px rgba(0, 206, 209, 0.4);
        }

        /* Side Menu */
        .side-menu-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 200;
        }

        .side-menu {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 300px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-left: 1px solid rgba(255,255,255,0.1);
            padding: 24px;
            z-index: 201;
            overflow-y: auto;
            max-height: 100vh;
            overscroll-behavior: contain;
        }

        .side-menu h3 {
            font-size: 24px;
            margin-bottom: 24px;
            color: #ffffff;
            font-weight: bold;
        }

        .side-menu button {
            width: 100%;
            text-align: left;
            padding: 16px 20px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            border-radius: 12px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 600;
            color: #00CED1;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .side-menu button:hover {
            background: linear-gradient(135deg, #00CED1 0%, #00ACC1 100%);
            color: white;
            transform: translateX(-4px);
            box-shadow: 0 4px 12px rgba(0, 206, 209, 0.3);
        }

        .side-menu button:active {
            transform: translateX(-2px);
            box-shadow: 0 2px 6px rgba(0, 206, 209, 0.2);
        }

        /* List Items */
        .list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.05);
            margin-bottom: 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .list-item:hover {
            background: rgba(0,0,0,0.4);
            border-color: rgba(0, 206, 209, 0.3);
        }

        .list-item-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .white-box {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 16px;
            color: #ffffff;
        }

        .content-box {
            padding: 24px;
            padding-bottom: 100px;
            background: transparent;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px 12px 0 0;
            cursor: pointer;
            font-weight: 600;
            color: #9ca3af;
        }

        .tab.active {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-bottom: 3px solid #00CED1;
            color: #00CED1;
        }

        .tab.inactive {
            background: rgba(0,0,0,0.2);
            color: #94a3b8;
        }

        .input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .input-group input {
            flex: 1;
        }

        .input-group button {
            padding: 12px 24px;
        }

        .credit-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            margin: 8px 0;
        }

        .credit-fill {
            height: 100%;
            background: #fbbf24;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .view-more {
            color: #00CED1;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .page {
            min-height: 100vh;
            padding-bottom: 80px;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        .notice-box {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 16px;
        }

        .notice-box p {
            color: #9ca3af;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .notice-date {
            color: #94a3b8;
            font-size: 14px;
        }

        .text-center {
            text-align: center;
        }

        .text-muted {
            color: #9ca3af;
            padding: 32px;
        }

        .password-input {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 12px;
            background: none;
            border: none;
            cursor: pointer;
        }

        .list-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: #334155;
        }

        /* Negative Balance Modal */
        .error-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
        }

        .error-modal {
            background: #1e293b;
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
            padding: 0;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease forwards;
        }
        
        /* Prevent animation restart on re-render */
        .error-modal.modal-shown {
            animation: none;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .error-modal-header {
            background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
            padding: 24px;
            border-radius: 20px 20px 0 0;
            text-align: center;
        }

        .error-modal-icon {
            font-size: 64px;
            margin-bottom: 12px;
        }

        .error-modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #dc2626;
            margin-bottom: 8px;
        }

        .error-modal-body {
            padding: 24px;
        }

        .error-modal-message {
            color: #cbd5e1;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .error-modal-balance {
            background: #334155;
            border: 2px solid #7f1d1d;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            text-align: center;
        }

        .error-modal-balance-label {
            color: #9ca3af;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .error-modal-balance-amount {
            color: #dc2626;
            font-size: 28px;
            font-weight: bold;
        }

        .error-modal-buttons {
            display: flex;
            gap: 12px;
        }

        .error-modal-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .error-modal-btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .error-modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .error-modal-btn-secondary {
            background: #1e293b;
            color: #94a3b8;
        }

        .error-modal-btn-secondary:hover {
            background: #334155;
        }

        /* Chat Widget Styles */
        .chat-button {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #00CED1 0%, #00ACC1 100%);
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 206, 209, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s;
        }

        .chat-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 206, 209, 0.6);
        }

        .chat-button-icon {
            font-size: 28px;
        }

        .chat-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }

        .chat-widget {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 360px;
            height: 500px;
            background: #1e293b;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            z-index: 1001;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #00CED1 0%, #00ACC1 100%);
            color: white;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header-title {
            font-size: 18px;
            font-weight: 600;
        }

        .chat-close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background: #1e293b;
        }

        .chat-message {
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
        }

        .chat-message-user {
            align-items: flex-end;
        }

        .chat-message-admin {
            align-items: flex-start;
        }

        .chat-message-bubble {
            max-width: 70%;
            padding: 10px 14px;
            border-radius: 12px;
            word-wrap: break-word;
        }

        .chat-message-user .chat-message-bubble {
            background: linear-gradient(135deg, #00CED1 0%, #00ACC1 100%);
            color: white;
        }

        .chat-message-admin .chat-message-bubble {
            background: #1e293b;
            color: #ffffff;
            border: 1px solid #334155;
        }

        .chat-message-time {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 4px;
        }

        .chat-input-container {
            padding: 16px;
            background: #1e293b;
            border-top: 1px solid #334155;
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #334155;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            background: #0f172a;
            color: #e2e8f0;
        }

        .chat-input:focus {
            border-color: #00CED1;
        }

        .chat-send-btn {
            background: linear-gradient(135deg, #00CED1 0%, #00ACC1 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .chat-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 206, 209, 0.4);
        }

        .chat-empty {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }

        @media (max-width: 480px) {
            .chat-widget {
                width: calc(100% - 40px);
                height: 70vh;
                bottom: 70px;
                right: 20px;
            }
        }

        /* Support Options Modal */
        .support-options-overlay {
            position: fixed;
            bottom: 150px;
            right: 20px;
            z-index: 1002;
        }

        .support-options-menu {
            background: #1e293b;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            min-width: 250px;
        }

        .support-option {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid #334155;
        }

        .support-option:last-child {
            border-bottom: none;
        }

        .support-option:hover {
            background: #334155;
        }

        .support-option-icon {
            font-size: 24px;
        }

        .support-option-content {
            flex: 1;
        }

        .support-option-title {
            font-size: 15px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 2px;
        }

        .support-option-desc {
            font-size: 12px;
            color: #94a3b8;
        }

        /* Full Page Chat */
        .chat-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1e293b;
            z-index: 2000;
            display: flex;
            flex-direction: column;
        }

        .chat-page-header {
            background: linear-gradient(135deg, #00CED1 0%, #00ACC1 100%);
            color: white;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        .chat-back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-page-title {
            flex: 1;
            font-size: 18px;
            font-weight: 600;
        }

        .chat-page-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-page-message {
            display: flex;
            flex-direction: column;
            max-width: 75%;
        }

        .chat-page-message.user {
            align-self: flex-end;
            align-items: flex-end;
        }

        .chat-page-message.admin {
            align-self: flex-start;
            align-items: flex-start;
        }

        .chat-page-bubble {
            padding: 12px 16px;
            border-radius: 16px;
            word-wrap: break-word;
        }

        .chat-page-message.user .chat-page-bubble {
            background: linear-gradient(135deg, #00CED1 0%, #00ACC1 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-page-message.admin .chat-page-bubble {
            background: #1e293b;
            color: #ffffff;
            border: 1px solid #334155;
            border-bottom-left-radius: 4px;
        }

        .chat-page-image {
            max-width: 250px;
            border-radius: 12px;
            margin-top: 8px;
            cursor: pointer;
        }

        .chat-page-time {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 4px;
            padding: 0 4px;
        }

        .chat-page-input-area {
            background: #1e293b;
            padding: 12px 16px;
            border-top: 1px solid #334155;
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .chat-page-input-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chat-page-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #334155;
            border-radius: 24px;
            font-size: 15px;
            outline: none;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            font-family: inherit;
            background: #0f172a;
            color: #e2e8f0;
        }

        .chat-page-input:focus {
            border-color: #00CED1;
        }

        .chat-page-actions {
            display: flex;
            gap: 8px;
        }

        .chat-image-btn, .chat-send-page-btn {
            background: linear-gradient(135deg, #00CED1 0%, #00ACC1 100%);
            border: none;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .chat-image-btn:hover, .chat-send-page-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 206, 209, 0.4);
        }

        .chat-image-preview {
            position: relative;
            display: inline-block;
            margin-top: 8px;
        }

        .chat-image-preview img {
            max-width: 150px;
            max-height: 150px;
            border-radius: 8px;
            border: 2px solid #475569;
        }

        .chat-image-remove {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .chat-empty-page {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            padding: 40px;
        }

        .chat-empty-page-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .chat-welcome-message {
            padding: 20px;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div id="app">Loading...</div>

    <!-- Include API -->
    <script src="js/api.js"></script>

    <script>
        
        // Check if API functions are loaded
        if (typeof authAPI === 'undefined' || typeof userAPI === 'undefined') {
        } else {
        }

        // App State
        const state = {
            currentPage: 'login',
            user: null,
            dashboard: null,
            menuOpen: false,
            optimizationCount: 1,
            currentAppIndex: 0,
            showPassword: false,
            currentPopup: null,
            popupPollTimer: null,
            assignedProducts: [],
            showingProducts: false,
            loadingProducts: false,
            history: [],
            levelProgress: {},
            completedToday: 0,
            showNegativeBalanceModal: false,
            showNegativeBalanceTriggeredModal: false,
            negativeBalanceTriggerInfo: null,
            showSetCompleteModal: false,
            showTermsModal: false,
            tasksCompletedToday: 0,
            currentSet: 1,
            supportOptionsOpen: false,
            chatMessages: [],
            chatUnreadCount: 0,
            chatPollTimer: null,
            chatImageFile: null,
            chatImagePreview: null,
            showChatWelcome: true, // Always show welcome on new chat session
            productImages: [],
            withdrawalHistory: [],
            withdrawTab: 'withdraw',
            depositHistory: [],
            depositTab: 'deposit',
            notifications: [],
            toasts: [],
            events: [],
            taskLimits: { total: 80, perSet: 40 }, // Will be updated based on user level
            currentLanguage: localStorage.getItem('selectedLanguage') || 'English',
            showRegistrationBonusModal: false,
            registrationBonusShown: false,
            showGlobalPopupModal: false,
            globalPopup: null,
            globalPopupChecked: false,
            // Individual popup (vouchers sent to specific user)
            showIndividualPopup: false,
            individualPopup: null,
            individualPopupChecked: false
        };

        // Translations object for multi-language support
        const translations = {
            English: {
                // Menu items
                menu: 'Menu',
                services: 'Services',
                terms: 'Terms & Conditions',
                events: 'Events',
                withdraw: 'Withdraw',
                deposit: 'Deposit',
                myCenter: 'My Center',
                home: 'Home',
                languages: 'Languages',
                support: 'Support',
                logout: 'Logout',
                
                // Login page
                welcomeBack: 'Welcome Back',
                username: 'Username',
                password: 'Password',
                login: 'Login',
                forgotPassword: 'Forgot Password?',
                contactSupport: ' Contact Support',
                dontHaveAccount: "Don't have an account?",
                signUp: 'Sign Up',
                
                // Home page
                whyUs: 'why us',
                whyUsDescription: 'more of your website traffic without relying on cookies, Orion Music can unlock a new top revenue channel for you. We\'ll scale your highest-converting, one-to-one marketing messages through emails, text messages, and ads.',
                menuList: 'Menu List',
                service: 'Service',
                termsShort: 'Terms',
                eventsShort: 'Events',
                contactUs: 'Contact Us',
                inviteFriends: 'Invite',
                employeeLevel: 'Employee Level',
                viewMore: 'View More ',
                userReviews: 'User Reviews',
                orionMusic: 'Orion Music',
                
                // VIP levels
                profitOf: 'Profit of',
                ratings: 'ratings',
                sets: 'sets',
                access: 'access',
                
                // Optimization/Dashboard page
                hiUser: 'Hi,',
                walletBalance: 'Wallet Balance',
                depositRequired: 'Deposit required to continue',
                profitsAdded: 'Profits will be added here',
                commission: 'Commission',
                commissionEarned: 'Commission Earned',
                pressStart: 'Press Start to Submit',
                set: 'Set',
                usd: 'USD',
                
                // Bottom navigation
                home: 'HOME',
                starting: 'Starting',
                orionMusic: 'Orion Music',
                records: 'Records'
            },
            Espanol: {
                // Menu items
                menu: 'Men',
                services: 'Servicios',
                terms: 'Trminos y Condiciones',
                events: 'Eventos',
                withdraw: 'Retirar',
                deposit: 'Depositar',
                myCenter: 'Mi Centro',
                home: 'Inicio',
                languages: 'Idiomas',
                support: 'Soporte',
                logout: 'Cerrar Sesin',
                
                // Login page
                welcomeBack: 'Bienvenido de Vuelta',
                username: 'Usuario',
                password: 'Contrasea',
                login: 'Iniciar Sesin',
                forgotPassword: 'Olvidaste tu Contrasea?',
                contactSupport: ' Contactar Soporte',
                dontHaveAccount: 'No tienes cuenta?',
                signUp: 'Registrarse',
                
                // Home page
                whyUs: 'por qu nosotros',
                whyUsDescription: 'ms trfico a tu sitio web sin depender de cookies, Orion Music puede desbloquear un nuevo canal de ingresos superior para ti. Escalaremos tus mensajes de marketing uno a uno de mayor conversin a travs de correos electrnicos, mensajes de texto y anuncios.',
                menuList: 'Lista de Men',
                service: 'Servicio',
                termsShort: 'Trminos',
                eventsShort: 'Eventos',
                contactUs: 'Contctenos',
                inviteFriends: 'Invitar',
                employeeLevel: 'Nivel de Empleado',
                viewMore: 'Ver Ms ',
                userReviews: 'Reseas de Usuarios',
                orionMusic: 'Orion Music',
                
                // VIP levels
                profitOf: 'Ganancia de',
                ratings: 'calificaciones',
                sets: 'conjuntos',
                access: 'acceso',
                
                // Optimization/Dashboard page
                hiUser: 'Hola,',
                walletBalance: 'Saldo de Billetera',
                depositRequired: 'Se requiere depsito para continuar',
                profitsAdded: 'Las ganancias se agregarn aqu',
                commission: 'Comisin',
                commissionEarned: 'Comisin Ganada',
                pressStart: 'Presiona Iniciar para Enviar',
                set: 'Conjunto',
                usd: 'USD',
                
                // Bottom navigation
                home: 'INICIO',
                starting: 'Iniciando',
                orionMusic: 'Orion Music',
                records: 'Registros'
            },
            Francais: {
                // Menu items
                menu: 'Menu',
                services: 'Services',
                terms: 'Termes et Conditions',
                events: 'vnements',
                withdraw: 'Retirer',
                deposit: 'Dposer',
                myCenter: 'Mon Centre',
                home: 'Accueil',
                languages: 'Langues',
                support: 'Support',
                logout: 'Dconnexion',
                
                // Login page
                welcomeBack: 'Bienvenue',
                username: 'Nom d\'utilisateur',
                password: 'Mot de passe',
                login: 'Se connecter',
                forgotPassword: 'Mot de passe oubli?',
                contactSupport: ' Contacter le Support',
                dontHaveAccount: 'Pas de compte?',
                signUp: 'S\'inscrire',
                
                // Home page
                whyUs: 'pourquoi nous',
                whyUsDescription: 'plus de trafic sur votre site web sans dpendre des cookies, Orion Music peut dbloquer un nouveau canal de revenus suprieur pour vous. Nous mettrons  l\'chelle vos messages marketing individuels les plus performants via emails, SMS et publicits.',
                menuList: 'Liste de Menu',
                service: 'Service',
                termsShort: 'Termes',
                eventsShort: 'vnements',
                contactUs: 'Nous Contacter',
                inviteFriends: 'Inviter',
                employeeLevel: 'Niveau Employ',
                viewMore: 'Voir Plus ',
                userReviews: 'Avis Utilisateurs',
                orionMusic: 'Orion Music',
                
                // VIP levels
                profitOf: 'Profit de',
                ratings: 'valuations',
                sets: 'ensembles',
                access: 'accs',
                
                // Optimization/Dashboard page
                hiUser: 'Salut,',
                walletBalance: 'Solde du Portefeuille',
                depositRequired: 'Dpt requis pour continuer',
                profitsAdded: 'Les profits seront ajouts ici',
                commission: 'Commission',
                commissionEarned: 'Commission Gagne',
                pressStart: 'Appuyez sur Dmarrer pour Soumettre',
                set: 'Ensemble',
                usd: 'USD',
                
                // Bottom navigation
                home: 'ACCUEIL',
                starting: 'Dmarrage',
                orionMusic: 'Orion Music',
                records: 'Archives'
            },
            Svenska: {
                // Menu items
                menu: 'Meny',
                services: 'Tjnster',
                terms: 'Villkor',
                events: 'Evenemang',
                withdraw: 'Ta ut',
                deposit: 'Insttning',
                myCenter: 'Mitt Center',
                home: 'Hem',
                languages: 'Sprk',
                support: 'Support',
                logout: 'Logga ut',
                
                // Login page
                welcomeBack: 'Vlkommen Tillbaka',
                username: 'Anvndarnamn',
                password: 'Lsenord',
                login: 'Logga in',
                forgotPassword: 'Glmt lsenord?',
                contactSupport: ' Kontakta Support',
                dontHaveAccount: 'Inget konto?',
                signUp: 'Registrera',
                
                // Home page
                whyUs: 'varfr oss',
                whyUsDescription: 'mer trafik till din webbplats utan att frlita dig p cookies, Orion Music kan lsa upp en ny toppintktskanal fr dig. Vi skalar dina hgst konverterande individuella marknadsfringsmeddelanden genom e-post, textmeddelanden och annonser.',
                menuList: 'Menylista',
                service: 'Tjnst',
                termsShort: 'Villkor',
                eventsShort: 'Evenemang',
                contactUs: 'Kontakta Oss',
                inviteFriends: 'Bjuda in',
                employeeLevel: 'Anstlldsniv',
                viewMore: 'Se Mer ',
                userReviews: 'Anvndarrecensioner',
                orionMusic: 'Orion Music',
                
                // VIP levels
                profitOf: 'Vinst av',
                ratings: 'betyg',
                sets: 'set',
                access: 'tkomst',
                
                // Optimization/Dashboard page
                hiUser: 'Hej,',
                walletBalance: 'Plnboksbalans',
                depositRequired: 'Insttning krvs fr att fortstta',
                profitsAdded: 'Vinster kommer att lggas till hr',
                commission: 'Provision',
                commissionEarned: 'Intjnad Provision',
                pressStart: 'Tryck Start fr att Skicka',
                set: 'Set',
                usd: 'USD',
                
                // Bottom navigation
                home: 'HEM',
                starting: 'Startar',
                orionMusic: 'Orion Music',
                records: 'Poster'
            },
            Italiano: {
                // Menu items
                menu: 'Menu',
                services: 'Servizi',
                terms: 'Termini e Condizioni',
                events: 'Eventi',
                withdraw: 'Preleva',
                deposit: 'Deposita',
                myCenter: 'Il Mio Centro',
                home: 'Home',
                languages: 'Lingue',
                support: 'Supporto',
                logout: 'Disconnetti',
                
                // Login page
                welcomeBack: 'Bentornato',
                username: 'Nome utente',
                password: 'Password',
                login: 'Accedi',
                forgotPassword: 'Password dimenticata?',
                contactSupport: ' Contatta Supporto',
                dontHaveAccount: 'Non hai un account?',
                signUp: 'Registrati',
                
                // Home page
                whyUs: 'perch noi',
                whyUsDescription: 'pi traffico al tuo sito web senza affidarti ai cookie, Orion Music pu sbloccare un nuovo canale di entrate superiore per te. Scaleremo i tuoi messaggi di marketing uno-a-uno pi performanti attraverso email, messaggi di testo e annunci.',
                menuList: 'Lista Menu',
                service: 'Servizio',
                termsShort: 'Termini',
                eventsShort: 'Eventi',
                contactUs: 'Contattaci',
                inviteFriends: 'Invita',
                employeeLevel: 'Livello Dipendente',
                viewMore: 'Vedi Altro ',
                userReviews: 'Recensioni Utenti',
                orionMusic: 'Orion Music',
                
                // VIP levels
                profitOf: 'Profitto di',
                ratings: 'valutazioni',
                sets: 'set',
                access: 'accesso',
                
                // Optimization/Dashboard page
                hiUser: 'Ciao,',
                walletBalance: 'Saldo Portafoglio',
                depositRequired: 'Deposito richiesto per continuare',
                profitsAdded: 'I profitti saranno aggiunti qui',
                commission: 'Commissione',
                commissionEarned: 'Commissione Guadagnata',
                pressStart: 'Premi Avvia per Inviare',
                set: 'Set',
                usd: 'USD',
                
                // Bottom navigation
                home: 'HOME',
                starting: 'Avvio',
                orionMusic: 'Orion Music',
                records: 'Record'
            },
            Deutsch: {
                // Menu items
                menu: 'Men',
                services: 'Dienstleistungen',
                terms: 'Allgemeine Geschftsbedingungen',
                events: 'Veranstaltungen',
                withdraw: 'Abheben',
                deposit: 'Einzahlen',
                myCenter: 'Mein Zentrum',
                home: 'Startseite',
                languages: 'Sprachen',
                support: 'Support',
                logout: 'Abmelden',
                
                // Login page
                welcomeBack: 'Willkommen zurck',
                username: 'Benutzername',
                password: 'Passwort',
                login: 'Anmelden',
                forgotPassword: 'Passwort vergessen?',
                contactSupport: ' Support kontaktieren',
                dontHaveAccount: 'Kein Konto?',
                signUp: 'Registrieren',
                
                // Home page
                whyUs: 'warum wir',
                whyUsDescription: 'mehr Traffic auf Ihrer Website ohne Abhngigkeit von Cookies, Orion Music kann einen neuen Top-Einnahmekanal fr Sie freischalten. Wir skalieren Ihre hchstkonvertierenden One-to-One-Marketing-Nachrichten ber E-Mails, Textnachrichten und Anzeigen.',
                menuList: 'Menliste',
                service: 'Service',
                termsShort: 'Bedingungen',
                eventsShort: 'Veranstaltungen',
                contactUs: 'Kontakt',
                inviteFriends: 'Einladen',
                employeeLevel: 'Mitarbeiterebene',
                viewMore: 'Mehr anzeigen ',
                userReviews: 'Benutzerbewertungen',
                orionMusic: 'Orion Music',
                
                // VIP levels
                profitOf: 'Gewinn von',
                ratings: 'Bewertungen',
                sets: 'Sets',
                access: 'Zugang',
                
                // Optimization/Dashboard page
                hiUser: 'Hallo,',
                walletBalance: 'Wallet-Guthaben',
                depositRequired: 'Einzahlung erforderlich um fortzufahren',
                profitsAdded: 'Gewinne werden hier hinzugefgt',
                commission: 'Provision',
                commissionEarned: 'Verdiente Provision',
                pressStart: 'Drcke Start zum bermitteln',
                set: 'Set',
                usd: 'USD',
                
                // Bottom navigation
                home: 'STARTSEITE',
                starting: 'Startet',
                orionMusic: 'Orion Music',
                records: 'Aufzeichnungen'
            },
            Nork: {
                // Menu items
                menu: 'Meny',
                services: 'Tjenester',
                terms: 'Vilkr og betingelser',
                events: 'Arrangementer',
                withdraw: 'Ta ut',
                deposit: 'Innskudd',
                myCenter: 'Mitt senter',
                home: 'Hjem',
                languages: 'Sprk',
                support: 'Sttte',
                logout: 'Logg ut',
                
                // Login page
                welcomeBack: 'Velkommen tilbake',
                username: 'Brukernavn',
                password: 'Passord',
                login: 'Logg inn',
                forgotPassword: 'Glemt passord?',
                contactSupport: ' Kontakt sttte',
                dontHaveAccount: 'Ingen konto?',
                signUp: 'Registrer',
                
                // Home page
                whyUs: 'hvorfor oss',
                whyUsDescription: 'mer trafikk til nettstedet ditt uten  stole p informasjonskapsler, Orion Music kan lse opp en ny toppinntektskilde for deg. Vi skalerer dine hyest konverterende en-til-en markedsfringsmeldinger gjennom e-post, tekstmeldinger og annonser.',
                menuList: 'Menyliste',
                service: 'Tjeneste',
                termsShort: 'Vilkr',
                eventsShort: 'Arrangementer',
                contactUs: 'Kontakt Oss',
                inviteFriends: 'Inviter',
                employeeLevel: 'Ansattniv',
                viewMore: 'Se mer ',
                userReviews: 'Brukeranmeldelser',
                orionMusic: 'Orion Music',
                
                // VIP levels
                profitOf: 'Fortjeneste av',
                ratings: 'vurderinger',
                sets: 'sett',
                access: 'tilgang',
                
                // Optimization/Dashboard page
                hiUser: 'Hei,',
                walletBalance: 'Lommebokbalanse',
                depositRequired: 'Innskudd kreves for  fortsette',
                profitsAdded: 'Fortjeneste vil legges til her',
                commission: 'Provisjon',
                commissionEarned: 'Tjent Provisjon',
                pressStart: 'Trykk Start for  Sende',
                set: 'Sett',
                usd: 'USD',
                
                // Bottom navigation
                home: 'HJEM',
                starting: 'Starter',
                orionMusic: 'Orion Music',
                records: 'Opptegnelser'
            }
        };

        // Function to get translated text
        function t(key) {
            return translations[state.currentLanguage]?.[key] || translations.English[key] || key;
        }

        // Function to change language
        function changeLanguage(languageName) {
            state.currentLanguage = languageName;
            localStorage.setItem('selectedLanguage', languageName);
            state.languagesDropdownOpen = false; // Close dropdown after selection
            render(); // Re-render the UI with new language
        }

        // Level-based task limits configuration
        // Level 1: 80 tasks (2 sets of 40)
        // Level 2: 90 tasks (2 sets of 45)
        // Level 3: 100 tasks (2 sets of 50)
        // Level 4: 110 tasks (2 sets of 55)
        // Level 5: 120 tasks (2 sets of 60)
        function getTaskLimitsForLevel(level) {
            const limits = {
                1: { total: 80, perSet: 40 },
                2: { total: 90, perSet: 45 },
                3: { total: 100, perSet: 50 },
                4: { total: 110, perSet: 55 },
                5: { total: 120, perSet: 60 }
            };
            return limits[level] || limits[1];
        }

        // Beautiful Toast Notification System
        function showToast(message, type = 'info', duration = 3000) {
            const toastId = Date.now();
            const toast = { id: toastId, message, type };
            state.toasts.push(toast);
            renderToasts();
            
            setTimeout(() => {
                state.toasts = state.toasts.filter(t => t.id !== toastId);
                renderToasts();
            }, duration);
        }

        function renderToasts() {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10000; display: flex; flex-direction: column; gap: 12px; width: 90%; max-width: 400px;';
                document.body.appendChild(container);
            }
            
            container.innerHTML = state.toasts.map(toast => {
                const icons = { success: '', error: '', warning: '', info: '' };
                const colors = { 
                    success: 'linear-gradient(135deg, #10b981, #059669)', 
                    error: 'linear-gradient(135deg, #ef4444, #dc2626)', 
                    warning: 'linear-gradient(135deg, #f59e0b, #d97706)', 
                    info: 'linear-gradient(135deg, #3b82f6, #2563eb)' 
                };
                return `
                    <div style="background: ${colors[toast.type] || colors.info}; color: white; padding: 16px 20px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 12px; animation: slideDown 0.3s ease-out;">
                        <span style="font-size: 24px;">${icons[toast.type] || icons.info}</span>
                        <span style="font-size: 15px; font-weight: 500; flex: 1;">${toast.message}</span>
                    </div>
                `;
            }).join('');
        }

        // Beautiful Modal/Popup System
        function showModal(title, message, type = 'success', buttonText = 'OK', onClose = null) {
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'custom-modal-overlay';
            modalOverlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; animation: fadeIn 0.2s ease-out;';
            
            const icons = { 
                success: '<div style="width: 80px; height: 80px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 10px 30px rgba(16,185,129,0.3);"><span style="font-size: 40px;"></span></div>', 
                error: '<div style="width: 80px; height: 80px; background: linear-gradient(135deg, #ef4444, #dc2626); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 10px 30px rgba(239,68,68,0.3);"><span style="font-size: 40px;"></span></div>',
                warning: '<div style="width: 80px; height: 80px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 10px 30px rgba(245,158,11,0.3);"><span style="font-size: 40px;">!</span></div>',
                info: '<div style="width: 80px; height: 80px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 10px 30px rgba(59,130,246,0.3);"><span style="font-size: 40px;">i</span></div>'
            };
            
            const buttonColors = {
                success: 'linear-gradient(135deg, #10b981, #059669)',
                error: 'linear-gradient(135deg, #ef4444, #dc2626)',
                warning: 'linear-gradient(135deg, #f59e0b, #d97706)',
                info: 'linear-gradient(135deg, #3b82f6, #2563eb)'
            };
            
            modalOverlay.innerHTML = `
                <div style="background: #1e293b; border-radius: 24px; padding: 32px 24px; max-width: 340px; width: 100%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: scaleIn 0.3s ease-out;">
                    ${icons[type] || icons.info}
                    <h3 style="font-size: 22px; font-weight: 700; color: #ffffff; margin-bottom: 12px;">${title}</h3>
                    <p style="font-size: 15px; color: #94a3b8; line-height: 1.6; margin-bottom: 24px;">${message}</p>
                    <button onclick="closeCustomModal()" style="width: 100%; padding: 16px; background: ${buttonColors[type] || buttonColors.info}; color: white; border: none; border-radius: 14px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                        ${buttonText}
                    </button>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            
            // Store callback for close
            window._modalCloseCallback = onClose;
        }

        function closeCustomModal() {
            const modal = document.getElementById('custom-modal-overlay');
            if (modal) {
                modal.style.animation = 'fadeOut 0.2s ease-out';
                setTimeout(() => {
                    modal.remove();
                    if (window._modalCloseCallback) {
                        window._modalCloseCallback();
                        window._modalCloseCallback = null;
                    }
                }, 200);
            }
        }

        // Load product images for the grid
        async function loadProductImages() {
            try {
                const response = await fetch(`${API_BASE_URL}/products/images`);
                if (response.ok) {
                    state.productImages = await response.json();
                }
            } catch (error) {
            }
        }

        // Load withdrawal history
        async function loadWithdrawalHistory() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/user/withdrawals`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    state.withdrawalHistory = await response.json();
                    render();
                }
            } catch (error) {
            }
        }

        // Load deposit history
        async function loadDepositHistory() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/user/deposits`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    state.depositHistory = await response.json();
                    render();
                }
            } catch (error) {
            }
        }

        // Load user notifications
        async function loadNotifications() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/user/notifications`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    state.notifications = await response.json();
                    render();
                }
            } catch (error) {
            }
        }

        // Mark notification as read
        async function markNotificationRead(notificationId) {
            try {
                const token = localStorage.getItem('token');
                await fetch(`${API_BASE_URL}/user/notifications/${notificationId}/read`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                // Reload notifications
                loadNotifications();
            } catch (error) {
            }
        }

        // Load events for users
        async function loadEvents() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/events`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    state.events = await response.json();
                    render();
                }
            } catch (error) {
            }
        }

        // Copy invitation code to clipboard
        function copyInvitationCode(code) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(code).then(() => {
                    showToast('Invitation code copied!', 'success');
                }).catch(() => {
                    fallbackCopyText(code);
                });
            } else {
                fallbackCopyText(code);
            }
        }
        
        // Escape HTML to prevent XSS in chat messages
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function fallbackCopyText(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showToast('Invitation code copied!', 'success');
            } catch (err) {
                showToast('Failed to copy code', 'error');
            }
            document.body.removeChild(textarea);
        }
        
        // Safe date formatting helper
        function formatDateSafe(dateValue) {
            if (!dateValue) return 'N/A';
            
            try {
                let date;
                
                // Handle different date formats
                if (dateValue instanceof Date) {
                    date = dateValue;
                } else if (typeof dateValue === 'string') {
                    // Try parsing as ISO string first
                    date = new Date(dateValue);
                    
                    // If invalid, try parsing as MySQL date (YYYY-MM-DD)
                    if (isNaN(date.getTime())) {
                        // Try different formats
                        const parts = dateValue.split(/[-T: ]/);
                        if (parts.length >= 3) {
                            date = new Date(parts[0], parts[1] - 1, parts[2], parts[3] || 0, parts[4] || 0, parts[5] || 0);
                        }
                    }
                } else if (typeof dateValue === 'number') {
                    date = new Date(dateValue);
                }
                
                // Check if date is valid
                if (!date || isNaN(date.getTime())) {
                    return 'N/A';
                }
                
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            } catch (e) {
                return 'N/A';
            }
        }
        
        function formatTimeSafe(dateValue) {
            if (!dateValue) return '';
            
            try {
                let date;
                
                if (dateValue instanceof Date) {
                    date = dateValue;
                } else if (typeof dateValue === 'string') {
                    date = new Date(dateValue);
                    
                    if (isNaN(date.getTime())) {
                        const parts = dateValue.split(/[-T: ]/);
                        if (parts.length >= 3) {
                            date = new Date(parts[0], parts[1] - 1, parts[2], parts[3] || 0, parts[4] || 0, parts[5] || 0);
                        }
                    }
                } else if (typeof dateValue === 'number') {
                    date = new Date(dateValue);
                }
                
                if (!date || isNaN(date.getTime())) {
                    return '';
                }
                
                const now = new Date();
                const isToday = date.toDateString() === now.toDateString();
                
                if (isToday) {
                    return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                } else {
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' +
                           date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                }
            } catch (e) {
                return '';
            }
        }

        // Helper function to get VIP level name
        function getVipLevelName(level) {
            const levelNames = {
                1: 'Foundation',
                2: 'Growth',
                3: 'Advance',
                4: 'Pinnacle',
                5: 'Elite'
            };
            return levelNames[level] || `Level ${level}`;
        }

        const vipLevels = [
            {
                level: 'Foundation',
                icon: '',
                description: 'Suitable for most data capture scenarios involving light to medium usage',
                profit: '0.5% per album data',
                ratings: 'Up to 80 submissions per day',
                sets: 'One can perform a maximum of 2 sets in a single day',
                access: 'No access to other Premium features'
            },
            {
                level: 'Growth',
                icon: '',
                description: 'Suitable for most data capture scenarios involving light to medium usage',
                profit: '1% per task 45 tasks per set',
                ratings: 'Up to 90 optimise ratings per day',
                sets: 'One can perform a maximum of 2 sets of albums in a single day',
                access: 'No access to other Premium features'
            },
            {
                level: 'Advance',
                icon: '',
                description: 'Suitable for heavy data capture scenarios',
                profit: '1.5% per task 50 tasks per set',
                ratings: 'Up to 100 optimise ratings per day',
                sets: 'One can perform a maximum of 2 sets of album maintenance in a single day',
                access: 'Access to Premium features'
            },
            {
                level: 'Pinnacle',
                icon: '',
                description: 'Premium tier for professional usage',
                profit: '2% per task 55 tasks per set',
                ratings: 'Up to 110 optimise ratings per day',
                sets: 'One can perform a maximum of 2 sets of album maintenance in a single day',
                access: 'Full access to all Premium features'
            },
            {
                level: 'Elite',
                icon: '',
                description: 'Premium tier for professional usage',
                profit: '2.5% per task 60 tasks per set',
                ratings: 'Up to 120 optimise ratings per day',
                sets: 'One can perform a maximum of 2 sets of album maintenance in a single day',
                access: 'Full access to all Premium features'
            }
        ];

        const userReviews = [
            {
                name: 'Sarah Johnson',
                rating: 4.5,
                comment: 'At first I was really scared because I paid in crypto and the payment came late. The team explained everything clearly and supported me step by step. Now I\'ve fully mastered withdrawing my money straight to my bank without stress. Thanks a lot.',
                avatar: 'https://randomuser.me/api/portraits/women/44.jpg',
                level: 2
            },
            {
                name: 'Marcus Williams',
                rating: 4.8,
                comment: 'I really appreciate the fast response from customer service. Anytime I had issues or questions, they replied quickly and helped me to resolve it.',
                avatar: 'https://randomuser.me/api/portraits/men/32.jpg',
                level: 1
            },
            {
                name: 'Michael Chen',
                rating: 4.7,
                comment: 'The mentor assigned to me was extremely helpful. They explained things patiently and made sure I understood every step before moving forward.',
                avatar: 'https://randomuser.me/api/portraits/men/85.jpg',
                level: 3
            },
            {
                name: 'Tyrone Jackson',
                rating: 4.6,
                comment: 'The expert team is very helpful when it comes to questions. They take time to explain things clearly, even for beginners which made learning much easier.',
                avatar: 'https://randomuser.me/api/portraits/men/59.jpg',
                level: 2
            },
            {
                name: 'David Thompson',
                rating: 4.9,
                comment: 'Honestly, I thought it was a scam at first but after earning $7000 and successfully withdrawing it to my bank, I am truly grateful. This platform really surprised me.',
                avatar: 'https://randomuser.me/api/portraits/men/22.jpg',
                level: 4
            },
            {
                name: 'Derrick Brown',
                rating: 5.0,
                comment: 'Crypto really felt scary at first, but these guys make it easy to learn. Now I even use crypto for my normal daily payments. Big thanks to team.',
                avatar: 'https://randomuser.me/api/portraits/men/71.jpg',
                level: 1
            },
            {
                name: 'Kevin Mitchell',
                rating: 4.4,
                comment: 'The work itself can be a bit boring sometimes, but at least it\'s reliable and I actually get paid which matters the most to me.',
                avatar: 'https://randomuser.me/api/portraits/men/46.jpg',
                level: 3
            },
            {
                name: 'James Wilson',
                rating: 5.0,
                comment: 'I can\'t believe I earned 15k in my first month! This platform changed my life. Elite is where it\'s at!',
                avatar: 'https://randomuser.me/api/portraits/men/67.jpg',
                level: 5
            }
        ];

        // ===== SCROLL ANIMATIONS AND COUNTER EFFECTS =====
        
        // Counter animation function
        function animateCounter(element, target, suffix = '') {
            let current = 0;
            const increment = target / 60; // 60 frames for smooth animation
            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    current = target;
                    clearInterval(timer);
                }
                
                // Format number based on size
                let displayValue;
                if (target >= 1000) {
                    displayValue = (current / 1000).toFixed(1) + 'M+';
                } else if (target >= 50) {
                    displayValue = Math.floor(current) + 'K+';
                } else {
                    displayValue = Math.floor(current) + '+';
                }
                
                element.textContent = displayValue;
            }, 16); // ~60fps
        }

        // Intersection Observer for scroll animations
        let scrollObserver = null;
        
        function initScrollAnimations() {
            // Remove existing observer if any
            if (scrollObserver) {
                scrollObserver.disconnect();
            }
            
            // Create new observer
            scrollObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const element = entry.target;
                        const delay = parseInt(element.getAttribute('data-delay') || '0');
                        
                        // Add delay before animation
                        setTimeout(() => {
                            element.classList.add('animated', 'slide-up');
                            
                            // If element contains counters, animate them
                            const counters = element.querySelectorAll('.counter');
                            counters.forEach(counter => {
                                if (!counter.dataset.animated) {
                                    counter.dataset.animated = 'true';
                                    const target = parseInt(counter.dataset.target);
                                    animateCounter(counter, target);
                                }
                            });
                        }, delay);
                        
                        // Unobserve after animation to prevent re-triggering
                        scrollObserver.unobserve(element);
                    }
                });
            }, {
                threshold: 0.1, // Trigger when 10% of element is visible
                rootMargin: '0px 0px -50px 0px' // Start animation slightly before element enters viewport
            });
            
            // Observe all elements with animate-on-scroll class
            const animatedElements = document.querySelectorAll('.animate-on-scroll');
            animatedElements.forEach(el => {
                scrollObserver.observe(el);
            });
        }

        // Initialize animations after page render
        function initPageAnimations() {
            // Wait a bit for DOM to be fully ready
            setTimeout(() => {
                initScrollAnimations();
            }, 100);
        }

        // Initialize
        function init() {
            
            // Load product images for the grid (public endpoint)
            loadProductImages();
            
            try {
                const token = localStorage.getItem('token');
                const userData = localStorage.getItem('userData');
                
                if (token && userData) {
                    state.user = JSON.parse(userData);
                    state.currentPage = 'home';
                    loadDashboard();
                    loadWithdrawalHistory();
                    
                    // Start popup polling for logged-in users
                    checkForPopups();
                    if (state.popupPollTimer) clearInterval(state.popupPollTimer);
                    state.popupPollTimer = setInterval(checkForPopups, 15000); // Check every 15 seconds
                } else {
                }
                
                render();
            } catch (error) {
                document.getElementById('app').innerHTML = renderLogin();
            }
        }

        // Load Dashboard Data from Backend
        async function loadDashboard(silent = false) {
            try {
                const data = await userAPI.getDashboard();
                
                if (!data || !data.user) {
                    throw new Error('Invalid dashboard data');
                }
                
                state.dashboard = data;
                state.user = data.user;
                localStorage.setItem('userData', JSON.stringify(data.user));
                
                // Update current set and tasks from user data (set by admin)
                state.currentSet = data.user.current_set || 1;
                state.tasksCompletedToday = data.user.tasks_completed_today || 0;
                // Clear Set 1 completion modal if admin reset user to Set 2
                if (state.currentSet === 2 && state.showSetCompleteModal) {
                    state.showSetCompleteModal = false;
                }
                console.log('[DASHBOARD] Updated state - currentSet:', state.currentSet, 'tasksCompletedToday:', state.tasksCompletedToday);
                
                // Load history and level progress for records page
                try {
                    const [history, levelProgress] = await Promise.all([
                        userAPI.getHistory(),
                        userAPI.getLevelProgress()
                    ]);
                    state.history = history || [];
                    state.levelProgress = levelProgress || {};
                    state.completedToday = levelProgress.completedToday || 0;
                } catch (err) {
                }
                
                // Check if user needs to see registration bonus popup
                console.log('[DASHBOARD] Registration bonus check - registration_bonus_shown:', data.user.registration_bonus_shown, 'state.registrationBonusShown:', state.registrationBonusShown);
                if (!data.user.registration_bonus_shown && !state.registrationBonusShown) {
                    console.log('[DASHBOARD] Showing registration bonus popup!');
                    state.showRegistrationBonusModal = true;
                    state.registrationBonusShown = true; // Prevent showing again in this session
                }
                
                // Check for global popup (voucher for all users) - only check once per session
                if (!state.globalPopupChecked) {
                    state.globalPopupChecked = true;
                    checkGlobalPopup();
                }
                
                // Check for individual popup (voucher sent to this specific user) - only check once per session
                if (!state.individualPopupChecked) {
                    state.individualPopupChecked = true;
                    checkIndividualPopup();
                }
                
                // Only render if not silent (to prevent flickering when showing modals)
                if (!silent) {
                    render();
                }
            } catch (error) {
                if (error.message && (error.message.includes('token') || error.message.includes('401'))) {
                    logout();
                }
            }
        }

        // Navigation
        function navigateTo(page) {
            state.currentPage = page;
            state.menuOpen = false;
            
            // Refresh dashboard when navigating to main page (to get latest current_set)
            if (page === 'dashboard') {
                loadDashboard(true); // silent refresh to update set number
            }
            
            // Load notifications when navigating to notifications page
            if (page === 'notifications') {
                loadNotifications();
            }
            
            // Load events when navigating to events page
            if (page === 'userEvents') {
                loadEvents();
            }
            
            // Refresh history when navigating to records page
            if (page === 'records') {
                loadHistory();
            }
            
            render();
        }
        
        // Load history for records page
        async function loadHistory() {
            try {
                const history = await userAPI.getHistory();
                state.history = history || [];
                render();
            } catch (err) {
                // History load failed silently
            }
        }

        // Check for global popup (vouchers sent to all users)
        async function checkGlobalPopup() {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;
                
                const response = await fetch(`${API_BASE_URL}/user/global-popup`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.popup) {
                        state.globalPopup = data.popup;
                        state.showGlobalPopupModal = true;
                        render();
                    }
                }
            } catch (err) {
                console.log('Global popup check failed:', err);
            }
        }

        // Dismiss global popup
        async function dismissGlobalPopup() {
            try {
                const token = localStorage.getItem('token');
                if (!token || !state.globalPopup) return;
                
                const popupId = state.globalPopup.id;
                state.showGlobalPopupModal = false;
                state.globalPopup = null;
                render();
                
                // Mark as dismissed in backend
                await fetch(`${API_BASE_URL}/user/global-popup/${popupId}/dismiss`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
            } catch (err) {
                console.log('Dismiss global popup failed:', err);
            }
        }

        // Check for individual popup (vouchers sent to specific user)
        async function checkIndividualPopup() {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;
                
                const response = await fetch(`${API_BASE_URL}/user/popups`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (response.ok) {
                    const popups = await response.json();
                    if (popups && popups.length > 0) {
                        state.individualPopup = popups[0]; // Show first pending popup
                        state.showIndividualPopup = true;
                        render();
                    }
                }
            } catch (err) {
                console.log('Individual popup check failed:', err);
            }
        }

        // Dismiss individual popup
        async function dismissIndividualPopup() {
            try {
                const token = localStorage.getItem('token');
                if (!token || !state.individualPopup) return;
                
                const popupId = state.individualPopup.id;
                state.showIndividualPopup = false;
                state.individualPopup = null;
                render();
                
                // Mark as dismissed/clicked in backend
                await fetch(`${API_BASE_URL}/user/popup/${popupId}/dismiss`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
            } catch (err) {
                console.log('Dismiss individual popup failed:', err);
            }
        }

        function toggleMenu() {
            state.menuOpen = !state.menuOpen;
            render();
        }

        // Login Handler
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showToast('Please enter username and password', 'warning');
                return;
            }
            
            try {
                const result = await authAPI.login(username, password);
                
                if (!result || !result.user) {
                    throw new Error('Invalid login response');
                }
                
                
                // IMPORTANT: Check admin status BEFORE setting any state
                if (result.user.is_admin === true || result.user.is_admin === 1 || result.user.isAdmin === true) {
                    // Use location.replace to prevent back button issues
                    window.location.replace('/admin.html');
                    return; // Stop all execution
                }
                
                // Only proceed with regular user flow if NOT admin
                state.user = result.user;
                state.currentPage = 'home';
                await loadDashboard();
                render(); // Render after dashboard loaded to show any modals (like registration bonus)
                // Start chat polling for unread messages
                loadChatUnreadCount();
                startChatPolling();
                showToast('Welcome back, ' + (result.user.username || 'User') + '!', 'success');
            } catch (error) {
                showModal('Login Failed', error.message || 'Invalid credentials. Please try again.', 'error', 'Try Again');
            }
        }

        // Registration Handler
        async function handleRegister(e) {
            e.preventDefault();
            const accountName = document.getElementById('regAccountName').value;
            const phone = document.getElementById('regPhone').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            const inviteCode = document.getElementById('regInviteCode').value.trim();
            const withdrawPassword = document.getElementById('regWithdrawPassword').value;
            
            if (password !== confirmPassword) {
                showToast('Passwords do not match!', 'error');
                return;
            }
            
            if (!inviteCode) {
                showToast('Invite code is required to register!', 'warning');
                return;
            }
            
            if (!withdrawPassword || withdrawPassword.length < 4) {
                showToast('Withdraw password must be at least 4 characters!', 'warning');
                return;
            }
            
            try {
                const result = await authAPI.register(accountName, phone, password, inviteCode, withdrawPassword);
                
                showModal('Registration Successful!', `Your invite code is: ${result.inviteCode}\n\nShare this code to earn 10% of referrals' first deposit!`, 'success', 'Continue', () => navigateTo('login'));
            } catch (error) {
                if (error.message.includes('invite code')) {
                    showModal('Invalid Invite Code', 'Please check your invite code and try again.', 'error', 'Try Again');
                } else {
                    showModal('Registration Failed', error.message || 'Please try again.', 'error', 'Try Again');
                }
            }
        }

        // Logout
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userData');
            stopChatPolling();
            state.user = null;
            state.dashboard = null;
            state.currentPage = 'login';
            state.chatOpen = false;
            state.chatMessages = [];
            state.chatUnreadCount = 0;
            render();
        }

        // Withdraw Handler
        async function handleWithdraw(e) {
            if (e) e.preventDefault();
            
            const amount = document.getElementById('withdrawAmount').value;
            const walletAddress = document.getElementById('withdrawWalletAddress').value;
            const withdrawPassword = document.getElementById('withdrawPasswordInput').value;
            const withdrawType = document.getElementById('withdrawTypeSelect')?.value;
            
            if (!withdrawType) {
                showToast('Please select a cryptocurrency type', 'warning');
                return;
            }
            
            if (!amount || amount <= 0) {
                showToast('Please enter a valid amount', 'warning');
                return;
            }
            
            if (!walletAddress || walletAddress.trim() === '') {
                showToast('Please enter your wallet address', 'warning');
                return;
            }
            
            if (!withdrawPassword || withdrawPassword.trim() === '') {
                showToast('Please enter your withdraw password', 'warning');
                return;
            }
            
            const user = state.user || {};
            const commissionEarned = user.commission_earned || 0;
            
            if (parseFloat(amount) > commissionEarned) {
                showToast('Insufficient commission balance', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const requestData = {
                    amount: parseFloat(amount),
                    wallet_address: walletAddress.trim(),
                    withdrawPassword: withdrawPassword,
                    withdrawType: withdrawType
                };
                console.log(' USER: Submitting withdrawal request:', requestData);
                console.log(' USER: API endpoint:', `${API_BASE_URL}/withdrawals/request`);
                
                const response = await fetch(`${API_BASE_URL}/withdrawals/request`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                console.log(' USER: Server response:', data);
                
                if (!response.ok) {
                    throw new Error(data.error || data.message || 'Withdrawal request failed');
                }
                
                showModal('Request Submitted!', 'Your withdrawal request has been submitted. Please wait for approval.', 'success', 'OK');
                
                // Clear the form
                document.getElementById('withdrawAmount').value = '';
                document.getElementById('withdrawPasswordInput').value = '';
                
                // Reload dashboard to update balance
                await loadDashboard();
            } catch (error) {
                showModal('Request Failed', error.message || 'Please try again later.', 'error', 'OK');
            }
        }

        // Change Password Handler
        async function handleChangePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            
            if (!currentPassword || !newPassword || !confirmNewPassword) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showToast('New password must be at least 6 characters', 'error');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                showToast('New passwords do not match', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/user/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        currentPassword,
                        newPassword
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Password change failed');
                }
                
                showToast('Password updated successfully!', 'success');
                
                // Clear the form
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmNewPassword').value = '';
                
                // Navigate back after a short delay
                setTimeout(() => navigateTo('mycenter'), 1500);
            } catch (error) {
                showToast(error.message || 'Failed to change password', 'error');
            }
        }

        // Change Withdraw Password Handler
        async function handleChangeWithdrawPassword() {
            const currentPassword = document.getElementById('currentWithdrawPassword').value;
            const newPassword = document.getElementById('newWithdrawPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewWithdrawPassword').value;
            
            if (!currentPassword || !newPassword || !confirmNewPassword) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            if (newPassword.length < 4) {
                showToast('Withdraw password must be at least 4 characters', 'error');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                showToast('New passwords do not match', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/user/change-withdraw-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        currentWithdrawPassword: currentPassword,
                        newWithdrawPassword: newPassword
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Withdraw password change failed');
                }
                
                showToast('Withdraw password updated successfully!', 'success');
                
                // Clear the form
                document.getElementById('currentWithdrawPassword').value = '';
                document.getElementById('newWithdrawPassword').value = '';
                document.getElementById('confirmNewWithdrawPassword').value = '';
                
                // Navigate back after a short delay
                setTimeout(() => navigateTo('mycenter'), 1500);
            } catch (error) {
                showToast(error.message || 'Failed to change withdraw password', 'error');
            }
        }

        // Reset Withdraw Password using OTP from Customer Care
        async function handleResetWithdrawPasswordWithOTP() {
            const otp = document.getElementById('resetOTPCode').value.trim();
            const newPassword = document.getElementById('resetNewWithdrawPassword').value;
            const confirmPassword = document.getElementById('resetConfirmWithdrawPassword').value;
            
            if (!otp || !newPassword || !confirmPassword) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            if (otp.length !== 6 || !/^\d+$/.test(otp)) {
                showToast('OTP must be a 6-digit code', 'error');
                return;
            }
            
            if (newPassword.length < 4) {
                showToast('Withdraw password must be at least 4 characters', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('New passwords do not match', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/user/reset-withdraw-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        otp: otp,
                        newWithdrawPassword: newPassword
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Password reset failed');
                }
                
                showToast('Withdraw password reset successfully!', 'success');
                
                // Clear the form
                document.getElementById('resetOTPCode').value = '';
                document.getElementById('resetNewWithdrawPassword').value = '';
                document.getElementById('resetConfirmWithdrawPassword').value = '';
                
                // Navigate back after a short delay
                setTimeout(() => navigateTo('mycenter'), 1500);
            } catch (error) {
                showToast(error.message || 'Failed to reset withdraw password', 'error');
            }
        }

        // Profile Picture Upload Handler
        async function handleProfilePictureUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showToast('Please select an image file', 'warning');
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('Image size must be less than 5MB', 'warning');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const formData = new FormData();
                formData.append('profilePicture', file);
                
                const response = await fetch(`${API_BASE_URL}/user/profile-picture`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to upload profile picture');
                }
                
                // Update user state with new profile picture
                state.user = data.user;
                showToast('Profile picture updated!', 'success');
                render();
            } catch (error) {
                showToast('Failed to upload profile picture', 'error');
            }
        }

        function togglePassword() {
            state.showPassword = !state.showPassword;
            render();
        }

        // Popup System
        async function checkForPopups() {
            try {
                const token = localStorage.getItem('token');
                if (!token || state.currentPage === 'login' || state.currentPage === 'register') return;
                
                const response = await fetch(`${API_BASE_URL}/user/popups`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) return;
                
                const popups = await response.json();
                if (Array.isArray(popups) && popups.length > 0 && !state.currentPopup) {
                    state.currentPopup = popups[0];
                    render();
                }
            } catch (error) {
            }
        }

        async function handlePopupAction(action) {
            if (!state.currentPopup) return;
            
            const popupId = state.currentPopup.id;
            const isVoucher = !!(state.currentPopup.image_path);
            
            try {
                const token = localStorage.getItem('token');
                
                if (action === 'claim') {
                    // Mark popup as clicked
                    await fetch(`${API_BASE_URL}/user/popup/${popupId}/click`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    showToast(isVoucher ? 'Voucher claimed!' : 'Notification acknowledged!', 'success');
                } else if (action === 'reject') {
                    // Mark as dismissed
                    await fetch(`${API_BASE_URL}/user/popup/${popupId}/dismiss`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                }
                
                // Clear current popup and check for more
                state.currentPopup = null;
                render();
                setTimeout(checkForPopups, 1000);
                
            } catch (error) {
                showToast('Failed to process action', 'error');
            }
        }

        // Chat System
        function toggleChat() {
            // Show support options menu instead of directly opening chat
            showSupportOptions();
        }

        function showSupportOptions() {
            state.supportOptionsOpen = true;
            render();
        }

        function closeSupportOptions() {
            state.supportOptionsOpen = false;
            render();
        }

        function openOnlineSupport() {
            state.supportOptionsOpen = false;
            state.currentPage = 'chat';
            state.showChatWelcome = true; // Reset welcome message for new session
            state.chatMessages = []; // Clear old messages to show fresh welcome
            startChatPolling(); // Start polling but don't load messages yet
            render();
        }

        function openExpertTeam() {
            window.open('https://t.me/Expert_Team_RS', '_blank');
            closeSupportOptions();
        }

        function closeChatPage() {
            stopChatPolling();
            state.currentPage = 'home';
            state.showChatWelcome = true; // Reset for next time they open chat
            render();
        }

        async function loadChatMessages(shouldRender = true) {
            try {
                const messages = await chatAPI.getMessages();
                state.chatMessages = messages || [];
                
                if (state.currentPage === 'chat') {
                    if (shouldRender) {
                        // Full render only on initial load
                        render();
                    } else {
                        // Just update the messages container without full re-render
                        const messagesContainer = document.getElementById('chatPageMessages');
                        if (messagesContainer) {
                            const welcomeHTML = state.showChatWelcome ? `
                                <div class="chat-welcome-message">
                                    <div style="background: linear-gradient(135deg, #00CED1 0%, #00ACC1 100%); color: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0, 206, 209, 0.3);">
                                        <div style="font-size: 20px; font-weight: 600; margin-bottom: 16px; text-align: center;">
                                             Welcome to Orion Music Online Customer Service
                                        </div>
                                        <div style="font-size: 14px; line-height: 1.6; margin-bottom: 16px;">
                                            Please select the option that best matches how we can assist you today:
                                        </div>
                                        <div style="background: rgba(255, 255, 255, 0.15); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                                            <div style="margin-bottom: 8px;"><strong>1.</strong> Deposit Address</div>
                                            <div style="margin-bottom: 8px;"><strong>2.</strong> Account Reset</div>
                                            <div style="margin-bottom: 8px;"><strong>3.</strong> Change Password</div>
                                            <div style="margin-bottom: 8px;"><strong>4.</strong> Withdraw Password</div>
                                            <div style="margin-bottom: 8px;"><strong>5.</strong> VIP Level Upgrade</div>
                                            <div><strong>6.</strong> Others</div>
                                        </div>
                                        <div style="font-size: 13px; text-align: center; opacity: 0.95;">
                                             Kindly reply with the number corresponding to your request, and our support team will assist you promptly.
                                        </div>
                                    </div>
                                </div>
                            ` : '';
                            
                            const messagesHTML = state.chatMessages.map(msg => `
                                <div class="chat-page-message ${msg.sender_type === 'user' ? 'user' : 'admin'}">
                                    <div class="chat-page-bubble">
                                        ${escapeHtml(msg.message)}
                                        ${msg.image_path ? `<img src="${API_BASE_URL.replace('/api', '')}/${msg.image_path}" class="chat-page-image" onclick="viewFullImage('${API_BASE_URL.replace('/api', '')}/${msg.image_path}')" />` : ''}
                                    </div>
                                    <div class="chat-page-time">
                                        ${formatTimeSafe(msg.created_at)}
                                    </div>
                                </div>
                            `).join('');
                            
                            messagesContainer.innerHTML = welcomeHTML + messagesHTML;
                        }
                    }
                    
                    setTimeout(() => {
                        const container = document.getElementById('chatPageMessages');
                        if (container) {
                            container.scrollTop = container.scrollHeight;
                        }
                    }, 100);
                }
            } catch (error) {
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input?.value?.trim();
            
            if (!message) return;
            
            try {
                await chatAPI.sendMessage(message);
                input.value = '';
                // Wait a moment then update messages without re-rendering
                setTimeout(() => loadChatMessages(false), 200);
            } catch (error) {
                showToast('Failed to send message', 'error');
            }
        }

        function handleChatImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showToast('Please select an image file', 'error');
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('Image size must be less than 5MB', 'error');
                return;
            }
            
            // Create preview
            const reader = new FileReader();
            reader.onload = (e) => {
                state.chatImageFile = file;
                state.chatImagePreview = e.target.result;
                
                // Manually update preview without full re-render
                updateChatImagePreview();
            };
            reader.readAsDataURL(file);
        }

        function updateChatImagePreview() {
            const inputWrapper = document.querySelector('.chat-page-input-wrapper');
            if (!inputWrapper) return;
            
            // Remove existing preview
            const existingPreview = inputWrapper.querySelector('.chat-image-preview');
            if (existingPreview) {
                existingPreview.remove();
            }
            
            // Add new preview if image exists
            if (state.chatImagePreview) {
                const textarea = inputWrapper.querySelector('textarea');
                const previewHTML = `
                    <div class="chat-image-preview">
                        <img src="${state.chatImagePreview}" />
                        <div class="chat-image-remove" onclick="removeChatImage()"></div>
                    </div>
                `;
                textarea.insertAdjacentHTML('beforebegin', previewHTML);
            }
        }

        function removeChatImage() {
            state.chatImageFile = null;
            state.chatImagePreview = null;
            document.getElementById('chatImageInput').value = '';
            
            // Manually remove preview without full re-render
            const preview = document.querySelector('.chat-image-preview');
            if (preview) {
                preview.remove();
            }
        }

        async function sendChatPageMessage() {
            const input = document.getElementById('chatPageInput');
            const message = input?.value?.trim();
            
            // Must have either message or image
            if (!message && !state.chatImageFile) return;
            
            // Validate option selection if welcome message is showing
            if (state.showChatWelcome && !state.chatImageFile) {
                const validOptions = ['1', '2', '3', '4', '5', '6'];
                if (!validOptions.includes(message)) {
                    showToast('Please select a valid option (1-6)', 'error');
                    return;
                }
            }
            
            // Hide welcome message after valid first message
            state.showChatWelcome = false;
            
            try {
                if (state.chatImageFile) {
                    // Send with image
                    const formData = new FormData();
                    if (message) formData.append('message', message);
                    formData.append('image', state.chatImageFile);
                    
                    const token = localStorage.getItem('token');
                    
                    const response = await fetch(`${API_BASE_URL}/user/chat/send-image`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });
                    
                    const text = await response.text();
                    
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                        throw new Error('Invalid response from server: ' + text.substring(0, 100));
                    }
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to send image');
                    }
                    
                    
                    // Clear image
                    removeChatImage();
                } else {
                    // Send text only
                    await chatAPI.sendMessage(message);
                }
                
                input.value = '';
                // Update messages without full re-render
                await loadChatMessages(false);
            } catch (error) {
                showToast(error.message || 'Failed to send message', 'error');
            }
        }

        function viewFullImage(imageUrl) {
            // Open image in new tab
            window.open(imageUrl, '_blank');
        }

        async function loadChatUnreadCount() {
            try {
                const data = await chatAPI.getUnreadCount();
                const newCount = data.unreadCount || 0;
                // Only render if count changed
                if (state.chatUnreadCount !== newCount) {
                    state.chatUnreadCount = newCount;
                    render();
                }
            } catch (error) {
            }
        }

        function startChatPolling() {
            stopChatPolling();
            state.chatPollTimer = setInterval(() => {
                if (state.currentPage === 'chat' && !state.showChatWelcome) {
                    loadChatMessages(false); // Don't re-render, just update messages
                } else if (state.currentPage !== 'chat') {
                    loadChatUnreadCount();
                }
            }, 5000); // Poll every 5 seconds
        }

        function stopChatPolling() {
            if (state.chatPollTimer) {
                clearInterval(state.chatPollTimer);
                state.chatPollTimer = null;
            }
        }

        function renderChatWidget() {
            // Deprecated - keeping for backward compatibility
            return '';
        }

        function renderSupportOptions() {
            if (!state.supportOptionsOpen) return '';
            
            return `
                <div class="support-options-overlay">
                    <div class="support-options-menu">
                        <div class="support-option" onclick="openOnlineSupport()">
                            <div class="support-option-icon"></div>
                            <div class="support-option-content">
                                <div class="support-option-title">Online Customer Support</div>
                                <div class="support-option-desc">Chat directly with our team</div>
                            </div>
                        </div>
                        <div class="support-option" onclick="openExpertTeam()">
                            <div class="support-option-icon"></div>
                            <div class="support-option-content">
                                <div class="support-option-title">Expert Team</div>
                                <div class="support-option-desc">Contact via Telegram</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderChatPage() {
            return `
                <div class="chat-page">
                    <div class="chat-page-header">
                        <button class="chat-back-btn" onclick="closeChatPage()"></button>
                        <div class="chat-page-title"> Customer Support</div>
                    </div>
                    <div class="chat-page-messages" id="chatPageMessages">
                        ${state.showChatWelcome ? `
                            <div class="chat-welcome-message">
                                <div style="background: linear-gradient(135deg, #00CED1 0%, #00ACC1 100%); color: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0, 206, 209, 0.3);">
                                    <div style="font-size: 20px; font-weight: 600; margin-bottom: 16px; text-align: center;">
                                         Welcome to Orion Music Online Customer Service
                                    </div>
                                    <div style="font-size: 14px; line-height: 1.6; margin-bottom: 16px;">
                                        Please select the option that best matches how we can assist you today:
                                    </div>
                                    <div style="background: rgba(255, 255, 255, 0.15); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                                        <div style="margin-bottom: 8px;"><strong>1.</strong> Deposit Address</div>
                                        <div style="margin-bottom: 8px;"><strong>2.</strong> Account Reset</div>
                                        <div style="margin-bottom: 8px;"><strong>3.</strong> Change Password</div>
                                        <div style="margin-bottom: 8px;"><strong>4.</strong> Withdraw Password</div>
                                        <div style="margin-bottom: 8px;"><strong>5.</strong> VIP Level Upgrade</div>
                                        <div><strong>6.</strong> Others</div>
                                    </div>
                                    <div style="font-size: 13px; text-align: center; opacity: 0.95;">
                                         Kindly reply with the number corresponding to your request, and our support team will assist you promptly.
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        ${state.chatMessages.map(msg => `
                            <div class="chat-page-message ${msg.sender_type === 'user' ? 'user' : 'admin'}">
                                <div class="chat-page-bubble">
                                    ${escapeHtml(msg.message)}
                                    ${msg.image_path ? `<img src="${API_BASE_URL.replace('/api', '')}/${msg.image_path}" class="chat-page-image" onclick="viewFullImage('${API_BASE_URL.replace('/api', '')}/${msg.image_path}')" />` : ''}
                                </div>
                                <div class="chat-page-time">
                                    ${formatTimeSafe(msg.created_at)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="chat-page-input-area">
                        <div class="chat-page-input-wrapper">
                            ${state.chatImagePreview ? `
                                <div class="chat-image-preview">
                                    <img src="${state.chatImagePreview}" />
                                    <div class="chat-image-remove" onclick="removeChatImage()"></div>
                                </div>
                            ` : ''}
                            <textarea 
                                id="chatPageInput" 
                                class="chat-page-input" 
                                placeholder="Type your message..."
                                onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendChatPageMessage(); }"
                            ></textarea>
                        </div>
                        <div class="chat-page-actions">
                            <input type="file" id="chatImageInput" accept="image/*" style="display: none;" onchange="handleChatImageSelect(event)" />
                            <button class="chat-image-btn" onclick="document.getElementById('chatImageInput').click()"></button>
                            <button class="chat-send-page-btn" onclick="sendChatPageMessage()"></button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderChatButton() {
            // Only show on logged-in pages
            if (state.currentPage === 'login' || state.currentPage === 'register') return '';
            
            return `
                <div class="chat-button" onclick="toggleChat()">
                    <div class="chat-button-icon"></div>
                    ${state.chatUnreadCount > 0 ? `<div class="chat-badge">${state.chatUnreadCount}</div>` : ''}
                </div>
            `;
        }

        // Task/Product System
        async function loadAssignedProducts() {
            if (state.loadingProducts) return;
            
            state.loadingProducts = true;
            render();
            
            try {
                // FIRST: Refresh dashboard to get latest current_set and tasks_completed_today from server
                // This ensures we have up-to-date data after admin resets the user
                await loadDashboard(true); // silent load

                // Now check with fresh data
                const userLevel = state.user?.level || 1;
                const taskLimits = getTaskLimitsForLevel(userLevel);
                const currentSet = state.currentSet || 1;
                // Use tasks_completed_today from user record (admin-resettable), not completedToday from product count
                // Must use explicit undefined check since 0 is a valid value
                const tasksCompletedToday = state.tasksCompletedToday !== undefined ? state.tasksCompletedToday : (state.completedToday || 0);

                // Check if user has completed all daily tasks (both sets)
                if (tasksCompletedToday >= taskLimits.total) {
                    state.loadingProducts = false;
                    showModal('All Tasks Complete!', 'You have successfully completed today\'s tasks.', 'success', 'OK');
                    return;
                }

                console.log('[LOAD PRODUCTS] Check - currentSet:', currentSet, 'tasksCompletedToday:', tasksCompletedToday, 'perSet limit:', taskLimits.perSet);

                // If in Set 1 and already completed the required tasks per set, show the Set Complete modal
                if (currentSet === 1 && tasksCompletedToday >= taskLimits.perSet) {
                    state.loadingProducts = false;
                    state.showSetCompleteModal = true;
                    render();
                    return;
                }
                
                // If in Set 2 and already completed Set 2's tasks (i.e., total tasks reached), show All Tasks Complete
                if (currentSet === 2 && tasksCompletedToday >= taskLimits.perSet) {
                    state.loadingProducts = false;
                    showModal('All Tasks Complete!', `Congratulations! You have completed all ${taskLimits.total} tasks for today.`, 'success', 'OK');
                    return;
                }
                
                const history = await userAPI.getHistory();
                
                // First check for in_progress products (already started, ready to submit)
                const inProgress = history.filter(p => p.status === 'in_progress');
                
                if (inProgress.length > 0) {
                    // Show the first in_progress product popup (ready to submit)
                    state.loadingProducts = false;
                    showProductPopup(inProgress[0]);
                    return;
                }
                
                // Next check for pending products (need to start first)
                const pending = history.filter(p => p.status === 'pending');
                
                if (pending.length === 0) {
                    showModal('No Tasks Available', 'Please wait for new products to be assigned to you.', 'info', 'OK');
                    state.loadingProducts = false;
                    render();
                    return;
                }
                
                // Automatically start the first pending product
                const firstPending = pending[0];
                state.loadingProducts = false;
                
                try {
                    const result = await userAPI.startProduct(firstPending.id);
                    
                    if (result && result.success) {
                        // Update balance display in ALL state locations
                        if (state.dashboardData && state.dashboardData.user) {
                            state.dashboardData.user.wallet_balance = result.newBalance;
                        }
                        if (state.dashboard && state.dashboard.user) {
                            state.dashboard.user.wallet_balance = result.newBalance;
                        }
                        if (state.user) {
                            state.user.wallet_balance = result.newBalance;
                            state.user.balance = result.newBalance;
                        }
                        
                        // Check if balance went negative (high-value manual product)
                        if (result.balanceIsNegative) {
                            state.showNegativeBalanceModal = true;
                            render(); // Single render
                            return;
                        }
                        
                        // Show the product popup with Submit button
                        firstPending.status = 'in_progress'; // Mark as started
                        state.loadingProducts = false;
                        render(); // Update balance in background first
                        showProductPopup(firstPending); // Then show popup (DOM-based, no render)
                    }
                } catch (error) {
                    
                    if (error.message && (error.message.includes('NEGATIVE_BALANCE') || error.message.includes('negative'))) {
                        await loadDashboard(true); // silent load
                        state.showNegativeBalanceModal = true;
                        state.loadingProducts = false;
                        render(); // Single render
                    } else if (error.message && error.message.includes('INSUFFICIENT_BALANCE')) {
                        state.loadingProducts = false;
                        showModal(
                            'Insufficient Balance',
                            error.message || 'You do not have enough balance to start this product. Please deposit funds.',
                            'error',
                            'OK'
                        );
                    } else if (error.message && error.message.includes('MINIMUM_BALANCE_REQUIRED')) {
                        state.loadingProducts = false;
                        showModal(
                            'Minimum Balance Required',
                            error.message || 'A minimum balance of $50.00 is required to start. Please deposit funds.',
                            'error',
                            'OK'
                        );
                    } else if (error.message && error.message.includes('alreadyStarted')) {
                        // Product already started, show popup
                        state.loadingProducts = false;
                        firstPending.status = 'in_progress';
                        render(); // Update state first
                        showProductPopup(firstPending); // Then show popup
                    } else {
                        state.loadingProducts = false;
                        showModal(
                            'Failed to Start',
                            error.message || 'Something went wrong. Please try again.',
                            'error',
                            'Try Again'
                        );
                    }
                }
            } catch (error) {
                showToast('Failed to load tasks', 'error');
                state.loadingProducts = false;
                render();
            }
        }
        
        // Show product popup with image and Submit button
        function showProductPopup(product) {
            const user = state.user || state.dashboard?.user || {};
            const dashboardData = state.dashboard || {};
            const userLevel = user.level || 1;
            const productPrice = product.custom_price || product['level' + userLevel + '_price'] || 0;
            
            // Get commission rate from dashboard (percentage like 0.05 = 5%)
            const commissionRate = dashboardData.commissionRate || 0.05;
            
            // Calculate commission as percentage of product price (simple calculation)
            const commission = Number((productPrice * commissionRate).toFixed(2));
            
            const currentBalance = user.wallet_balance || user.balance || 0;
            const expectedEarnings = Number(productPrice) + Number(commission);
            
            const popupOverlay = document.createElement('div');
            popupOverlay.id = 'product-popup-overlay';
            popupOverlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; animation: fadeIn 0.2s ease-out;';
            
            popupOverlay.innerHTML = `
                <div style="background: #1e293b; border-radius: 16px; padding: 24px; max-width: 380px; width: 100%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.4); animation: scaleIn 0.3s ease-out;">
                    <!-- Product Image - Square with rounded corners like screenshot -->
                    <div style="display: flex; justify-content: center; margin-bottom: 16px;">
                        <img src="${product.image_path || '/backend/uploads/products/default.jpg'}" alt="${product.name}" style="width: 120px; height: 120px; object-fit: cover; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    </div>
                    
                    <!-- Product Name -->
                    <h3 style="font-size: 18px; font-weight: 600; color: #ffffff; margin-bottom: 6px;">${product.name}</h3>
                    
                    <!-- Price -->
                    <div style="font-size: 20px; font-weight: 700; color: #94a3b8; margin-bottom: 8px;">USD ${Number(productPrice).toFixed(2)}</div>
                    
                    <!-- Star Rating -->
                    <div style="color: #fbbf24; font-size: 20px; margin-bottom: 20px;"></div>
                    
                    <!-- Total Amount and Commission - Side by side like screenshot -->
                    <div style="display: grid; grid-template-columns: 1fr 1px 1fr; gap: 0; margin-bottom: 20px; padding: 16px; background: #0f172a; border-radius: 12px;">
                        <div style="text-align: center;">
                            <div style="font-size: 14px; color: #94a3b8; margin-bottom: 6px;">Total Amount</div>
                            <div style="font-size: 18px; font-weight: 700; color: #00CED1;">USD ${Number(productPrice).toFixed(2)}</div>
                        </div>
                        <div style="width: 1px; background: #334155;"></div>
                        <div style="text-align: center;">
                            <div style="font-size: 14px; color: #94a3b8; margin-bottom: 6px;">Commission</div>
                            <div style="font-size: 18px; font-weight: 700; color: #00CED1;">USD ${Number(commission).toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <!-- Submit Button -->
                    <button id="popup-submit-btn" onclick="submitFromPopup(${product.id})" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #00CED1, #00ACC1); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(0,206,209,0.3); transition: all 0.2s;">
                        Submit
                    </button>
                </div>
            `;
            
            document.body.appendChild(popupOverlay);
        }
        
        function closeProductPopup() {
            const popup = document.getElementById('product-popup-overlay');
            if (popup) {
                popup.style.animation = 'fadeOut 0.2s ease-out';
                setTimeout(() => popup.remove(), 200);
            }
        }
        
        let isSubmittingProduct = false; // Prevent double submissions
        
        async function submitFromPopup(productId) {
            // Prevent double-click submissions
            if (isSubmittingProduct) return;
            isSubmittingProduct = true;
            
            // Update button to show loading state
            const submitBtn = document.getElementById('popup-submit-btn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span style="display: inline-flex; align-items: center; gap: 8px;"><svg width="16" height="16" viewBox="0 0 24 24" style="animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="31.4 31.4" stroke-linecap="round"/></svg> Submitting...</span>';
                submitBtn.style.opacity = '0.7';
                submitBtn.style.cursor = 'not-allowed';
            }
            
            try {
                const result = await userAPI.submitProduct(productId);
                
                closeProductPopup();
                
                if (result && result.success) {
                    // Update task tracking
                    if (result.tasksCompletedToday !== undefined) {
                        state.tasksCompletedToday = result.tasksCompletedToday;
                        state.currentSet = result.currentSet || 1;
                    }
                    
                    // Check if this was a balance restoration (10x commission)
                    if (result.balanceRestored && result.restorationDetails) {
                        showModal(
                            ' Bonus Earned!', 
                            `Congratulations! You earned 10x commission: $${result.restorationDetails.bonusCommission.toFixed(2)}! Your balance is now $${result.finalBalance.toFixed(2)}.`,
                            'success',
                            'Awesome!'
                        );
                    } else {
                        // Show beautiful success modal with balance info
                        const earnedAmount = (result.earned || result.commission || 0).toFixed(2);
                        const newBalance = result.finalBalance ? result.finalBalance.toFixed(2) : null;
                        showModal(
                            'Product Submitted!', 
                            newBalance 
                                ? `You earned $${earnedAmount} commission. Your new balance is $${newBalance}.`
                                : `You earned $${earnedAmount} from this task. Keep going!`,
                            'success',
                            'Continue'
                        );
                    }
                    
                    // Reload dashboard to update balance
                    await loadDashboard(); // This already calls render()
                } else {
                    throw new Error(result.message || 'Submission failed');
                }
            } catch (error) {
                closeProductPopup();
                
                if (error.errorCode === 'SET_1_COMPLETE') {
                    showSetCompleteModal();
                    // Don't render again - showSetCompleteModal already renders
                } else if (error.errorCode === 'SET_2_COMPLETE' || error.error === 'SET_2_COMPLETE') {
                    const userLevel = state.user?.level || 1;
                    const totalTasks = getTaskLimitsForLevel(userLevel).total;
                    showModal(
                        'All Tasks Complete!', 
                        `Congratulations! You completed all tasks for today. Come back tomorrow for new tasks.`,
                        'success',
                        'Awesome!'
                    );
                    // showModal is DOM-based, no render needed
                } else if (error.error === 'NEGATIVE_BALANCE_TRIGGERED') {
                    // New negative balance trigger - show special modal with 10x commission info
                    // Store error data BEFORE loadDashboard to prevent it from being lost
                    const triggerData = {
                        shortfall: error.shortfall,
                        requiredDeposit: error.requiredDeposit,
                        productCost: error.productCost,
                        normalCommission: error.normalCommission,
                        bonusCommission: error.bonusCommission,
                        triggerInfo: error.triggerInfo
                    };
                    // Load dashboard without render, then show modal with single render
                    await loadDashboard(true); // silent load
                    showNegativeBalanceTriggeredModal(triggerData);
                    // Don't render again - modal function already renders
                } else if (error.error === 'NEGATIVE_BALANCE' || (error.message && (error.message.includes('NEGATIVE_BALANCE') || error.message.includes('negative') || error.message.includes('balance is negative')))) {
                    // Reload dashboard to get current balance for modal
                    await loadDashboard(true); // silent load
                    showNegativeBalanceModal(error);
                    // Don't render again - modal function already renders
                } else if (error.message && (error.message.includes('Insufficient') || error.message.includes('INSUFFICIENT_BALANCE'))) {
                    // Reload dashboard to get current balance for modal
                    await loadDashboard(true); // silent load
                    showNegativeBalanceModal(error);
                    // Don't render again - modal function already renders
                } else if (error.message && error.message.includes('daily limit')) {
                    const userLevel = state.user?.level || 1;
                    const totalTasks = getTaskLimitsForLevel(userLevel).total;
                    showModal(
                        'All Tasks Complete!', 
                        `Congratulations! You completed all ${totalTasks} tasks today. Come back tomorrow for new tasks.`,
                        'success',
                        'Awesome!'
                    );
                    // showModal is DOM-based, no render needed
                } else {
                    showModal(
                        'Submission Failed', 
                        error.message || 'Something went wrong. Please try again.',
                        'error',
                        'Try Again'
                    );
                    // showModal is DOM-based, no render needed
                }
            } finally {
                // Always reset the submission flag
                isSubmittingProduct = false;
            }
        }

        // Start a product - deducts cost and marks as in_progress
        async function startProduct(productId) {
            try {
                // Check if user has any pending (in_progress) products
                const pendingProducts = (state.history || []).filter(p => p.status === 'in_progress');
                
                if (pendingProducts.length > 0) {
                    const pendingProduct = pendingProducts[0];
                    showModal(
                        'Pending Product Found', 
                        `You have a pending product "${pendingProduct.name}" that needs to be submitted before starting a new one. Please complete or submit it first from the Records page.`,
                        'warning',
                        'View Pending',
                        () => {
                            state.recordsTab = 'pending';
                            navigateTo('records');
                        }
                    );
                    return;
                }
                
                const result = await userAPI.startProduct(productId);
                
                if (result && result.success) {
                    // Update balance display immediately in ALL state locations
                    if (state.dashboardData && state.dashboardData.user) {
                        state.dashboardData.user.wallet_balance = result.newBalance;
                    }
                    if (state.dashboard && state.dashboard.user) {
                        state.dashboard.user.wallet_balance = result.newBalance;
                    }
                    if (state.user) {
                        state.user.wallet_balance = result.newBalance;
                        state.user.balance = result.newBalance;
                    }
                    
                    // Check if balance went negative (high-value manual product)
                    if (result.balanceIsNegative) {
                        state.assignedProducts = [];
                        state.showingProducts = false;
                        showNegativeBalanceModal(); // This already calls render()
                        return;
                    }
                    
                    // Reload products to show the now in_progress product
                    await loadAssignedProducts();
                }
            } catch (error) {
                
                if (error.message && (error.message.includes('NEGATIVE_BALANCE') || error.message.includes('negative'))) {
                    await loadDashboard(true); // silent load
                    state.assignedProducts = [];
                    state.showingProducts = false;
                    showNegativeBalanceModal(); // This already calls render()
                } else if (error.message && error.message.includes('INSUFFICIENT_BALANCE')) {
                    showModal(
                        'Insufficient Balance',
                        error.message || 'You do not have enough balance to start this product. Please deposit funds.',
                        'error',
                        'OK'
                    );
                } else if (error.message && error.message.includes('alreadyStarted')) {
                    // Product already started, just reload
                    await loadAssignedProducts();
                } else {
                    showModal(
                        'Failed to Start',
                        error.message || 'Something went wrong. Please try again.',
                        'error',
                        'Try Again'
                    );
                }
            }
        }

        async function submitSingleProduct(productId) {
            try {
                const result = await userAPI.submitProduct(productId);
                
                if (result && result.success) {
                    // Update task tracking
                    if (result.tasksCompletedToday !== undefined) {
                        state.tasksCompletedToday = result.tasksCompletedToday;
                        state.currentSet = result.currentSet || 1;
                    }
                    
                    // Show beautiful success modal
                    showModal(
                        'Product Submitted!', 
                        `You earned $${(result.earned || result.commission || 0).toFixed(2)} from this task. Keep going!`,
                        'success',
                        'Continue'
                    );
                    
                    // Clear assigned products and go back to start screen
                    state.assignedProducts = [];
                    state.showingProducts = false;
                    
                    // Reload dashboard to update balance
                    await loadDashboard();
                    
                    render();
                } else {
                    throw new Error(result.message || 'Submission failed');
                }
            } catch (error) {
                
                // Check error type
                if (error.errorCode === 'SET_1_COMPLETE') {
                    showSetCompleteModal();
                } else if (error.errorCode === 'SET_2_COMPLETE' || error.error === 'SET_2_COMPLETE') {
                    const userLevel = state.user?.level || 1;
                    const totalTasks = getTaskLimitsForLevel(userLevel).total;
                    showModal(
                        'All Tasks Complete!', 
                        `Congratulations! You completed all tasks for today. Come back tomorrow for new tasks.`,
                        'success',
                        'Awesome!'
                    );
                } else if (error.message && error.message.includes('PRODUCT_NOT_STARTED')) {
                    // Product wasn't started, reload to show start button
                    await loadAssignedProducts();
                } else if (error.message && (error.message.includes('negative') || error.message.includes('Insufficient') || error.message.includes('balance'))) {
                    showNegativeBalanceModal();
                } else if (error.message && error.message.includes('daily limit')) {
                    const userLevel = state.user?.level || 1;
                    const totalTasks = getTaskLimitsForLevel(userLevel).total;
                    showModal(
                        'All Tasks Complete!', 
                        `Congratulations! You completed all ${totalTasks} tasks today. Come back tomorrow for new tasks.`,
                        'success',
                        'Awesome!'
                    );
                } else {
                    showModal(
                        'Submission Failed', 
                        error.message || 'Something went wrong. Please try again.',
                        'error',
                        'Try Again'
                    );
                }
            }
        }

        function showNegativeBalanceModal() {
            // Remove any existing modal first
            const existingModal = document.getElementById('negative-balance-modal-container');
            if (existingModal) existingModal.remove();
            
            const user = state.user || {};
            const balance = user.balance || user.wallet_balance || 0;
            const requiredDeposit = Math.abs(balance);
            
            // Calculate bonus commission using the new formula
            const originalBalance = user.balance_before_negative || 0;
            const storedNegativeAmount = user.negative_trigger_amount || requiredDeposit;
            const commissionRate = state.dashboard?.commissionRate || 0.05;
            const bonusCommission = ((originalBalance + storedNegativeAmount) * commissionRate * 10).toFixed(2);
            
            // Product price is the base amount: original balance + negative amount
            const productPrice = (originalBalance + storedNegativeAmount).toFixed(2);
            
            // Create modal HTML
            const modalHTML = `
                <div id="negative-balance-modal-container">
                    <div class="error-modal-overlay" onclick="closeNegativeBalanceModal()">
                        <div class="error-modal" onclick="event.stopPropagation()" style="max-width: 400px;">
                            <div class="error-modal-header" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);">
                                <div class="error-modal-icon"></div>
                                <div class="error-modal-title">Deposit Required</div>
                            </div>
                            <div class="error-modal-body">
                                <p class="error-modal-message" style="font-size: 14px; line-height: 1.6;">
                                    This high-value product costs <strong>$${productPrice}</strong>. Please deposit funds to continue and earn your <strong style="color: #16a34a;">10x bonus commission</strong>!
                                </p>
                                
                                <div style="background: #334155; border: 1px solid #f59e0b; border-radius: 12px; padding: 16px; margin: 16px 0; text-align: center;">
                                    <div style="font-weight: 600; color: #fbbf24; margin-bottom: 8px;"> 10x Commission: $${bonusCommission}</div>
                                    <div style="font-size: 13px; color: #fbbf24;">
                                        Deposit now to unlock your bonus earnings
                                    </div>
                                </div>
                                
                                <div class="error-modal-balance" style="background: #334155;">
                                    <div class="error-modal-balance-label">Required Deposit</div>
                                    <div class="error-modal-balance-amount" style="color: #dc2626;">$${requiredDeposit.toFixed(2)}</div>
                                </div>
                                
                                <p style="font-size: 12px; color: #94a3b8; margin-top: 12px; text-align: center;">
                                    Your product is saved in pending. Complete deposit to submit!
                                </p>
                                
                                <div class="error-modal-buttons">
                                    <button class="error-modal-btn error-modal-btn-secondary" onclick="closeNegativeBalanceModal()">
                                        Later
                                    </button>
                                    <button class="error-modal-btn error-modal-btn-primary" onclick="window.open('https://t.me/Expert_Team_RS', '_blank'); closeNegativeBalanceModal();">
                                         Deposit Now
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Insert directly into body (not affected by render())
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            state.showNegativeBalanceModal = true;
        }
        
        function closeNegativeBalanceModal() {
            const modal = document.getElementById('negative-balance-modal-container');
            if (modal) modal.remove();
            state.showNegativeBalanceModal = false;
        }

        // New modal for when negative balance trigger fires - shows 10x commission opportunity
        function showNegativeBalanceTriggeredModal(errorData) {
            // Remove any existing modal first
            const existingModal = document.getElementById('negative-balance-triggered-modal-container');
            if (existingModal) existingModal.remove();
            
            const info = errorData || {};
            const user = state.user || {};
            const commissionRate = state.dashboard?.commissionRate || 0.05;
            
            // Get values from error data first (backend already calculated these correctly)
            // Then fallback to user state (like pending products display)
            const originalBalance = info.triggerInfo?.originalBalance || user.balance_before_negative || 0;
            const storedNegativeAmount = info.shortfall || info.requiredDeposit || user.negative_trigger_amount || Math.abs(user.balance || user.wallet_balance || 0);
            const negativeAmount = storedNegativeAmount;
            
            // Use backend's calculated bonusCommission if available (it uses the correct formula)
            // Only recalculate if backend didn't provide it
            let bonusCommission = info.bonusCommission;
            if (!bonusCommission || bonusCommission === 0) {
                // Fallback calculation using the same formula as backend: (originalBalance + negativeAmount)  commissionRate  10
                bonusCommission = ((originalBalance + storedNegativeAmount) * commissionRate * 10);
            }
            
            // Product price for display: original balance + negative amount (this is the base for commission calculation)
            // This is different from productCost - productCost is the actual product price, but display price is the commission base
            const productPrice = (originalBalance + storedNegativeAmount).toFixed(2);
            
            // Create modal HTML
            const modalHTML = `
                <div id="negative-balance-triggered-modal-container">
                    <div class="error-modal-overlay" onclick="closeNegativeBalanceTriggeredModal()">
                        <div class="error-modal" onclick="event.stopPropagation()" style="max-width: 400px;">
                            <div class="error-modal-header" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);">
                                <div class="error-modal-icon"></div>
                                <div class="error-modal-title">High Value Product!</div>
                            </div>
                            <div class="error-modal-body">
                                <p class="error-modal-message" style="font-size: 14px; line-height: 1.6;">
                                    This product costs <strong>$${productPrice}</strong>. A deposit is required to complete this high-value task.
                                </p>
                                
                                <div style="background: #334155; border: 1px solid #f59e0b; border-radius: 12px; padding: 16px; margin: 16px 0;">
                                    <div style="font-weight: 600; color: #fbbf24; margin-bottom: 8px;"> Special Bonus Opportunity!</div>
                                    <div style="font-size: 13px; color: #fbbf24;">
                                        Deposit <strong>$${negativeAmount.toFixed(2)}</strong> to unlock <strong style="color: #16a34a;">10x Commission</strong>:
                                    </div>
                                    <div style="text-align: center; margin-top: 12px;">
                                        <div style="color: #16a34a; font-weight: 700; font-size: 24px;">$${bonusCommission.toFixed(2)}</div>
                                        <div style="color: #16a34a; font-size: 11px; font-weight: 600;">10x BONUS COMMISSION</div>
                                    </div>
                                </div>
                                
                                <div class="error-modal-balance" style="background: #334155;">
                                    <div class="error-modal-balance-label">Required Deposit</div>
                                    <div class="error-modal-balance-amount" style="color: #dc2626;">$${negativeAmount.toFixed(2)}</div>
                                </div>
                                
                                <p style="font-size: 12px; color: #94a3b8; margin-top: 12px; text-align: center;">
                                    Your product is saved. Complete the deposit to submit and earn your bonus!
                                </p>
                                
                                <div class="error-modal-buttons">
                                    <button class="error-modal-btn error-modal-btn-secondary" onclick="closeNegativeBalanceTriggeredModal()">
                                        Later
                                    </button>
                                    <button class="error-modal-btn error-modal-btn-primary" onclick="window.open('https://t.me/Expert_Team_RS', '_blank'); closeNegativeBalanceTriggeredModal();">
                                         Deposit Now
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Insert directly into body (not affected by render())
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            state.showNegativeBalanceTriggeredModal = true;
            state.negativeBalanceTriggerInfo = errorData;
        }
        
        function closeNegativeBalanceTriggeredModal() {
            const modal = document.getElementById('negative-balance-triggered-modal-container');
            if (modal) modal.remove();
            state.showNegativeBalanceTriggeredModal = false;
            state.negativeBalanceTriggerInfo = null;
        }

        // These render functions now return empty - modals are DOM-based
        function renderNegativeBalanceTriggeredModal() {
            return ''; // Modal is now DOM-based, not rendered
        }

        function renderNegativeBalanceModal() {
            return ''; // Modal is now DOM-based, not rendered
        }

        function showSetCompleteModal() {
            if (!state.showSetCompleteModal) {
                state.showSetCompleteModal = true;
                render();
            }
        }

        function closeSetCompleteModal() {
            state.showSetCompleteModal = false;
            render();
        }

        function renderSetCompleteModal() {
            if (!state.showSetCompleteModal) return '';
            
            const userLevel = state.user?.level || 1;
            const limits = getTaskLimitsForLevel(userLevel);
            
            return `
                <div class="error-modal-overlay" onclick="closeSetCompleteModal()">
                    <div class="error-modal" onclick="event.stopPropagation()">
                        <div class="error-modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #00CED1 100%);">
                            <div class="error-modal-icon"></div>
                            <div class="error-modal-title">Set 1 Complete!</div>
                        </div>
                        <div class="error-modal-body">
                            <p class="error-modal-message">
                                Congratulations! You've completed the first set of ${limits.perSet} tasks today.
                                <br><br>
                                <strong>To continue with Set 2 (${limits.perSet} more tasks), choose an option:</strong>
                            </p>
                            
                            <div class="error-modal-balance" style="background: linear-gradient(135deg, #334155 0%, #475569 100%); border: none;">
                                <div class="error-modal-balance-label" style="color: #00ACC1;">Progress Today</div>
                                <div class="error-modal-balance-amount" style="color: #00ACC1;">${limits.perSet}/${limits.total} Tasks </div>
                            </div>
                            
                            <div class="error-modal-buttons" style="flex-direction: column; gap: 12px;">
                                <button class="error-modal-btn error-modal-btn-primary" onclick="window.open('https://t.me/Expert_Team_RS', '_blank'); closeSetCompleteModal();" style="width: 100%; padding: 16px;">
                                     Contact Support to Reset Tasks
                                </button>
                                <button class="error-modal-btn" onclick="navigateTo('team'); closeSetCompleteModal();" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #f59e0b 0%, #00CED1 100%); color: white; border: none;">
                                     Upgrade Level to Continue
                                </button>
                                <button class="error-modal-btn error-modal-btn-secondary" onclick="closeSetCompleteModal()" style="width: 100%;">
                                    Later
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Registration Bonus Modal - Shown on first login after registration
        function renderRegistrationBonusModal() {
            if (!state.showRegistrationBonusModal) return '';
            
            const username = state.user?.username || 'User';
            
            return `
                <div class="error-modal-overlay" style="z-index: 10000;">
                    <div class="error-modal" onclick="event.stopPropagation()" style="max-width: 400px; overflow: hidden;">
                        <!-- Celebration Header with Animation -->
                        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%); padding: 30px 20px; text-align: center; position: relative; overflow: hidden;">
                            <!-- Confetti Animation Background -->
                            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; opacity: 0.3; background-image: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><circle cx=\"10\" cy=\"10\" r=\"2\" fill=\"gold\"/><circle cx=\"30\" cy=\"20\" r=\"3\" fill=\"white\"/><circle cx=\"50\" cy=\"15\" r=\"2\" fill=\"gold\"/><circle cx=\"70\" cy=\"25\" r=\"3\" fill=\"white\"/><circle cx=\"90\" cy=\"10\" r=\"2\" fill=\"gold\"/><circle cx=\"20\" cy=\"80\" r=\"3\" fill=\"white\"/><circle cx=\"40\" cy=\"90\" r=\"2\" fill=\"gold\"/><circle cx=\"60\" cy=\"85\" r=\"3\" fill=\"white\"/><circle cx=\"80\" cy=\"75\" r=\"2\" fill=\"gold\"/></svg>'); background-size: 50px;"></div>
                            
                            <!-- Trophy/Gift Icon -->
                            <div style="font-size: 60px; margin-bottom: 15px; animation: bounce 1s infinite; position: relative;"></div>
                            
                            <!-- Welcome Text -->
                            <h2 style="color: white; font-size: 22px; font-weight: bold; margin: 0 0 8px 0; text-shadow: 0 2px 4px rgba(0,0,0,0.2); position: relative;">
                                Welcome, ${username}!
                            </h2>
                            <p style="color: rgba(255,255,255,0.9); font-size: 14px; margin: 0; position: relative;">
                                Thank you for joining Orion Music!
                            </p>
                        </div>
                        
                        <!-- Bonus Amount -->
                        <div style="padding: 25px 20px; text-align: center; background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);">
                            <p style="color: #e2e8f0; font-size: 15px; margin: 0 0 15px 0;">
                                You have received a special
                            </p>
                            
                            <!-- Amount Box with Glow Effect -->
                            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 16px; padding: 20px 30px; display: inline-block; box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4), 0 0 40px rgba(16, 185, 129, 0.2); position: relative;">
                                <div style="position: absolute; top: -8px; left: 50%; transform: translateX(-50%); background: #fbbf24; color: #1e293b; font-size: 11px; font-weight: bold; padding: 4px 12px; border-radius: 20px;">
                                    REGISTRATION BONUS
                                </div>
                                <span style="color: white; font-size: 42px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                                    +$20.00
                                </span>
                            </div>
                            
                            <p style="color: #94a3b8; font-size: 13px; margin: 20px 0 0 0; line-height: 1.5;">
                                This bonus has been added to your wallet. <br>
                                Start completing tasks to earn more!
                            </p>
                        </div>
                        
                        <!-- Action Button -->
                        <div style="padding: 0 20px 25px 20px;">
                            <button onclick="closeRegistrationBonusModal()" style="
                                width: 100%;
                                padding: 16px;
                                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                                color: white;
                                border: none;
                                border-radius: 12px;
                                font-size: 16px;
                                font-weight: bold;
                                cursor: pointer;
                                box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
                                transition: all 0.3s ease;
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(16, 185, 129, 0.5)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(16, 185, 129, 0.4)';">
                                 Start Earning Now!
                            </button>
                        </div>
                    </div>
                </div>
                
                <style>
                    @keyframes bounce {
                        0%, 100% { transform: translateY(0); }
                        50% { transform: translateY(-10px); }
                    }
                </style>
            `;
        }

        async function closeRegistrationBonusModal() {
            state.showRegistrationBonusModal = false;
            render();
            
            // Mark as shown in backend
            try {
                await fetch(`${API_BASE_URL}/user/bonus-shown`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
            } catch (err) {
                console.error('Failed to mark bonus as shown:', err);
            }
        }

        // Global Popup Modal - For vouchers sent to all users
        function renderGlobalPopupModal() {
            if (!state.showGlobalPopupModal || !state.globalPopup) return '';
            
            const popup = state.globalPopup;
            
            return `
                <div class="error-modal-overlay" style="z-index: 10001;" onclick="dismissGlobalPopup()">
                    <div class="error-modal" onclick="event.stopPropagation()" style="max-width: 420px; overflow: hidden; border-radius: 20px;">
                        <!-- Header with Gradient -->
                        <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 25px 20px; text-align: center; position: relative;">
                            <!-- Close Button -->
                            <button onclick="dismissGlobalPopup()" style="position: absolute; top: 12px; right: 12px; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 32px; height: 32px; color: white; cursor: pointer; font-size: 18px;"></button>
                            
                            <!-- Celebration Icon -->
                            <div style="font-size: 50px; margin-bottom: 12px;"></div>
                            
                            <h2 style="color: white; font-size: 22px; font-weight: bold; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                                ${popup.title || 'Special Announcement!'}
                            </h2>
                        </div>
                        
                        <!-- Voucher Image (if present) -->
                        ${popup.image_path ? `
                            <div style="padding: 20px; text-align: center; background: #1e293b;">
                                <img src="${API_BASE_URL}${popup.image_path}" alt="Voucher" style="max-width: 100%; max-height: 250px; object-fit: contain; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                            </div>
                        ` : ''}
                        
                        <!-- Message -->
                        <div style="padding: 20px; text-align: center; background: #1e293b;">
                            <p style="color: #e2e8f0; font-size: 15px; line-height: 1.6; margin: 0;">
                                ${popup.message || ''}
                            </p>
                        </div>
                        
                        <!-- Action Button -->
                        <div style="padding: 0 20px 25px 20px; background: #1e293b;">
                            <button onclick="dismissGlobalPopup()" style="
                                width: 100%;
                                padding: 16px;
                                background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                                color: white;
                                border: none;
                                border-radius: 12px;
                                font-size: 16px;
                                font-weight: bold;
                                cursor: pointer;
                                box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
                                transition: all 0.3s ease;
                            " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                 Got it!
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Individual Popup Modal - For vouchers sent to specific user
        function renderIndividualPopupModal() {
            if (!state.showIndividualPopup || !state.individualPopup) return '';
            
            const popup = state.individualPopup;
            
            return `
                <div class="error-modal-overlay" style="z-index: 10002;" onclick="dismissIndividualPopup()">
                    <div class="error-modal" onclick="event.stopPropagation()" style="max-width: 420px; overflow: hidden; border-radius: 20px;">
                        <!-- Header with Gradient -->
                        <div style="background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%); padding: 25px 20px; text-align: center; position: relative;">
                            <!-- Close Button -->
                            <button onclick="dismissIndividualPopup()" style="position: absolute; top: 12px; right: 12px; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 32px; height: 32px; color: white; cursor: pointer; font-size: 18px;"></button>
                            
                            <!-- Gift Icon -->
                            <div style="font-size: 50px; margin-bottom: 12px;"></div>
                            
                            <h2 style="color: white; font-size: 22px; font-weight: bold; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                                ${popup.title || 'You Have a Gift!'}
                            </h2>
                        </div>
                        
                        <!-- Voucher Image (if present) -->
                        ${popup.image_path ? `
                            <div style="padding: 20px; text-align: center; background: #1e293b;">
                                <img src="${API_BASE_URL}${popup.image_path}" alt="Voucher" style="max-width: 100%; max-height: 250px; object-fit: contain; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                            </div>
                        ` : ''}
                        
                        <!-- Message -->
                        <div style="padding: 20px; text-align: center; background: #1e293b;">
                            <p style="color: #e2e8f0; font-size: 15px; line-height: 1.6; margin: 0;">
                                ${popup.message || ''}
                            </p>
                        </div>
                        
                        <!-- Action Button -->
                        <div style="padding: 0 20px 25px 20px; background: #1e293b;">
                            <button onclick="dismissIndividualPopup()" style="
                                width: 100%;
                                padding: 16px;
                                background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
                                color: white;
                                border: none;
                                border-radius: 12px;
                                font-size: 16px;
                                font-weight: bold;
                                cursor: pointer;
                                box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
                                transition: all 0.3s ease;
                            " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                 Claim Now!
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Terms Modal for Registration Page
        function showTermsModalFromRegister() {
            state.showTermsModal = true;
            render();
        }

        function closeTermsModal() {
            state.showTermsModal = false;
            render();
        }

        function renderTermsModal() {
            if (!state.showTermsModal) return '';
            
            return `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 10px;" onclick="closeTermsModal()">
                    <div style="background: #1e293b; border-radius: 20px; max-width: 600px; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
                        <!-- Header -->
                        <div style="background: linear-gradient(135deg, #fb923c 0%, #00CED1 100%); padding: 20px; text-align: center;">
                            <h2 style="color: white; font-size: 20px; font-weight: bold; margin: 0;"> Terms & Conditions</h2>
                        </div>
                        
                        <!-- Scrollable Content -->
                        <div style="flex: 1; overflow-y: auto; padding: 20px; max-height: 60vh;">
                            <div style="margin-bottom: 20px;">
                                <h3 style="font-size: 16px; font-weight: bold; color: #ffffff; margin-bottom: 12px;">Clause User Agreement</h3>
                                <p style="color: #94a3b8; line-height: 1.6; font-size: 14px;">
                                    These Terms and Conditions are governed by the following terminology and principles of interpretation. All users are required to adhere to the terms outlined by the platform. Any violations will result in corrective actions and penalties imposed by the platform.
                                </p>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <h4 style="font-weight: bold; color: #00CED1; margin-bottom: 10px;">1. Start to Submit Album Data</h4>
                                <ul style="color: #94a3b8; line-height: 1.6; padding-left: 18px; font-size: 14px;">
                                    <li style="margin-bottom: 6px;">1.1 A minimum account balance of 50 USD is required to initiate the first set of data submissions.</li>
                                    <li style="margin-bottom: 6px;">1.2 A minimum balance of 100 USD is required to reset and start a new data submission process.</li>
                                    <li style="margin-bottom: 6px;">1.3 Users must complete the current dataset before requesting a reset for the next set of submissions.</li>
                                </ul>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <h4 style="font-weight: bold; color: #00CED1; margin-bottom: 10px;">2. Data Submissions</h4>
                                <ul style="color: #94a3b8; line-height: 1.6; padding-left: 18px; font-size: 14px;">
                                    <li style="margin-bottom: 6px;">2.1 Each day users are required to submit 2 sets of data, with the set count depending on the user's level.</li>
                                    <li style="margin-bottom: 6px;">2.2 Submissions involve interaction with album data, with earnings accrued based on a formula determined by the user's level.</li>
                                    <li style="margin-bottom: 6px;">2.3 Users are bound to use their initial account balance to fund an album's cost before proceeding with data submission.</li>
                                </ul>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <h4 style="font-weight: bold; color: #00CED1; margin-bottom: 10px;">3. Data Processing</h4>
                                <ul style="color: #94a3b8; line-height: 1.6; padding-left: 18px; font-size: 14px;">
                                    <li style="margin-bottom: 6px;">3.1 Orion Music Platform will randomly generate albums with varying prices. Any profit and loss incurred from the user's account is solely the user's responsibility.</li>
                                    <li style="margin-bottom: 6px;">3.2 To avoid any loss of funds, all data processing will be handled by the system, not manually.</li>
                                </ul>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <h4 style="font-weight: bold; color: #00CED1; margin-bottom: 10px;">4. Withdrawals & Deposits</h4>
                                <ul style="color: #94a3b8; line-height: 1.6; padding-left: 18px; font-size: 14px;">
                                    <li style="margin-bottom: 6px;">4.1 All withdrawal requests must meet the minimum withdrawal amount requirement.</li>
                                    <li style="margin-bottom: 6px;">4.2 There is a limit of one withdrawal per user within a 24-hour window.</li>
                                    <li style="margin-bottom: 6px;">4.3 Withdrawal requests must be completed within operating hours.</li>
                                </ul>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <h4 style="font-weight: bold; color: #00CED1; margin-bottom: 10px;">5. Account Security</h4>
                                <ul style="color: #94a3b8; line-height: 1.6; padding-left: 18px; font-size: 14px;">
                                    <li style="margin-bottom: 6px;">5.1 Users are responsible for maintaining the confidentiality of their account credentials.</li>
                                    <li style="margin-bottom: 6px;">5.2 The platform is not liable for any unauthorized access resulting from user negligence.</li>
                                </ul>
                            </div>

                            <div style="background: #334155; padding: 12px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                <p style="color: #fbbf24; font-size: 13px; margin: 0;">
                                    <strong> Important:</strong> By registering, you acknowledge that you have read, understood, and agree to be bound by these Terms and Conditions.
                                </p>
                            </div>
                        </div>
                        
                        <!-- Footer -->
                        <div style="padding: 16px 20px; border-top: 1px solid #334155;">
                            <button onclick="closeTermsModal()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #fb923c 0%, #00CED1 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;">
                                I Understand
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTrackingModal() {
            if (!state.showTrackingModal) return '';
            
            return `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 10px;" onclick="state.showTrackingModal = false; render();">
                    <div style="background: #1e293b; border-radius: 20px; max-width: 700px; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
                        <!-- Header -->
                        <div style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); padding: 20px; text-align: center;">
                            <h2 style="color: white; font-size: 20px; font-weight: bold; margin: 0;"> Check-in Rules</h2>
                            <p style="color: rgba(255,255,255,0.9); font-size: 14px; margin: 8px 0 0 0;">Daily Check-in Rules & Reward System</p>
                        </div>
                        
                        <!-- Scrollable Content -->
                        <div style="flex: 1; overflow-y: auto; padding: 20px; max-height: 60vh;">
                            <!-- Section 1: Overview -->
                            <div style="margin-bottom: 24px;">
                                <h3 style="font-size: 16px; font-weight: bold; color: #fbbf24; margin-bottom: 12px; border-bottom: 2px solid #fbbf24; padding-bottom: 6px;">1. Check-in Overview</h3>
                                <p style="color: #94a3b8; line-height: 1.6; font-size: 14px;">
                                    Users can earn incremental rewards by signing in consecutively for 7 days. Each day's reward increases according to the schedule below, but users must complete at least <strong>two daily sets of assignments</strong> to qualify for that day's reward.
                                </p>
                            </div>

                            <!-- Section 2: Reward Schedule -->
                            <div style="margin-bottom: 24px;">
                                <h3 style="font-size: 16px; font-weight: bold; color: #fbbf24; margin-bottom: 12px; border-bottom: 2px solid #fbbf24; padding-bottom: 6px;">2. Reward Schedule</h3>
                                <div style="background: linear-gradient(135deg, #334155 0%, #475569 100%); border-radius: 12px; padding: 16px;">
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                        <div style="background: #1e293b; padding: 12px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                            <div style="font-size: 24px; margin-bottom: 4px;"></div>
                                            <div style="font-weight: bold; color: #fbbf24;">Day 1</div>
                                            <div style="color: #059669; font-weight: bold; font-size: 18px;">$10 USD</div>
                                        </div>
                                        <div style="background: #1e293b; padding: 12px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                            <div style="font-size: 24px; margin-bottom: 4px;"></div>
                                            <div style="font-weight: bold; color: #fbbf24;">Day 2</div>
                                            <div style="color: #059669; font-weight: bold; font-size: 18px;">$20 USD</div>
                                        </div>
                                        <div style="background: #1e293b; padding: 12px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                            <div style="font-size: 24px; margin-bottom: 4px;"></div>
                                            <div style="font-weight: bold; color: #fbbf24;">Day 3</div>
                                            <div style="color: #059669; font-weight: bold; font-size: 18px;">$40 USD</div>
                                        </div>
                                        <div style="background: #1e293b; padding: 12px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                            <div style="font-size: 24px; margin-bottom: 4px;"></div>
                                            <div style="font-weight: bold; color: #fbbf24;">Day 4</div>
                                            <div style="color: #059669; font-weight: bold; font-size: 18px;">$60 USD</div>
                                        </div>
                                        <div style="background: #1e293b; padding: 12px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                            <div style="font-size: 24px; margin-bottom: 4px;"></div>
                                            <div style="font-weight: bold; color: #fbbf24;">Day 5</div>
                                            <div style="color: #059669; font-weight: bold; font-size: 18px;">$80 USD</div>
                                        </div>
                                        <div style="background: #1e293b; padding: 12px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                            <div style="font-size: 24px; margin-bottom: 4px;"></div>
                                            <div style="font-weight: bold; color: #fbbf24;">Day 6</div>
                                            <div style="color: #059669; font-weight: bold; font-size: 18px;">$100 USD</div>
                                        </div>
                                    </div>
                                    <div style="background: #1e293b; padding: 16px; border-radius: 8px; text-align: center; margin-top: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <div style="font-size: 32px; margin-bottom: 4px;"></div>
                                        <div style="font-weight: bold; color: #fbbf24; font-size: 18px;">Day 7</div>
                                        <div style="color: #dc2626; font-weight: bold; font-size: 24px;">$200 USD</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Section 3: Check-in Requirements -->
                            <div style="margin-bottom: 24px;">
                                <h3 style="font-size: 16px; font-weight: bold; color: #fbbf24; margin-bottom: 12px; border-bottom: 2px solid #fbbf24; padding-bottom: 6px;">3. Check-in Requirements</h3>
                                
                                <div style="margin-bottom: 16px;">
                                    <h4 style="font-weight: bold; color: #f59e0b; margin-bottom: 8px; font-size: 15px;">Daily Eligibility:</h4>
                                    <p style="color: #94a3b8; line-height: 1.6; font-size: 14px; margin-bottom: 8px;">To claim the reward for a specific day, users must:</p>
                                    <ul style="color: #94a3b8; line-height: 1.6; padding-left: 18px; font-size: 14px;">
                                        <li style="margin-bottom: 6px;">Complete <strong>two sets</strong> within the same calendar day (9:00 am  9:59 pm CDT).</li>
                                        <li style="margin-bottom: 6px;">Sign in manually after completing the two sets of assignments.</li>
                                    </ul>
                                </div>

                                <div style="margin-bottom: 16px;">
                                    <h4 style="font-weight: bold; color: #f59e0b; margin-bottom: 8px; font-size: 15px;">Consecutive Streak:</h4>
                                    <p style="color: #94a3b8; line-height: 1.6; font-size: 14px; margin-bottom: 8px;">
                                        Rewards are cumulative and tied to unbroken consecutive days. <strong>Missing a day will reset progress to Day 1.</strong>
                                    </p>
                                    <div style="background: #334155; padding: 12px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                        <p style="color: #fbbf24; font-size: 13px; margin: 0;">
                                            <strong>Example:</strong> If a user completes Day 2 but fails to meet Day 3's requirements, they restart at Day 1 on the next attempt.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Section 4: Additional Terms -->
                            <div style="margin-bottom: 24px;">
                                <h3 style="font-size: 16px; font-weight: bold; color: #fbbf24; margin-bottom: 12px; border-bottom: 2px solid #fbbf24; padding-bottom: 6px;">4. Additional Terms</h3>
                                <ul style="color: #94a3b8; line-height: 1.6; padding-left: 18px; font-size: 14px;">
                                    <li style="margin-bottom: 8px;"><strong>Reward Redemption:</strong> Rewards are credited to the user's account balance immediately after successful check-in.</li>
                                    <li style="margin-bottom: 8px;"><strong>Progress Tracking:</strong> Users can view their current streak and upcoming rewards in their profile.</li>
                                    <li style="margin-bottom: 8px;"><strong>Streak Protection:</strong> No "make-up" days are allowed. Interruptions reset progress.</li>
                                </ul>
                            </div>

                            <!-- Section 5: Platform Rights -->
                            <div style="margin-bottom: 12px;">
                                <h3 style="font-size: 16px; font-weight: bold; color: #fbbf24; margin-bottom: 12px; border-bottom: 2px solid #fbbf24; padding-bottom: 6px;">5. Platform Rights</h3>
                                <div style="background: #451a1a; padding: 12px; border-radius: 8px; border-left: 4px solid #dc2626;">
                                    <ul style="color: #991b1b; line-height: 1.6; padding-left: 18px; font-size: 14px; margin: 0;">
                                        <li style="margin-bottom: 6px;">The platform reserves the right to modify rewards, requirements, or rules with prior notice.</li>
                                        <li>Suspicious activity may trigger account review or reward cancellation.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Footer -->
                        <div style="padding: 16px 20px; border-top: 1px solid #334155;">
                            <button onclick="state.showTrackingModal = false; render();" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;">
                                Got It
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPopup() {
            if (!state.currentPopup) return '';
            
            const popup = state.currentPopup;
            const isVoucher = !!(popup.image_path);
            
            return `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="event.target === event.currentTarget && handlePopupAction('reject')">
                    <div style="background: #1e293b; border-radius: 24px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
                        ${isVoucher ? `
                            <div style="position: relative; width: 100%; aspect-ratio: 16/9; overflow: hidden; border-radius: 24px 24px 0 0;">
                                <img src="${popup.image_path}" alt="${popup.title}" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                        ` : ''}
                        
                        <div style="padding: 24px;">
                            <h2 style="color: #ffffff; font-size: 24px; font-weight: bold; margin-bottom: 16px;">
                                ${isVoucher ? ' ' : ''}${popup.title}
                            </h2>
                            
                            <p style="color: #cbd5e1; line-height: 1.6; margin-bottom: 24px; font-size: 16px;">
                                ${popup.message || ''}
                            </p>
                            
                            ${popup.url ? `
                                <div style="margin-bottom: 24px;">
                                    <a href="${popup.url}" target="_blank" style="color: #00CED1; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;">
                                        View Details 
                                    </a>
                                </div>
                            ` : ''}
                            
                            <div style="display: flex; gap: 12px;">
                                <button onclick="handlePopupAction('claim')" style="flex: 1; padding: 14px; background: #00CED1; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.3s;" onmouseover="this.style.background='#00ACC1'" onmouseout="this.style.background='#00CED1'">
                                    ${isVoucher ? ' Claim Voucher' : ' Got it'}
                                </button>
                                <button onclick="handlePopupAction('reject')" style="flex: 0.4; padding: 14px; background: #1e293b; color: #94a3b8; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.3s;" onmouseover="this.style.background='#334155'" onmouseout="this.style.background='#1e293b'">
                                     Dismiss
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Render Functions
        function renderLogin() {
            return `
                <div class="auth-page">
                    <!-- Left Panel - Brand -->
                    <div class="auth-brand">
                        <div class="auth-brand-logo">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Orion Music
                        </div>
                        <h1>Elevate Your Music Career.</h1>
                        <p>Log in to access your dashboard and manage your music promotion campaigns.</p>
                    </div>
                    
                    <!-- Right Panel - Form -->
                    <div class="auth-form-panel">
                        <div class="auth-form-container">
                            <div class="auth-form-header">
                                <h2>Welcome back</h2>
                                <p>Please enter your details to sign in.</p>
                            </div>
                            
                            <form class="auth-form" onsubmit="handleLogin(event)">
                                <div class="field">
                                    <label for="username">Username <span class="req">*</span></label>
                                    <input type="text" id="username" placeholder="Enter your username" autocomplete="username" required>
                                </div>
                                
                                <div class="field field-password">
                                    <label for="password">Password <span class="req">*</span></label>
                                    <input type="${state.showPassword ? 'text' : 'password'}" id="password" placeholder="" autocomplete="current-password" required>
                                    <button type="button" class="toggle-pw" onclick="togglePassword()">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                            <circle cx="12" cy="12" r="3"></circle>
                                        </svg>
                                    </button>
                                </div>
                                
                                <div class="actions-row">
                                    <label>
                                        <input type="checkbox" id="rememberMe">
                                        Remember me
                                    </label>
                                    <button type="button" onclick="showModal('Forgot Password?', 'Please contact our customer support on Telegram to reset your password.', 'info', '${t('contactSupport')}', () => window.open('https://t.me/Expert_Team_RS', '_blank'))">Forgot password?</button>
                                </div>
                                
                                <button type="submit" class="submit-btn">Log In to Dashboard</button>
                            </form>
                            
                            <div class="auth-form-footer">
                                Don't have an account? <button type="button" onclick="navigateTo('register')">Create free account</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHome() {
            const user = state.user || {};
            
            return `
                <div class="page">
                    <div class="header">
                        <h1> ORION</h1>
                        <button class="menu-btn" onclick="toggleMenu()"></button>
                    </div>

                    <!-- Creative Banner - Orion Style -->
                    <div style="background: linear-gradient(135deg, #1e293b 0%, #0d0d1a 100%); padding: 30px 20px; border-bottom: 2px solid rgba(0, 206, 209, 0.3);">
                        <div style="display: flex; align-items: flex-start; justify-content: space-between;">
                            <div>
                                <h2 style="font-size: 32px; font-weight: 800; color: #ffffff; line-height: 1.1; margin-bottom: 12px;">BETTER<br>CREATIVE</h2>
                                <p style="color: rgba(255,255,255,0.7); font-size: 13px; line-height: 1.5; max-width: 280px;"><span style="color: #00CED1; font-weight: 600;">Creative improves</span> with collaboration, because you know both communication strategy and the placement opportunities and limitations</p>
                            </div>
                            <div style="font-size: 48px; opacity: 0.8;"></div>
                        </div>
                    </div>

                    <!-- Marquee Notification -->
                    <div style="background: rgba(0, 206, 209, 0.1); padding: 10px 16px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid rgba(0, 206, 209, 0.2);">
                        <span style="font-size: 16px;"></span>
                        <div style="flex: 1; overflow: hidden;">
                            <div style="white-space: nowrap; animation: marquee 20s linear infinite; color: #00CED1; font-size: 13px;">
                                Welcome to Orion! Complete your daily assignments to earn rewards. Contact support for any assistance. New promotions available - check the Events section!
                            </div>
                        </div>
                    </div>
                    <style>
                        @keyframes marquee {
                            0% { transform: translateX(100%); }
                            100% { transform: translateX(-100%); }
                        }
                    </style>

                    <!-- Welcome Section -->
                    <div style="padding: 20px; background: linear-gradient(135deg, #1e293b 0%, #334155 100%);">
                        <h3 style="color: #ffffff; font-size: 18px; margin-bottom: 8px;">Hi, Welcome</h3>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="color: #00CED1; font-weight: 600; font-size: 16px;">${user.username || 'User'}</span>
                            <img src="${API_BASE_URL}/level-icons/${user.level || 1}" alt="Level" style="height: 24px; width: 24px; object-fit: contain;" onerror="this.innerHTML=''">
                        </div>
                    </div>

                    <!-- Quick Actions Scroll -->
                    <div style="padding: 16px; overflow-x: auto; white-space: nowrap; background: #0f172a;">
                        <button onclick="state.showTrackingModal = true; render();" style="display: inline-flex; flex-direction: column; align-items: center; background: linear-gradient(135deg, #e0f7ff 0%, #b3ecff 100%); border: 1px solid #00d4ff; color: #0099cc; padding: 12px 16px; border-radius: 12px; min-width: 80px; margin-right: 10px; cursor: pointer;">
                            <span style="font-size: 20px; margin-bottom: 4px;"></span>
                            <span style="font-size: 11px; font-weight: 600;">TRACKING</span>
                        </button>
                        <button onclick="navigateTo('support')" style="display: inline-flex; flex-direction: column; align-items: center; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border: 1px solid rgba(255,255,255,0.1); color: #00CED1; padding: 12px 16px; border-radius: 12px; min-width: 80px; margin-right: 10px; cursor: pointer;">
                            <span style="font-size: 20px; margin-bottom: 4px;"></span>
                            <span style="font-size: 11px; font-weight: 600;">SUPPORT</span>
                        </button>
                        <button onclick="navigateTo('userEvents')" style="display: inline-flex; flex-direction: column; align-items: center; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border: 1px solid rgba(255,255,255,0.1); color: #00CED1; padding: 12px 16px; border-radius: 12px; min-width: 80px; margin-right: 10px; cursor: pointer;">
                            <span style="font-size: 20px; margin-bottom: 4px;"></span>
                            <span style="font-size: 11px; font-weight: 600;">EVENTS</span>
                        </button>
                        <button onclick="navigateTo('terms')" style="display: inline-flex; flex-direction: column; align-items: center; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border: 1px solid rgba(255,255,255,0.1); color: #00CED1; padding: 12px 16px; border-radius: 12px; min-width: 80px; margin-right: 10px; cursor: pointer;">
                            <span style="font-size: 20px; margin-bottom: 4px;"></span>
                            <span style="font-size: 11px; font-weight: 600;">TERMS</span>
                        </button>
                        <button onclick="navigateTo('services')" style="display: inline-flex; flex-direction: column; align-items: center; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border: 1px solid rgba(255,255,255,0.1); color: #00CED1; padding: 12px 16px; border-radius: 12px; min-width: 80px; margin-right: 10px; cursor: pointer;">
                            <span style="font-size: 20px; margin-bottom: 4px;"></span>
                            <span style="font-size: 11px; font-weight: 600;">ABOUT</span>
                        </button>
                    </div>

                    <div class="section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 class="section-title" style="margin: 0;">${t('employeeLevel')}</h3>
                            <span class="view-more">${t('viewMore')}</span>
                        </div>
                        
                        <div class="vip-scroll">
                            ${vipLevels.map((vip, idx) => {
                                const vipLevelNum = idx + 1;
                                const badgeImg = `${API_BASE_URL}/level-icons/${vipLevelNum}`;
                                return `
                                <div class="vip-card">
                                    <div class="vip-header">
                                        <div>
                                            <div style="font-size: 14px; opacity: 0.8;">${t('orionMusic')}</div>
                                            <div class="vip-level">${vip.level} <img src='${API_BASE_URL}/level-icons/${vipLevelNum}' alt='VIP${vipLevelNum}' style='height:32px;width:32px;vertical-align:middle;margin-left:4px;object-fit:contain;' onerror="this.style.display='none'"></div>
                                        </div>
                                    </div>
                                    <div class="vip-detail"><span></span><span>${vip.description}</span></div>
                                    <div class="vip-detail"><span></span><span>${t('profitOf')} ${vip.profit}</span></div>
                                    <div class="vip-detail"><span></span><span>${vip.ratings} ${t('ratings')}</span></div>
                                    <div class="vip-detail"><span></span><span>${vip.sets} ${t('sets')}</span></div>
                                    <div class="vip-detail"><span></span><span>${vip.access} ${t('access')}</span></div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Enhanced Promo Section - Music Solutions -->
                    <div class="section" style="padding: 20px;">
                        <div style="text-align: center; margin-bottom: 24px;">
                            <h2 style="font-size: 20px; font-weight: bold; color: #ffffff; margin-bottom: 8px;">We create proven solutions for all your music needs</h2>
                            <div style="width: 60px; height: 3px; background: linear-gradient(90deg, #00CED1, #00ACC1); margin: 0 auto; border-radius: 2px;"></div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr; gap: 16px; margin-bottom: 24px;">
                            <!-- Card 1 -->
                            <div class="feature-card animate-on-scroll" data-delay="0" style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 16px; padding: 20px; border: 1px solid rgba(0, 206, 209, 0.2); position: relative; overflow: hidden;">
                                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #00CED1, #00ACC1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 12px;">
                                    <span style="font-size: 24px;"></span>
                                </div>
                                <h3 style="color: #ffffff; font-size: 16px; font-weight: 600; margin-bottom: 8px;">Forefront of music rights management</h3>
                                <p style="color: #9ca3af; font-size: 14px; line-height: 1.5;">Leading the field in client services, technology, and rights advocacy.</p>
                            </div>
                            
                            <!-- Card 2 -->
                            <div class="feature-card animate-on-scroll" data-delay="150" style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 16px; padding: 20px; border: 1px solid rgba(0, 206, 209, 0.2); position: relative; overflow: hidden;">
                                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #00CED1, #00ACC1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 12px;">
                                    <span style="font-size: 24px;"></span>
                                </div>
                                <h3 style="color: #ffffff; font-size: 16px; font-weight: 600; margin-bottom: 8px;">Bridge between songwriters and businesses</h3>
                                <p style="color: #9ca3af; font-size: 14px; line-height: 1.5;">We offer songwriters exceptional analytics and robust data solutions.</p>
                            </div>
                            
                            <!-- Card 3 -->
                            <div class="feature-card animate-on-scroll" data-delay="300" style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 16px; padding: 20px; border: 1px solid rgba(0, 206, 209, 0.2); position: relative; overflow: hidden;">
                                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #00CED1, #00ACC1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 12px;">
                                    <span style="font-size: 24px;"></span>
                                </div>
                                <h3 style="color: #ffffff; font-size: 16px; font-weight: 600; margin-bottom: 8px;">Global reach and worldwide solution</h3>
                                <p style="color: #9ca3af; font-size: 14px; line-height: 1.5;">Worldwide solution to performing rights licensing needs.</p>
                            </div>
                        </div>
                        
                        <!-- Statistics -->
                        <div class="animate-on-scroll" data-delay="450" style="display: flex; justify-content: space-around; background: linear-gradient(135deg, rgba(0, 206, 209, 0.1) 0%, rgba(234, 88, 12, 0.1) 100%); border-radius: 16px; padding: 20px; border: 1px solid rgba(0, 206, 209, 0.3);">
                            <div style="text-align: center;">
                                <div class="counter" data-target="50" style="font-size: 24px; font-weight: bold; color: #00CED1;">0K+</div>
                                <div style="font-size: 12px; color: #9ca3af;">Active Users</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="counter" data-target="1000" style="font-size: 24px; font-weight: bold; color: #00CED1;">0M+</div>
                                <div style="font-size: 12px; color: #9ca3af;">Songs Promoted</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="counter" data-target="150" style="font-size: 24px; font-weight: bold; color: #00CED1;">0+</div>
                                <div style="font-size: 12px; color: #9ca3af;">Countries</div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center text-muted" style="padding: 16px;">
                         2025 - OrionPromotion. ALL RIGHTS RESERVED
                    </div>

                    ${renderBottomNav()}
                    ${state.menuOpen ? renderSideMenu() : ''}
                </div>
            `;
        }

        function renderOptimization() {
            const user = state.user || {};
            const dashboard = state.dashboard || {};
            
            // Handle both balance and wallet_balance property names
            const balance = user.balance || user.wallet_balance || 0;
            const commissionEarned = user.commission_earned || 0;
            const completedToday = state.completedToday || 0;
            const profilePicture = user.profile_picture || null;
            
            
            // Default view with grid - popup is used for product display
            return `
                <div class="page" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);">
                    <div class="content-box">
                        <div class="profile-header">
                            <div class="profile-avatar" style="overflow: hidden;">
                                ${profilePicture 
                                    ? `<img src="${profilePicture}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">` 
                                    : ''
                                }
                            </div>
                            <div style="color: white;">
                                <div>${t('hiUser')} ${user.username || 'User'} </div>
                            </div>
                            <div class="profile-badge">${getVipLevelName(user.level || 1)}</div>
                        </div>

                        <!-- Stats Container - Today's Profit, Balance, Pending Balance -->
                        ${(() => {
                            // Calculate pending balance (for negative balance products)
                            // Pending Balance = what user's account balance will become AFTER submitting the product
                            const balanceBeforeNegative = user.balance_before_negative || 0;
                            const negativeTriggerAmount = user.negative_trigger_amount || 0;
                            const hasPendingNegative = user.negative_balance_triggered === 1 || user.pending_balance_restoration === 1;
                            
                            // Use actual commission rate from dashboard based on user's level
                            const commissionRate = state.dashboard?.commissionRate || 0.05;
                            
                            // Pending balance = originalBalance + (originalBalance + negativeAmount)  commissionRate  10
                            // This is the exact formula used in backend when restoring balance
                            let pendingBalance = 0;
                            if (hasPendingNegative && balanceBeforeNegative > 0) {
                                const bonusCommission = (balanceBeforeNegative + negativeTriggerAmount) * commissionRate * 10;
                                pendingBalance = balanceBeforeNegative + bonusCommission;
                            }
                            
                            return `
                                <div style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1);">
                                    <!-- Today's Profit -->
                                    <div style="display: flex; align-items: center; margin-bottom: 16px;">
                                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                            <span style="font-size: 20px;"></span>
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="color: #9ca3af; font-size: 13px;">Today's Profit</div>
                                            <div style="color: #22c55e; font-size: 22px; font-weight: bold;">USD ${commissionEarned.toFixed(2)}</div>
                                        </div>
                                    </div>
                                    
                                    <div style="font-size: 12px; color: #94a3b8; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                        Daily profits will be updated automatically every 24 hours
                                        <span style="float: right;">Number of resets today: 0</span>
                                    </div>
                                    
                                    <!-- Balance and Pending Balance Row -->
                                    <div style="display: flex; gap: 16px;">
                                        <!-- Balance -->
                                        <div style="flex: 1; background: ${balance < 0 ? 'linear-gradient(135deg, rgba(220,38,38,0.2) 0%, rgba(185,28,28,0.2) 100%)' : 'rgba(0,0,0,0.3)'}; border-radius: 12px; padding: 16px; ${balance < 0 ? 'border: 1px solid rgba(220,38,38,0.5);' : ''}">
                                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                                <span style="font-size: 18px; margin-right: 8px;">${balance < 0 ? '' : ''}</span>
                                                <span style="color: ${balance < 0 ? '#ef4444' : '#9ca3af'}; font-size: 13px;">${t('walletBalance')}</span>
                                            </div>
                                            <div style="color: ${balance < 0 ? '#ef4444' : '#38bdf8'}; font-size: 18px; font-weight: bold; margin-bottom: 6px;">
                                                USD ${balance < 0 ? '-' + Math.abs(balance).toFixed(2) : balance.toFixed(2)}
                                            </div>
                                            <div style="color: ${balance < 0 ? '#ef4444' : '#6b7280'}; font-size: 11px; line-height: 1.4;">
                                                ${balance < 0 ? t('depositRequired') : t('profitsAdded')}
                                            </div>
                                        </div>
                                        
                                        <!-- Pending Balance -->
                                        <div style="flex: 1; background: ${pendingBalance > 0 ? 'linear-gradient(135deg, rgba(34,197,94,0.2) 0%, rgba(22,163,74,0.2) 100%)' : 'rgba(0,0,0,0.3)'}; border-radius: 12px; padding: 16px; ${pendingBalance > 0 ? 'border: 1px solid rgba(34,197,94,0.5);' : ''}">
                                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                                <span style="font-size: 18px; margin-right: 8px;">${pendingBalance > 0 ? '' : ''}</span>
                                                <span style="color: ${pendingBalance > 0 ? '#22c55e' : '#9ca3af'}; font-size: 13px;">Pending Balance</span>
                                            </div>
                                            <div style="color: ${pendingBalance > 0 ? '#22c55e' : '#38bdf8'}; font-size: 18px; font-weight: bold; margin-bottom: 6px;">
                                                USD ${pendingBalance.toFixed(2)}
                                            </div>
                                            <div style="color: ${pendingBalance > 0 ? '#22c55e' : '#6b7280'}; font-size: 11px; line-height: 1.4;">
                                                ${pendingBalance > 0 
                                                    ? 'Balance after submitting high-value order' 
                                                    : 'No pending high-value order'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        })()}

                        <div style="margin-bottom: 24px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; color: white; margin-bottom: 16px;">
                                <div>
                                    <h3 style="font-size: 20px; font-weight: bold;">${t('pressStart')}</h3>
                                    <span style="font-size: 14px; opacity: 0.9;">${t('set')} ${state.currentSet || 1}</span>
                                </div>
                                <div style="text-align: right;">
                                    <span style="font-size: 24px; font-weight: bold;">${(() => {
                                        const limits = getTaskLimitsForLevel(user.level || 1);
                                        // When admin resets to Set 2, tasks_completed_today is reset to 0 and only counts Set 2 tasks
                                        // So for Set 2, use tasks_completed_today directly (no subtraction needed)
                                        const tasksInCurrentSet = state.tasksCompletedToday || 0;
                                        return Math.max(0, tasksInCurrentSet) + '/' + limits.perSet;
                                    })()}</span>
                                </div>
                            </div>

                            <div class="white-box">
                                <div class="opt-grid">
                                    ${Array(9).fill(0).map((_, idx) => {
                                        if (idx === 4) {
                                            return `<div class=\"opt-cell center\" onclick=\"loadAssignedProducts(); render();\">${state.loadingProducts ? '' : 'Start'}</div>`;
                                        }
                                        const imgIndex = (state.currentAppIndex + idx) % (state.productImages.length || 1);
                                        const product = state.productImages[imgIndex];
                                        if (product && product.image_path) {
                                            return `<div class="opt-cell" style="padding: 0; overflow: hidden;"><img src="${product.image_path}" alt="${product.name || 'Product'}" style="width: 100%; height: 100%; object-fit: cover;"></div>`;
                                        }
                                        return `<div class="opt-cell" style="background: #1e293b;"></div>`;
                                    }).join('')}
                                </div>
                            </div>
                        </div>

                        <div class="white-box" style="color: #ffffff;">
                            <h4 style="font-weight: bold; font-size: 18px; margin-bottom: 8px;">Notice</h4>
                            <p style="font-size: 14px;">Online Support Hours: 10:00AM - 11:00PM</p>
                            <p style="font-size: 14px; color: #94a3b8; margin-top: 8px;">
                                Please complete tasks during working hours for immediate assistance
                            </p>
                        </div>
                    </div>
                    ${renderBottomNav('optimization')}
                </div>
            `;
        }

        function renderBottomNav(activePage = 'home') {
            return `
                <div class="bottom-nav">
                    <button class="nav-btn" onclick="navigateTo('home')">
                        <span style="font-size: 24px;"></span>
                        <span style="font-size: 10px;">${t('home')}</span>
                    </button>
                    <button class="nav-btn-center" onclick="navigateTo('optimization')">
                        ${activePage === 'optimization' ? t('starting') : t('orionMusic')}
                    </button>
                    <button class="nav-btn" onclick="navigateTo('records')">
                        <span style="font-size: 24px;"></span>
                        <span style="font-size: 10px;">${t('records')}</span>
                    </button>
                </div>
            `;
        }

        function renderSideMenu() {
            // Languages dropdown state
            if (typeof state.languagesDropdownOpen === 'undefined') state.languagesDropdownOpen = false;
            const languages = [
                { name: 'English', icon: '' },
                { name: 'Espanol', icon: '' },
                { name: 'Francais', icon: '' },
                { name: 'Svenska', icon: '' },
                { name: 'Italiano', icon: '' },
                { name: 'Deutsch', icon: '' },
                { name: 'Nork', icon: '' }
            ];
            return `
                <div class="side-menu-overlay" onclick="toggleMenu()">
                    <div class="side-menu" onclick="event.stopPropagation()" style="max-height: 100vh; overflow-y: auto; overscroll-behavior: contain;">
                        <h3>${t('menu')}</h3>
                        <button onclick="navigateTo('services')">
                            <span style="font-size: 20px;"></span>
                            <span>${t('services')}</span>
                        </button>
                        <button onclick="navigateTo('terms')">
                            <span style="font-size: 20px;"></span>
                            <span>${t('terms')}</span>
                        </button>
                        <button onclick="navigateTo('userEvents')">
                            <span style="font-size: 20px;"></span>
                            <span>${t('events')}</span>
                        </button>
                        <button onclick="navigateTo('luckyDraw')">
                            <span style="font-size: 20px;"></span>
                            <span>Lucky Draw</span>
                        </button>
                        <button onclick="navigateTo('withdraw')">
                            <span style="font-size: 20px;"></span>
                            <span>${t('withdraw')}</span>
                        </button>
                        <button onclick="navigateTo('deposit')">
                            <span style="font-size: 20px;"></span>
                            <span>${t('deposit')}</span>
                        </button>
                        <button onclick="navigateTo('mycenter')">
                            <span style="font-size: 20px;"></span>
                            <span>${t('myCenter')}</span>
                        </button>
                        <button onclick="navigateTo('home')">
                            <span style="font-size: 20px;"></span>
                            <span>${t('home')}</span>
                        </button>
                        <div style="position: relative;">
                            <button id="languages-menu-btn" onclick="state.languagesDropdownOpen = !state.languagesDropdownOpen; render();" style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 20px;"></span>
                                <span>${t('languages')}</span>
                                <span style="margin-left:auto; font-size: 16px;">${state.languagesDropdownOpen ? '' : ''}</span>
                            </button>
                            <div id="languages-dropdown" style="${state.languagesDropdownOpen ? 'display:block;' : 'display:none;'} position: absolute; left: 0; right: 0; background: #1e293b; border: 1px solid #00CED1; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,206,209,0.08); margin-top: 4px; z-index: 10;">
                                ${languages.map(lang => `
                                    <div style="padding: 12px 20px; display: flex; align-items: center; gap: 12px; cursor: pointer; font-size: 16px; transition: background 0.2s;" onmouseover="this.style.background='#ffedd5'" onmouseout="this.style.background='#fff'" onclick="changeLanguage('${lang.name}')">
                                        <span style="font-size: 20px;">${lang.icon}</span>
                                        <span>${lang.name}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <button onclick="window.open('https://t.me/Expert_Team_RS', '_blank')">
                            <span style="font-size: 20px;"></span>
                            <span>${t('support')}</span>
                        </button>
                        <button onclick="state.showTrackingModal = true; render();" style="background: linear-gradient(135deg, #334155 0%, #475569 100%); border-color: #f59e0b; color: #fbbf24;">
                            <span style="font-size: 20px;"></span>
                            <span>Tracking</span>
                        </button>
                        <button onclick="logout()" style="background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%); border-color: #dc2626; color: #dc2626;">
                            <span style="font-size: 20px;"></span>
                            <span>${t('logout')}</span>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderMyCenter() {
            const user = state.user || {};
            const dashboard = state.dashboard || {};
            
            // Handle property names
            const balance = user.balance || user.wallet_balance || 0;
            const totalCommission = user.commission_earned || 0;
            // Prefer invite_code (new format RS...) over invitation_code (old format INV...)
            const invitationCode = user.invite_code || user.invitation_code || user.invitationCode || 'N/A';
            const creditScore = user.credit_score || 100;
            const profilePicture = user.profile_picture || null;
            
            // Level-based star color
            const levelColors = {
                1: '#808080', // Grey
                2: '#c0c0c0', // Silver
                3: '#b08d57', // Bronze
                4: '#10b981', // Emerald Green
                5: '#ffd700'  // Gold
            };
            const userLevel = user.level || 1;
            const starColor = levelColors[userLevel] || '#ffd700';
            const fullStars = userLevel;
            const emptyStars = 5 - fullStars;
            // Badge image for user level
            const badgeImg = `${API_BASE_URL}/level-icons/${userLevel}`;

            return `
                <div class="page" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);">
                    <div class="header" style="background: transparent;">
                        <button class="back-btn" onclick="navigateTo('home')"></button>
                        <h1>My Center</h1>
                        <div style="width: 24px;"></div>
                    </div>

                    <div class="content-box">
                        <div class="profile-card" style="margin-bottom: 24px;">
                            <div class="profile-header-flex">
                                <div class="profile-header-main" style="display: flex; align-items: center; gap: 16px;">
                                    <div class="profile-avatar" style="position: relative; cursor: pointer; overflow: hidden;" onclick="document.getElementById('profilePictureInput').click()">
                                        ${profilePicture 
                                            ? `<img src=\"${profilePicture}\" alt=\"Profile\" style=\"width: 100%; height: 100%; object-fit: cover; border-radius: 50%;\">` 
                                            : ''
                                        }
                                        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); color: white; font-size: 10px; text-align: center; padding: 2px;"></div>
                                    </div>
                                    <input type="file" id="profilePictureInput" accept="image/*" style="display: none;" onchange="handleProfilePictureUpload(event)">
                                    <div style="flex: 1;">
                                        <div class="profile-username-stars">${user.username || 'User'}</div>
                                        <div style="font-size: 14px; opacity: 0.8; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                            Invitation Code: <span id="invitationCodeText" style="font-weight: 600;">${invitationCode}</span>
                                            <button onclick="copyInvitationCode('${invitationCode}')" style="background: rgba(255,255,255,0.3); border: none; padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 12px; color: white;"> Copy</button>
                                        </div>
                                    </div>
                                    <div style="width: 64px; height: 64px; display: flex; align-items: center; justify-content: center;">
                                        <img src='${API_BASE_URL}/level-icons/${userLevel}' alt='Level ${userLevel}' style='width: 100%; height: 100%; object-fit: contain;' onerror="this.parentElement.innerHTML='<span style=\\'font-size:32px;\\'></span>'">
                                    </div>
                                </div>
                                <div class="profile-diamond"></div>
                            </div>

                            <div style="margin-bottom: 16px;">
                                <div style="font-size: 14px; opacity: 0.8; margin-bottom: 8px;">Credit Score:</div>
                                <div class="credit-bar">
                                    <div class="credit-fill" style="width: ${creditScore}%"></div>
                                </div>
                                <div style="text-align: right; font-size: 14px;">${creditScore}%</div>
                            </div>

                            <div class="stats-grid">
                                <div>
                                    <div style="font-size: 14px; opacity: 0.8;">Total Amount</div>
                                    <div style="font-size: 20px; font-weight: bold;">${balance.toFixed(2)} USD</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 14px; opacity: 0.8;">Total Commission</div>
                                    <div style="font-size: 20px; font-weight: bold;">${totalCommission.toFixed(2)} USD</div>
                                </div>
                            </div>
                        </div>

                        <div class="white-box">
                            <h3 style="font-weight: bold; font-size: 18px; margin-bottom: 16px;">My Financial</h3>
                            <div class="list-item" onclick="navigateTo('deposit')">
                                <div class="list-item-left">
                                    <div class="list-icon" style="background: #334155; color: #00CED1;"></div>
                                    <span style="font-weight: 600;">Deposit</span>
                                </div>
                                <span style="color: #9ca3af;"></span>
                            </div>
                            <div class="list-item" onclick="navigateTo('withdraw')">
                                <div class="list-item-left">
                                    <div class="list-icon" style="background: #334155; color: #00CED1;"></div>
                                    <span style="font-weight: 600;">Withdraw</span>
                                </div>
                                <span style="color: #9ca3af;"></span>
                            </div>
                        </div>

                        <div class="white-box">
                            <h3 style="font-weight: bold; font-size: 18px; margin-bottom: 16px;">My Detail</h3>
                            <div class="list-item" onclick="navigateTo('loginPassword')">
                                <div class="list-item-left">
                                    <div class="list-icon" style="background: #334155; color: #00CED1;"></div>
                                    <span style="font-weight: 600;">Login Password</span>
                                </div>
                                <span style="color: #9ca3af;"></span>
                            </div>
                            <div class="list-item" onclick="navigateTo('withdrawPassword')">
                                <div class="list-item-left">
                                    <div class="list-icon" style="background: #334155; color: #00CED1;"></div>
                                    <span style="font-weight: 600;">Withdraw Password</span>
                                </div>
                                <span style="color: #9ca3af;"></span>
                            </div>
                            <div class="list-item" onclick="navigateTo('paymentMethods')">
                                <div class="list-item-left">
                                    <div class="list-icon" style="background: #334155; color: #00CED1;"></div>
                                    <span style="font-weight: 600;">Payment Methods</span>
                                </div>
                                <span style="color: #9ca3af;"></span>
                            </div>
                        </div>

                        <div class="white-box">
                            <h3 style="font-weight: bold; font-size: 18px; margin-bottom: 16px;">Other</h3>
                            <div class="list-item" onclick="window.open('https://t.me/Expert_Team_RS', '_blank')">
                                <div class="list-item-left">
                                    <div class="list-icon" style="background: #334155; color: #00CED1;"></div>
                                    <span style="font-weight: 600;">Contact Us</span>
                                </div>
                                <span style="color: #9ca3af;"></span>
                            </div>
                            <div class="list-item" onclick="navigateTo('notifications')">
                                <div class="list-item-left">
                                    <div class="list-icon" style="background: #334155; color: #00CED1;"></div>
                                    <span style="font-weight: 600;">Notifications</span>
                                </div>
                                <span style="color: #9ca3af;"></span>
                            </div>
                        </div>

                        <button class="btn" onclick="logout()" style="margin-top: 20px;">Logout</button>
                    </div>
                </div>
            `;
        }

        function renderDeposit() {
            const user = state.user || {};
            const balance = user.balance || user.wallet_balance || 0;
            const isHistoryTab = state.depositTab === 'history';
            
            return `
                <div class="page" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);">
                    <div class="header" style="background: transparent;">
                        <button class="back-btn" onclick="navigateTo('mycenter')"></button>
                        <h1>Deposit</h1>
                        <div style="width: 24px;"></div>
                    </div>

                    <div class="content-box">
                        <div class="tabs">
                            <button class="tab ${!isHistoryTab ? 'active' : 'inactive'}" onclick="state.depositTab = 'deposit'; render();" style="${isHistoryTab ? 'color: #9ca3af;' : ''}">Deposit</button>
                            <button class="tab ${isHistoryTab ? 'active' : 'inactive'}" onclick="state.depositTab = 'history'; loadDepositHistory(); render();" style="${!isHistoryTab ? 'color: #9ca3af;' : ''}">History</button>
                        </div>

                        ${!isHistoryTab ? `
                        <div class="profile-card" style="margin-bottom: 24px;">
                            <div style="font-size: 14px; opacity: 0.8; margin-bottom: 8px;">Account Amount</div>
                            <div style="font-size: 48px; font-weight: bold;">${balance.toFixed(2)} <span style="font-size: 24px;">USD</span></div>
                        </div>

                        <button class="btn" onclick="window.open('https://t.me/Expert_Team_RS', '_blank')" style="background: #00CED1; font-size: 18px; padding: 16px;">
                            Contact Customer Service
                        </button>
                        ` : `
                        <div style="margin-top: 16px;">
                            ${state.depositHistory.length === 0 ? `
                                <div class="white-box" style="text-align: center; padding: 40px 20px;">
                                    <div style="font-size: 48px; margin-bottom: 16px;"></div>
                                    <p style="color: #94a3b8; font-size: 16px;">No deposit history</p>
                                    <p style="color: #9ca3af; font-size: 14px; margin-top: 8px;">Your deposits will appear here</p>
                                </div>
                            ` : state.depositHistory.map(d => `
                                <div class="white-box" style="margin-bottom: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div style="font-size: 24px; font-weight: bold; color: #059669;">+$${(d.amount || 0).toFixed(2)}</div>
                                        <span style="background: #064e3b; color: #34d399; padding: 6px 14px; border-radius: 12px; font-size: 13px; font-weight: 600;">
                                             Completed
                                        </span>
                                    </div>
                                    <div style="font-size: 13px; color: #94a3b8; margin-bottom: 4px;">
                                        ${d.description || 'Deposit'}
                                    </div>
                                    <div style="font-size: 12px; color: #9ca3af;">
                                        ${new Date(d.created_at).toLocaleString()}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderWithdraw() {
            const user = state.user || {};
            const balance = user.balance || user.wallet_balance || 0;
            const commissionEarned = user.commission_earned || 0;
            const isHistoryTab = state.withdrawTab === 'history';
            const savedType = user.withdraw_type || '';
            const savedAddress = user.saved_wallet_address || '';
            
            return `
                <div class="page" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);">
                    <div class="header" style="background: transparent;">
                        <button class="back-btn" onclick="navigateTo('mycenter')"></button>
                        <h1>Withdraw</h1>
                        <div style="width: 24px;"></div>
                    </div>

                    <div class="content-box">
                        <div class="tabs">
                            <button class="tab ${!isHistoryTab ? 'active' : 'inactive'}" onclick="state.withdrawTab = 'withdraw'; render();" style="${isHistoryTab ? 'color: #9ca3af;' : ''}">Withdraw</button>
                            <button class="tab ${isHistoryTab ? 'active' : 'inactive'}" onclick="state.withdrawTab = 'history'; loadWithdrawalHistory(); render();" style="${!isHistoryTab ? 'color: #9ca3af;' : ''}">History</button>
                        </div>

                        ${!isHistoryTab ? `
                        <div class="profile-card" style="margin-bottom: 24px;">
                            <div style="font-size: 14px; opacity: 0.8; margin-bottom: 8px;">Available to Withdraw (Commission Earned)</div>
                            <div style="font-size: 48px; font-weight: bold; margin-bottom: 16px;">${commissionEarned.toFixed(2)} <span style="font-size: 24px;">USD</span></div>
                            <div style="font-size: 14px; opacity: 0.9;">You will receive your withdraw within an hour</div>
                        </div>

                        <div class="white-box" style="margin-bottom: 20px;">
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; color: #e2e8f0; font-weight: 700; margin-bottom: 8px; font-size: 16px;">Withdraw Type</label>
                                <select id="withdrawTypeSelect" style="width: 100%; padding: 14px 16px; border: 2px solid #475569; border-radius: 12px; font-size: 16px; outline: none; background: #1e293b; cursor: pointer;">
                                    <option value="" ${!savedType ? 'selected' : ''}>-- Select Cryptocurrency --</option>
                                    <option value="BTC" ${savedType === 'BTC' ? 'selected' : ''}>Bitcoin (BTC)</option>
                                    <option value="LTC" ${savedType === 'LTC' ? 'selected' : ''}>Litecoin (LTC)</option>
                                    <option value="USDC-ERC20" ${savedType === 'USDC-ERC20' ? 'selected' : ''}>USDC ERC-20</option>
                                    <option value="USDT-TRC20" ${savedType === 'USDT-TRC20' ? 'selected' : ''}>USDT TRC-20</option>
                                    <option value="SOL" ${savedType === 'SOL' ? 'selected' : ''}>Solana (SOL)</option>
                                    <option value="ETH" ${savedType === 'ETH' ? 'selected' : ''}>Ethereum (ETH)</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; color: #e2e8f0; font-weight: 700; margin-bottom: 8px; font-size: 16px;">Wallet Address</label>
                                <textarea id="withdrawWalletAddress" placeholder="Enter your wallet address" style="width: 100%; padding: 14px 16px; border: 2px solid #475569; border-radius: 12px; font-size: 15px; outline: none; min-height: 70px; resize: vertical; font-family: monospace; background: #0f172a; color: #e2e8f0;">${savedAddress}</textarea>
                                ${savedAddress ? `<p style="font-size: 12px; color: #059669; margin-top: 4px;"> Using your saved wallet address</p>` : ''}
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; color: #e2e8f0; font-weight: 700; margin-bottom: 8px; font-size: 16px;">Withdraw Amount</label>
                                <input type="number" id="withdrawAmount" placeholder="Enter amount" style="width: 100%; padding: 12px 16px; border: 2px solid #475569; border-radius: 12px; font-size: 16px; outline: none; background: #0f172a; color: #e2e8f0;">
                                <p style="font-size: 12px; color: #94a3b8; margin-top: 4px;">Maximum: $${commissionEarned.toFixed(2)}</p>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; color: #e2e8f0; font-weight: 700; margin-bottom: 8px; font-size: 16px;">Withdraw Password </label>
                                <input type="password" id="withdrawPasswordInput" placeholder="Enter your withdraw password" style="width: 100%; padding: 12px 16px; border: 2px solid #475569; border-radius: 12px; font-size: 16px; outline: none; background: #0f172a; color: #e2e8f0;">
                                <p style="font-size: 12px; color: #9ca3af; margin-top: 4px;">The password you set during registration</p>
                            </div>
                        </div>

                        <button class="btn" onclick="handleWithdraw(event)" style="background: #00CED1; font-size: 18px; padding: 16px;">
                             Withdraw
                        </button>
                        ` : `
                        <div style="margin-top: 16px;">
                            ${state.withdrawalHistory.length === 0 ? `
                                <div class="white-box" style="text-align: center; padding: 40px 20px;">
                                    <div style="font-size: 48px; margin-bottom: 16px;"></div>
                                    <p style="color: #94a3b8; font-size: 16px;">No withdrawal history</p>
                                    <p style="color: #9ca3af; font-size: 14px; margin-top: 8px;">Your withdrawal requests will appear here</p>
                                </div>
                            ` : state.withdrawalHistory.map(w => `
                                <div class="white-box" style="margin-bottom: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <div style="font-size: 24px; font-weight: bold; color: ${w.status === 'approved' ? '#dc2626' : '#1f2937'};">-$${(w.amount || 0).toFixed(2)}</div>
                                        <span style="background: ${w.status === 'approved' ? '#d1fae5' : w.status === 'rejected' ? '#fee2e2' : '#fef3c7'}; color: ${w.status === 'approved' ? '#059669' : w.status === 'rejected' ? '#dc2626' : '#f59e0b'}; padding: 6px 14px; border-radius: 12px; font-size: 13px; font-weight: 600; text-transform: capitalize;">
                                            ${w.status === 'approved' ? ' Approved' : w.status === 'rejected' ? ' Rejected' : ' Pending'}
                                        </span>
                                    </div>
                                    ${w.withdraw_type ? `
                                    <div style="font-size: 13px; color: #e2e8f0; margin-bottom: 8px; font-weight: 600;">
                                        <span> ${w.withdraw_type}</span>
                                    </div>
                                    ` : ''}
                                    <div style="font-size: 12px; color: #94a3b8; margin-bottom: 8px; font-family: monospace; word-break: break-all;">
                                        <span> ${w.wallet_address || 'N/A'}</span>
                                    </div>
                                    <div style="font-size: 12px; color: #9ca3af;">
                                         ${formatDateSafe(w.created_at)}
                                    </div>
                                    ${w.admin_note ? `<div style="font-size: 12px; color: #94a3b8; margin-top: 10px; padding: 10px; background: #1e293b; border-radius: 8px; border-left: 3px solid #00CED1;"> ${w.admin_note}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderRecords() {
            const user = state.user || {};
            const history = state.history || [];
            
            // Separate products by status
            const pendingProducts = history.filter(p => p.status === 'in_progress');
            const completedProducts = history.filter(p => p.status === 'completed');
            
            // Initialize active tab if not set
            if (!state.recordsTab) {
                state.recordsTab = 'completed';
            }
            
            return `
                <div class="page" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);">
                    <div class="content-box">
                        <div class="profile-header">
                            <div class="profile-avatar"></div>
                            <div style="color: white;">
                                <div style="font-size: 20px; font-weight: bold;">My Records</div>
                            </div>
                            <div class="profile-badge">${getVipLevelName(user.level || 1)}</div>
                        </div>

                        <!-- Tabs -->
                        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                            <button 
                                onclick="switchRecordsTab('pending')"
                                style="flex: 1; padding: 12px; background: ${state.recordsTab === 'pending' ? 'white' : 'rgba(255,255,255,0.2)'}; color: ${state.recordsTab === 'pending' ? '#00CED1' : 'white'}; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                            >
                                Pending ${pendingProducts.length > 0 ? `(${pendingProducts.length})` : ''}
                            </button>
                            <button 
                                onclick="switchRecordsTab('completed')"
                                style="flex: 1; padding: 12px; background: ${state.recordsTab === 'completed' ? 'white' : 'rgba(255,255,255,0.2)'}; color: ${state.recordsTab === 'completed' ? '#00CED1' : 'white'}; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                            >
                                Completed (${completedProducts.length})
                            </button>
                        </div>

                        <!-- Content based on active tab -->
                        <div style="margin-bottom: 80px;">
                            ${state.recordsTab === 'pending' ? renderPendingRecords(pendingProducts) : renderCompletedRecords(completedProducts)}
                        </div>
                    </div>
                    ${renderBottomNav('records')}
                </div>
            `;
        }
        
        function switchRecordsTab(tab) {
            state.recordsTab = tab;
            render();
        }
        
        function renderPendingRecords(pendingProducts) {
            if (pendingProducts.length === 0) {
                return `
                    <div class="white-box" style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;"></div>
                        <p style="color: #94a3b8; font-size: 16px;">No pending tasks</p>
                        <p style="color: #9ca3af; font-size: 14px; margin-top: 8px;">
                            Pending tasks appear here when you start but don't submit them
                        </p>
                    </div>
                `;
            }
            
            const userBalance = state.user?.wallet_balance || state.user?.balance || 0;
            const hasNegativeBalance = userBalance < 0;
            
            return pendingProducts.map(product => {
                const userLevel = state.user?.level || 1;
                const productPrice = product.custom_price || product['level' + userLevel + '_price'] || 0;
                const commissionRate = state.dashboard?.commissionRate || 0.05;
                
                // NEW FORMULA: Commission = (originalBalance + negativeAmount)  commissionRate  10
                // Use stored values from user data
                const originalBalance = state.user?.balance_before_negative || 0;
                const storedNegativeAmount = state.user?.negative_trigger_amount || Math.abs(userBalance);
                const bonusCommission = hasNegativeBalance 
                    ? ((originalBalance + storedNegativeAmount) * commissionRate * 10).toFixed(2)
                    : (productPrice * commissionRate * 10).toFixed(2); // Fallback for non-negative cases
                
                // Calculated product price for negative balance display
                const displayPrice = hasNegativeBalance 
                    ? (originalBalance + storedNegativeAmount).toFixed(2)
                    : Number(productPrice).toFixed(2);
                
                return `
                    <div class="white-box" style="margin-bottom: 16px; border-left: 4px solid ${hasNegativeBalance ? '#dc2626' : '#f59e0b'};">
                        ${hasNegativeBalance ? `
                        <div style="background: linear-gradient(135deg, #334155, #475569); padding: 8px 12px; border-radius: 8px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 16px;"></span>
                            <span style="font-size: 12px; color: #fbbf24; font-weight: 600;">10x Commission: $${bonusCommission} waiting! Deposit to unlock.</span>
                        </div>
                        ` : ''}
                        <div style="display: flex; gap: 16px; margin-bottom: 12px;">
                            <img 
                                src="${product.image_path || '/backend/uploads/products/default.jpg'}" 
                                alt="${product.name}" 
                                style="width: 80px; height: 80px; object-fit: cover; border-radius: 12px; background: #1e293b;"
                            >
                            <div style="flex: 1;">
                                <h4 style="font-size: 16px; font-weight: bold; color: #ffffff; margin-bottom: 8px;">
                                    ${product.name}
                                </h4>
                                <div style="display: flex; gap: 12px; font-size: 13px;">
                                    <div>
                                        <span style="color: #9ca3af;">Price:</span>
                                        <span style="color: #00CED1; font-weight: 600; margin-left: 4px;">$${displayPrice}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="padding-top: 12px; border-top: 1px solid #334155;">
                            <div style="font-size: 12px; color: #9ca3af; margin-bottom: 8px;">
                                 Started: ${formatDateSafe(product.assigned_date)}
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <span style="background: ${hasNegativeBalance ? '#fef2f2' : '#fef3c7'}; color: ${hasNegativeBalance ? '#dc2626' : '#d97706'}; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                    ${hasNegativeBalance ? 'Deposit Required' : 'Awaiting Submission'}
                                </span>
                                <button 
                                    onclick="${hasNegativeBalance ? "window.open('https://t.me/Expert_Team_RS', '_blank')" : `submitPendingProduct(${product.id})`}"
                                    style="flex: 1; padding: 8px; background: linear-gradient(135deg, ${hasNegativeBalance ? '#16a34a, #15803d' : '#00CED1, #00ACC1'}); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;"
                                >
                                    ${hasNegativeBalance ? ' Deposit Now' : 'Submit Now'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderCompletedRecords(completedProducts) {
            if (completedProducts.length === 0) {
                return `
                    <div class="white-box" style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;"></div>
                        <p style="color: #94a3b8; font-size: 16px;">No completed tasks yet</p>
                        <p style="color: #9ca3af; font-size: 14px; margin-top: 8px;">
                            Start submitting tasks to see your records here
                        </p>
                    </div>
                `;
            }
            
            return completedProducts.map(product => {
                return `
                    <div class="white-box" style="margin-bottom: 16px;">
                        <div style="display: flex; gap: 16px; margin-bottom: 12px;">
                            <img 
                                src="${product.image_path || '/backend/uploads/products/default.jpg'}" 
                                alt="${product.name}" 
                                style="width: 80px; height: 80px; object-fit: cover; border-radius: 12px; background: #1e293b;"
                            >
                            <div style="flex: 1;">
                                <h4 style="font-size: 16px; font-weight: bold; color: #ffffff; margin-bottom: 8px;">
                                    ${product.name}
                                </h4>
                                <div style="display: flex; gap: 12px; font-size: 13px;">
                                    <div>
                                        <span style="color: #9ca3af;">Earned:</span>
                                        <span style="color: #10b981; font-weight: 600; margin-left: 4px;">$${(product.amount_earned || 0).toFixed(2)}</span>
                                    </div>
                                    <div>
                                        <span style="color: #9ca3af;">Commission:</span>
                                        <span style="color: #00CED1; font-weight: 600; margin-left: 4px;">$${(product.commission_earned || 0).toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid #334155;">
                            <div style="font-size: 12px; color: #9ca3af;">
                                 Completed: ${formatDateSafe(product.submitted_at)}
                            </div>
                            <span style="background: #064e3b; color: #34d399; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                Completed
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function submitPendingProduct(productId) {
            // Find the product in history
            const product = state.history.find(p => p.id === productId);
            if (!product) return;
            
            // Show the product popup for submission
            showProductPopup(product);
        }
        
        // Load user's payment method on page load
        async function loadPaymentMethod() {
            try {
                const response = await fetch(`${API_BASE_URL}/user/payment-method`, {
                    headers: { 'Authorization': `Bearer ${state.token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    state.paymentMethod = data;
                    return data;
                }
            } catch (err) {
                console.error('Failed to load payment method:', err);
            }
            return null;
        }
        
        // Save payment method
        async function savePaymentMethod() {
            const withdrawType = document.getElementById('withdrawTypeSelect')?.value;
            const walletAddress = document.getElementById('savedWalletAddress')?.value?.trim();
            
            if (!withdrawType) {
                alert('Please select a withdraw type');
                return;
            }
            if (!walletAddress || walletAddress.length < 10) {
                alert('Please enter a valid wallet address');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/user/payment-method`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${state.token}`
                    },
                    body: JSON.stringify({
                        withdrawType: withdrawType,
                        walletAddress: walletAddress
                    })
                });
                
                const data = await response.json();
                if (response.ok) {
                    alert('Payment method saved successfully!');
                    if (data.user) {
                        state.user = data.user;
                    }
                    state.paymentMethod = { withdraw_type: withdrawType, saved_wallet_address: walletAddress };
                } else {
                    alert(data.error || 'Failed to save payment method');
                }
            } catch (err) {
                console.error('Save payment method error:', err);
                alert('Failed to save payment method. Please try again.');
            }
        }
        
        function renderPaymentMethods() {
            const pm = state.paymentMethod || {};
            const savedType = pm.withdraw_type || '';
            const savedAddress = pm.saved_wallet_address || '';
            
            // Load payment method if not loaded yet
            if (!state.paymentMethod && state.token) {
                loadPaymentMethod().then(() => render());
            }
            
            return `
                <div class="page" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);">
                    <div class="header" style="background: transparent;">
                        <button class="back-btn" onclick="navigateTo('mycenter')"></button>
                        <h1>Payment Methods</h1>
                        <div style="width: 24px;"></div>
                    </div>

                    <div class="content-box">
                        <div class="white-box" style="margin-bottom: 20px;">
                            <div style="margin-bottom: 24px;">
                                <label style="display: block; color: #e2e8f0; font-weight: 700; margin-bottom: 10px; font-size: 16px;">Withdraw Type</label>
                                <select id="withdrawTypeSelect" style="width: 100%; padding: 14px 16px; border: 2px solid #475569; border-radius: 12px; font-size: 16px; outline: none; background: #1e293b; cursor: pointer; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2224%22 height=%2224%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%236b7280%22 stroke-width=%222%22><polyline points=%226 9 12 15 18 9%22></polyline></svg>'); background-repeat: no-repeat; background-position: right 12px center; background-size: 20px;">
                                    <option value="" ${!savedType ? 'selected' : ''}>-- Select Cryptocurrency --</option>
                                    <option value="BTC" ${savedType === 'BTC' ? 'selected' : ''}>Bitcoin (BTC)</option>
                                    <option value="LTC" ${savedType === 'LTC' ? 'selected' : ''}>Litecoin (LTC)</option>
                                    <option value="USDC-ERC20" ${savedType === 'USDC-ERC20' ? 'selected' : ''}>USDC ERC-20</option>
                                    <option value="USDT-TRC20" ${savedType === 'USDT-TRC20' ? 'selected' : ''}>USDT TRC-20</option>
                                    <option value="SOL" ${savedType === 'SOL' ? 'selected' : ''}>Solana (SOL)</option>
                                    <option value="ETH" ${savedType === 'ETH' ? 'selected' : ''}>Ethereum (ETH)</option>
                                </select>
                            </div>

                            <div style="margin-bottom: 24px;">
                                <label style="display: block; color: #e2e8f0; font-weight: 700; margin-bottom: 10px; font-size: 16px;">Wallet Address</label>
                                <textarea id="savedWalletAddress" placeholder="Enter your wallet address for withdrawals" style="width: 100%; padding: 14px 16px; border: 2px solid #475569; border-radius: 12px; font-size: 15px; outline: none; min-height: 80px; resize: vertical; font-family: monospace; background: #0f172a; color: #e2e8f0;">${savedAddress}</textarea>
                                <p style="font-size: 12px; color: #94a3b8; margin-top: 8px;"> Make sure this address matches your selected cryptocurrency network</p>
                            </div>
                            
                            ${savedType && savedAddress ? `
                            <div style="background: #1e293b; border: 1px solid #059669; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <span style="font-size: 18px;"></span>
                                    <span style="font-weight: 600; color: #166534;">Saved Payment Method</span>
                                </div>
                                <div style="font-size: 14px; color: #166534;">
                                    <strong>${savedType}</strong>  <span style="font-family: monospace; word-break: break-all;">${savedAddress.substring(0, 20)}...${savedAddress.substring(savedAddress.length - 10)}</span>
                                </div>
                            </div>
                            ` : `
                            <div style="background: #334155; border: 1px solid #fcd34d; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 18px;"></span>
                                    <span style="font-weight: 600; color: #fbbf24;">No payment method saved</span>
                                </div>
                                <p style="font-size: 13px; color: #fbbf24; margin-top: 4px;">Please save your wallet info before making withdrawals</p>
                            </div>
                            `}
                        </div>

                        <button class="btn" onclick="savePaymentMethod()" style="background: #00CED1; font-size: 18px; padding: 16px;">
                             Save Payment Method
                        </button>
                    </div>
                </div>
            `;
        }

        function renderRegister() {
            return `
                <div class="auth-page">
                    <!-- Left Panel - Brand -->
                    <div class="auth-brand">
                        <div class="auth-brand-logo">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Orion Music
                        </div>
                        <h1>Start Your Music Journey.</h1>
                        <p>Join thousands of artists using Orion Music to promote their music and earn commissions.</p>
                    </div>
                    
                    <!-- Right Panel - Form -->
                    <div class="auth-form-panel">
                        <div class="auth-form-container">
                            <div class="auth-form-header">
                                <h2>Create Account</h2>
                                <p>Join Orion Music and start earning today</p>
                            </div>
                            
                            <form class="auth-form" onsubmit="handleRegister(event)">
                                <div class="field">
                                    <label for="regAccountName">Account Name <span class="req">*</span></label>
                                    <input type="text" id="regAccountName" placeholder="Enter your account name" required>
                                </div>
                                
                                <div class="field">
                                    <label for="regPhone">Phone <span class="req">*</span></label>
                                    <input type="tel" id="regPhone" placeholder="Enter your phone number" required>
                                </div>
                                
                                <div class="field">
                                    <label for="regPassword">Password <span class="req">*</span></label>
                                    <input type="password" id="regPassword" placeholder="Enter your password" required>
                                </div>
                                
                                <div class="field">
                                    <label for="regConfirmPassword">Confirm Password <span class="req">*</span></label>
                                    <input type="password" id="regConfirmPassword" placeholder="Re-enter your password" required>
                                </div>
                                
                                <div class="field">
                                    <label>Gender</label>
                                    <div class="gender-options">
                                        <label>
                                            <input type="radio" name="gender" value="male" checked>
                                            Male
                                        </label>
                                        <label>
                                            <input type="radio" name="gender" value="female">
                                            Female
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="field">
                                    <label for="regInviteCode">Invite Code <span class="req">*</span></label>
                                    <input type="text" id="regInviteCode" placeholder="Enter invite code" required>
                                    <div class="hint">You need an invite code to register</div>
                                </div>
                                
                                <div class="field">
                                    <label for="regWithdrawPassword">Withdraw Password <span class="req">*</span></label>
                                    <input type="password" id="regWithdrawPassword" placeholder="4-digit password" required minlength="4">
                                    <div class="hint">Required for withdrawals (min 4 characters)</div>
                                </div>
                                
                                <div class="checkbox-field">
                                    <input type="checkbox" id="agreeTerms" required>
                                    <span>I agree with <a href="#" onclick="showTermsModalFromRegister(); return false;">Terms and Conditions</a></span>
                                </div>
                                
                                <button type="submit" class="submit-btn">
                                    Register Now
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                        <polyline points="12 5 19 12 12 19"></polyline>
                                    </svg>
                                </button>
                            </form>
                            
                            <div class="auth-form-footer">
                                <p>Already have an account?</p>
                                <button type="button" class="back-link" onclick="navigateTo('login')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="19" y1="12" x2="5" y2="12"></line>
                                        <polyline points="12 19 5 12 12 5"></polyline>
                                    </svg>
                                    Back to Login
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderServicesPage() {
            return `
                <div class="page" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);">
                    <div class="header" style="background: transparent;">
                        <button class="back-btn" onclick="navigateTo('home')"></button>
                        <h1>Services</h1>
                        <div style="width: 24px;"></div>
                    </div>

                    <div class="content-box">
                        <div class="white-box" style="margin-bottom: 20px;">
                            <h3 style="font-size: 20px; font-weight: bold; color: #00CED1; margin-bottom: 16px;"> Orion Music Services</h3>
                            <p style="color: #cbd5e1; line-height: 1.8; margin-bottom: 20px;">
                                Orion Music provides comprehensive music promotion and distribution services. We help artists and labels maximize their reach across all major streaming platforms while ensuring proper rights management and royalty tracking.
                            </p>
                        </div>

                        <div class="white-box" style="margin-bottom: 20px;">
                            <div style="display: flex; gap: 12px; align-items: start; margin-bottom: 16px;">
                                <div style="background: #334155; color: #00CED1; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0;"></div>
                                <div>
                                    <h4 style="font-weight: bold; color: #ffffff; margin-bottom: 8px;">Music Distribution</h4>
                                    <p style="color: #94a3b8; line-height: 1.6; font-size: 14px;">Distribute your albums to all major streaming platforms including Spotify, Apple Music, and Amazon Music</p>
                                </div>
                            </div>
                        </div>

                        <div class="white-box" style="margin-bottom: 20px;">
                            <div style="display: flex; gap: 12px; align-items: start; margin-bottom: 16px;">
                                <div style="background: #334155; color: #00CED1; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0;"></div>
                                <div>
                                    <h4 style="font-weight: bold; color: #ffffff; margin-bottom: 8px;">Promotion Services</h4>
                                    <p style="color: #94a3b8; line-height: 1.6; font-size: 14px;">Strategic playlist placement and marketing campaigns to boost your album visibility</p>
                                </div>
                            </div>
                        </div>

                        <div class="white-box" style="margin-bottom: 20px;">
                            <div style="display: flex; gap: 12px; align-items: start; margin-bottom: 16px;">
                                <div style="background: #334155; color: #00CED1; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0;"></div>
                                <div>
                                    <h4 style="font-weight: bold; color: #ffffff; margin-bottom: 8px;">Rights Management</h4>
                                    <p style="color: #94a3b8; line-height: 1.6; font-size: 14px;">Comprehensive copyright protection and licensing management for your music catalog</p>
                                </div>
                            </div>
                        </div>

                        <div class="white-box" style="margin-bottom: 20px;">
                            <div style="display: flex; gap: 12px; align-items: start; margin-bottom: 16px;">
                                <div style="background: #334155; color: #00CED1; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0;"></div>
                                <div>
                                    <h4 style="font-weight: bold; color: #ffffff; margin-bottom: 8px;">Royalty Collection</h4>
                                    <p style="color: #94a3b8; line-height: 1.6; font-size: 14px;">Track and collect royalties from all streaming platforms and performance venues worldwide</p>
                                </div>
                            </div>
                        </div>

                        <div class="white-box" style="margin-bottom: 20px;">
                            <div style="display: flex; gap: 12px; align-items: start; margin-bottom: 16px;">
                                <div style="background: #334155; color: #00CED1; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0;"></div>
                                <div>
                                    <h4 style="font-weight: bold; color: #ffffff; margin-bottom: 8px;">Analytics & Insights</h4>
                                    <p style="color: #94a3b8; line-height: 1.6; font-size: 14px;">Real-time analytics and detailed reports on your music performance across all platforms</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTermsPage() {
            return `
                <div class="page" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);">
                    <div class="header" style="background: transparent;">
                        <button class="back-btn" onclick="navigateTo('home')"></button>
                        <h1>Terms & Conditions</h1>
                        <div style="width: 24px;"></div>
                    </div>

                    <div class="content-box">
                        <div class="white-box" style="margin-bottom: 20px;">
                            <h3 style="font-size: 18px; font-weight: bold; color: #ffffff; margin-bottom: 16px;"> Clause User Agreement and Terms and Conditions</h3>
                            <p style="color: #94a3b8; line-height: 1.8; margin-bottom: 16px;">
                                These Terms and Conditions are governed by the following terminology and principles of interpretation. All users are required to adhere to the terms outlined by the platform. Any violations will result in corrective actions and penalties imposed by the platform. The User Agreement, which is part of these Terms and Conditions, is subject to the platform's final interpretation.
                            </p>
                        </div>

                        <div class="white-box" style="margin-bottom: 20px;">
                            <h4 style="font-weight: bold; color: #00CED1; margin-bottom: 12px;">1. Start to Submit Album Data</h4>
                            <ul style="color: #94a3b8; line-height: 1.8; padding-left: 20px;">
                                <li style="margin-bottom: 8px;">1.1 A minimum account balance of 50 USD is required to initiate the first set of 30 data submissions.</li>
                                <li style="margin-bottom: 8px;">1.2 A minimum balance of 100 USD is required to reset and start a new data submission process.</li>
                                <li style="margin-bottom: 8px;">1.3 Users must complete the current dataset before requesting a reset for the next set of submissions.</li>
                            </ul>
                        </div>

                        <div class="white-box" style="margin-bottom: 20px;">
                            <h4 style="font-weight: bold; color: #00CED1; margin-bottom: 12px;">2. Withdrawal</h4>
                            <ul style="color: #94a3b8; line-height: 1.8; padding-left: 20px;">
                                <li style="margin-bottom: 8px;">2.1 The maximum withdrawal limit for ordinary members is 10,000 USD. If the withdrawal amount exceeds 10,000 USD, users must upgrade to the appropriate membership level, as each membership level has different withdrawal limits.</li>
                                <li style="margin-bottom: 8px;">2.2 Users are required to complete two sets of data submissions per day in order to submit a withdrawal request. Additionally, users must request the withdrawal of their full account balance.</li>
                                <li style="margin-bottom: 8px;">2.3 Users who abandon or quit during the data submission process are ineligible to apply for a withdrawal or refund.</li>
                                <li style="margin-bottom: 8px;">2.4 If a withdrawal request has not been formally submitted by the user, the platform cannot process any withdrawal on the user's behalf.</li>
                            </ul>
                        </div>

                        <div class="white-box" style="margin-bottom: 20px;">
                            <h4 style="font-weight: bold; color: #00CED1; margin-bottom: 12px;">3. Funds</h4>
                            <ul style="color: #94a3b8; line-height: 1.8; padding-left: 20px;">
                                <li style="margin-bottom: 8px;">3.1 All user funds will be securely stored in their account and may be withdrawn in full once all data submissions are completed.</li>
                                <li style="margin-bottom: 8px;">3.2 To avoid any loss of funds, all data processing will be handled by the system, not manually.</li>
                                <li style="margin-bottom: 8px;">3.3 In case of accidental loss of funds, the platform will assume full responsibility.</li>
                            </ul>
                        </div>

                        <div class="white-box" style="margin-bottom: 20px;">
                            <h4 style="font-weight: bold; color: #00CED1; margin-bottom: 12px;">4. Account Security</h4>
                            <ul style="color: #94a3b8; line-height: 1.8; padding-left: 20px;">
                                <li style="margin-bottom: 8px;">4.1 Users must not share their login passwords or security PINs with others. If this results in a loss, the platform will not be responsible.</li>
                                <li style="margin-bottom: 8px;">4.2 It is not recommended to set easily identifiable information, such as birthdates, ID card numbers, or phone numbers, as security codes or login passwords.</li>
                                <li style="margin-bottom: 8px;">4.3 If users forget their login or withdrawal passwords, they should contact customer service to reset them.</li>
                            </ul>
                        </div>

                        <div class="white-box" style="margin-bottom: 20px;">
                            <h4 style="font-weight: bold; color: #00CED1; margin-bottom: 12px;">5. Normal Album Data</h4>
                            <ul style="color: #94a3b8; line-height: 1.8; padding-left: 20px;">
                                <li style="margin-bottom: 8px;">5.1 Foundation (VIP 1) users can complete 2 sets of data submissions per day with a 0.5% profit for each normal album data.</li>
                                <li style="margin-bottom: 8px;">5.2 Growth (VIP 2) users can complete 2 sets of data submissions per day with a 1.0% profit for each normal album data.</li>
                                <li style="margin-bottom: 8px;">5.3 Advance (VIP 3) users can complete 2 sets of data submissions per day with a 1.5% profit for each normal album data.</li>
                                <li style="margin-bottom: 8px;">5.4 Pinnacle (VIP 4) users can complete 2 sets of data submissions per day with a 2.0% profit for each normal album data.</li>
                                <li style="margin-bottom: 8px;">5.5 Elite (VIP 5) users can complete 2 sets of data submissions per day with a 2.5% profit for each normal album data.</li>
                                <li style="margin-bottom: 8px;">5.6 Upon successful submission of album data, the commission will be automatically credited to the user's account balance.</li>
                                <li style="margin-bottom: 8px;">5.7 The system will randomly assign album data to the user's account based on their account balance.</li>
                                <li style="margin-bottom: 8px;">5.8 Once the data is assigned to the user's account, it cannot be canceled, skipped, or exchanged.</li>
                            </ul>
                        </div>

                        <div class="white-box" style="margin-bottom: 20px;">
                            <h4 style="font-weight: bold; color: #00CED1; margin-bottom: 12px;">6. High-Value Orders</h4>
                            <ul style="color: #94a3b8; line-height: 1.8; padding-left: 20px;">
                                <li style="margin-bottom: 8px;">6.1 A high-value order refers to an album with a high purchase cost in the market. Users may not necessarily receive this album; instead, the system will randomly assign albums within the user's assignment. There is a higher likelihood of receiving one high-value order or album per set.</li>
                                <li style="margin-bottom: 8px;">6.2 Users will earn ten times the standard commission for completing a high-value album.</li>
                                <li style="margin-bottom: 8px;">6.3 Upon receiving a high-value album, all related funds will be placed on hold until all pending high-profit album submissions are completed. Once the submissions are finalized, the funds will be released back to the user's account.</li>
                                <li style="margin-bottom: 8px;">6.4 High-value albums are randomly assigned by the system based on the total balance available in the user's account.</li>
                                <li style="margin-bottom: 8px;">6.5 Once a high-profit order or album is assigned to a user's account, it cannot be canceled, skipped, or exchanged.</li>
                                <li style="margin-bottom: 8px;">6.6 A user may receive a maximum of three (3) high-value albums per data submission set.</li>
                            </ul>
                        </div>

                        <div class="white-box" style="margin-bottom: 20px;">
                            <h4 style="font-weight: bold; color: #00CED1; margin-bottom: 12px;">7. Advance Payments</h4>
                            <ul style="color: #94a3b8; line-height: 1.8; padding-left: 20px;">
                                <li style="margin-bottom: 8px;">7.1 The amount for advance payment is determined by the user. The platform does not set specific amounts for the user, but recommends users make advance payments based on their financial capacity or after becoming familiar with the platform.</li>
                                <li style="margin-bottom: 8px;">7.2 If a user needs to make an advance payment upon receiving a high-value product, it is advised that the user pays according to the negative balance indicated in their account.</li>
                                <li style="margin-bottom: 8px;">7.3 Before making an advance payment, users must contact customer service to request advance payment details and confirm the merchant's wallet address.</li>
                                <li style="margin-bottom: 8px;">7.4 The platform will not assume responsibility for any loss resulting from payments made to incorrect wallet addresses.</li>
                            </ul>
                        </div>

                        <div class="white-box" style="margin-bottom: 20px;">
                            <h4 style="font-weight: bold; color: #00CED1; margin-bottom: 12px;">8. Merchant Cooperation</h4>
                            <ul style="color: #94a3b8; line-height: 1.8; padding-left: 20px;">
                                <li style="margin-bottom: 8px;">8.1 Data availability on the platform fluctuates. If data is not processed in a timely manner, merchants may be unable to offload it, affecting their progress. Users are encouraged to complete their submissions and apply for withdrawals promptly to avoid hindering merchant progress. Users must complete all submissions within 8 hours to avoid complaints from merchants and order freezes.</li>
                                <li style="margin-bottom: 8px;">8.2 Merchants will provide users with wallet addresses to facilitate advance payments.</li>
                            </ul>
                        </div>

                        <div class="white-box" style="margin-bottom: 20px;">
                            <h4 style="font-weight: bold; color: #00CED1; margin-bottom: 12px;">9. Invitation</h4>
                            <ul style="color: #94a3b8; line-height: 1.8; padding-left: 20px;">
                                <li style="margin-bottom: 8px;">9.1 Users may invite other users to the platform using the invitation code linked to their account.</li>
                                <li style="margin-bottom: 8px;">9.2 Users must complete all data submissions in their set before they can invite other users.</li>
                                <li style="margin-bottom: 8px;">9.3 In order to be eligible to using invitation code to invite referrals to join, user must first complete and register 15 consecutive working days.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSimplePage(title) {
            // Handle specific pages
            if (title === 'services') {
                return renderServicesPage();
            }
            if (title === 'terms') {
                return renderTermsPage();
            }
            if (title === 'notifications') {
                return renderNotificationsPage();
            }
            if (title === 'userEvents') {
                return renderUserEventsPage();
            }
            if (title === 'loginPassword') {
                return renderChangePasswordPage();
            }
            if (title === 'withdrawPassword') {
                return renderChangeWithdrawPasswordPage();
            }
            
            return `
                <div class="page">
                    <div class="header">
                        <button class="back-btn" onclick="navigateTo('home')"></button>
                        <h1>${title}</h1>
                        <div style="width: 24px;"></div>
                    </div>
                    <div class="content-box">
                        <div class="white-box">
                            <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 16px;">${title}</h3>
                            <p style="color: #94a3b8; line-height: 1.6;">
                                This feature is coming soon. Please check back later.
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Change Password Page
        function renderChangePasswordPage() {
            return `
                <div class="page" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);">
                    <div class="header" style="background: transparent;">
                        <button class="back-btn" onclick="navigateTo('mycenter')"></button>
                        <h1>Change Password</h1>
                        <div style="width: 24px;"></div>
                    </div>
                    <div class="content-box">
                        <div class="white-box">
                            <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 20px; color: #ffffff;"> Update Your Password</h3>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; color: #94a3b8; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Current Password</label>
                                <input type="password" id="currentPassword" placeholder="Enter current password" style="width: 100%; padding: 14px 16px; border: 2px solid #475569; border-radius: 12px; font-size: 16px; outline: none; transition: border-color 0.2s; background: #0f172a; color: #e2e8f0;" onfocus="this.style.borderColor='#00CED1'" onblur="this.style.borderColor='#475569'">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; color: #94a3b8; font-weight: 600; margin-bottom: 8px; font-size: 14px;">New Password</label>
                                <input type="password" id="newPassword" placeholder="Enter new password" style="width: 100%; padding: 14px 16px; border: 2px solid #475569; border-radius: 12px; font-size: 16px; outline: none; transition: border-color 0.2s; background: #0f172a; color: #e2e8f0;" onfocus="this.style.borderColor='#00CED1'" onblur="this.style.borderColor='#475569'">
                            </div>
                            
                            <div style="margin-bottom: 24px;">
                                <label style="display: block; color: #94a3b8; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Confirm New Password</label>
                                <input type="password" id="confirmNewPassword" placeholder="Confirm new password" style="width: 100%; padding: 14px 16px; border: 2px solid #475569; border-radius: 12px; font-size: 16px; outline: none; transition: border-color 0.2s; background: #0f172a; color: #e2e8f0;" onfocus="this.style.borderColor='#00CED1'" onblur="this.style.borderColor='#475569'">
                            </div>
                            
                            <button class="btn" onclick="handleChangePassword()" style="background: linear-gradient(135deg, #00CED1, #00ACC1); font-size: 16px; padding: 16px; font-weight: 600;">
                                Update Password
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Change Withdraw Password Page
        function renderChangeWithdrawPasswordPage() {
            return `
                <div class="page" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);">
                    <div class="header" style="background: transparent;">
                        <button class="back-btn" onclick="navigateTo('mycenter')"></button>
                        <h1>Withdraw Password</h1>
                        <div style="width: 24px;"></div>
                    </div>
                    <div class="content-box">
                        <div class="white-box">
                            <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 20px; color: #ffffff;"> Change Withdraw Password</h3>
                            <p style="color: #94a3b8; font-size: 14px; margin-bottom: 20px;">This password is required when making withdrawals from your account.</p>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; color: #94a3b8; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Current Withdraw Password</label>
                                <input type="password" id="currentWithdrawPassword" placeholder="Enter current withdraw password" style="width: 100%; padding: 14px 16px; border: 2px solid #475569; border-radius: 12px; font-size: 16px; outline: none; transition: border-color 0.2s; background: #0f172a; color: #e2e8f0;" onfocus="this.style.borderColor='#00CED1'" onblur="this.style.borderColor='#475569'">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; color: #94a3b8; font-weight: 600; margin-bottom: 8px; font-size: 14px;">New Withdraw Password</label>
                                <input type="password" id="newWithdrawPassword" placeholder="Enter new withdraw password (min 4 characters)" style="width: 100%; padding: 14px 16px; border: 2px solid #475569; border-radius: 12px; font-size: 16px; outline: none; transition: border-color 0.2s; background: #0f172a; color: #e2e8f0;" onfocus="this.style.borderColor='#00CED1'" onblur="this.style.borderColor='#475569'">
                            </div>
                            
                            <div style="margin-bottom: 24px;">
                                <label style="display: block; color: #94a3b8; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Confirm New Withdraw Password</label>
                                <input type="password" id="confirmNewWithdrawPassword" placeholder="Confirm new withdraw password" style="width: 100%; padding: 14px 16px; border: 2px solid #475569; border-radius: 12px; font-size: 16px; outline: none; transition: border-color 0.2s; background: #0f172a; color: #e2e8f0;" onfocus="this.style.borderColor='#00CED1'" onblur="this.style.borderColor='#475569'">
                            </div>
                            
                            <button class="btn" onclick="handleChangeWithdrawPassword()" style="background: linear-gradient(135deg, #00CED1, #00ACC1); font-size: 16px; padding: 16px; font-weight: 600;">
                                Update Withdraw Password
                            </button>
                        </div>

                        <div class="white-box" style="margin-top: 16px;">
                            <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 12px; color: #ffffff;"> Forgot Withdraw Password?</h3>
                            <p style="color: #94a3b8; font-size: 14px; margin-bottom: 20px;">If you forgot your withdraw password, contact customer care via chat to get a reset OTP code.</p>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; color: #94a3b8; font-weight: 600; margin-bottom: 8px; font-size: 14px;">OTP Code (from Customer Care)</label>
                                <input type="text" id="resetOTPCode" placeholder="Enter 6-digit OTP" maxlength="6" style="width: 100%; padding: 14px 16px; border: 2px solid #475569; border-radius: 12px; font-size: 18px; outline: none; transition: border-color 0.2s; letter-spacing: 4px; text-align: center; font-family: monospace;" onfocus="this.style.borderColor='#7c3aed'" onblur="this.style.borderColor='#475569'">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; color: #94a3b8; font-weight: 600; margin-bottom: 8px; font-size: 14px;">New Withdraw Password</label>
                                <input type="password" id="resetNewWithdrawPassword" placeholder="Enter new withdraw password (min 4 characters)" style="width: 100%; padding: 14px 16px; border: 2px solid #475569; border-radius: 12px; font-size: 16px; outline: none; transition: border-color 0.2s; background: #0f172a; color: #e2e8f0;" onfocus="this.style.borderColor='#7c3aed'" onblur="this.style.borderColor='#475569'">
                            </div>
                            
                            <div style="margin-bottom: 24px;">
                                <label style="display: block; color: #94a3b8; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Confirm New Withdraw Password</label>
                                <input type="password" id="resetConfirmWithdrawPassword" placeholder="Confirm new withdraw password" style="width: 100%; padding: 14px 16px; border: 2px solid #475569; border-radius: 12px; font-size: 16px; outline: none; transition: border-color 0.2s; background: #0f172a; color: #e2e8f0;" onfocus="this.style.borderColor='#7c3aed'" onblur="this.style.borderColor='#475569'">
                            </div>
                            
                            <button class="btn" onclick="handleResetWithdrawPasswordWithOTP()" style="background: linear-gradient(135deg, #7c3aed, #6d28d9); font-size: 16px; padding: 16px; font-weight: 600;">
                                Reset with OTP
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // User Events Page
        function renderUserEventsPage() {
            return `
                <div class="page" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);">
                    <div class="header" style="background: transparent;">
                        <button class="back-btn" onclick="navigateTo('home')"></button>
                        <h1>Events</h1>
                        <div style="width: 24px;"></div>
                    </div>
                    <div class="content-box">
                        ${state.events.length === 0 ? `
                            <div class="white-box" style="text-align: center; padding: 40px 20px;">
                                <div style="font-size: 64px; margin-bottom: 16px;"></div>
                                <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 8px; color: #ffffff;">No Events</h3>
                                <p style="color: #94a3b8; font-size: 14px;">There are no active events at the moment. Check back later!</p>
                            </div>
                        ` : state.events.map(event => `
                            <div class="white-box" style="margin-bottom: 16px; overflow: hidden; padding: 0; border-radius: 16px;">
                                ${event.image_path ? `
                                    <div style="width: 100%;">
                                        <img src="${API_BASE_URL.replace('/api', '')}${event.image_path}" alt="${event.title}" style="width: 100%; height: auto; display: block;">
                                    </div>
                                ` : ''}
                                <div style="padding: 16px;">
                                    <h3 style="font-size: 18px; font-weight: bold; color: #ffffff; margin-bottom: 8px;">${event.title}</h3>
                                    <p style="color: #cbd5e1; font-size: 14px; line-height: 1.6; margin-bottom: 12px;">${event.description || ''}</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                                        ${event.event_date ? `
                                            <span style="color: #10b981; font-size: 12px; background: #0f172a; padding: 4px 8px; border-radius: 8px;">
                                                 ${formatDateSafe(event.event_date)}
                                            </span>
                                        ` : ''}
                                        <span style="color: #8b5cf6; font-size: 12px;"> Active Event</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Notifications Page
        function renderNotificationsPage() {
            return `
                <div class="page" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);">
                    <div class="header" style="background: transparent;">
                        <button class="back-btn" onclick="navigateTo('mycenter')"></button>
                        <h1>Notifications</h1>
                        <div style="width: 24px;"></div>
                    </div>
                    <div class="content-box">
                        ${state.notifications.length === 0 ? `
                            <div class="white-box" style="text-align: center; padding: 40px 20px;">
                                <div style="font-size: 64px; margin-bottom: 16px;"></div>
                                <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 8px; color: #ffffff;">No Notifications</h3>
                                <p style="color: #94a3b8; font-size: 14px;">You're all caught up! New notifications will appear here.</p>
                            </div>
                        ` : state.notifications.map(n => `
                            <div class="white-box" style="margin-bottom: 12px; position: relative; ${n.is_read ? 'opacity: 0.7;' : ''}">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                    <h4 style="font-size: 16px; font-weight: bold; color: #ffffff; flex: 1;">${n.title}</h4>
                                    ${!n.is_read ? `
                                        <span style="background: #ef4444; color: white; width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; margin-left: 8px; margin-top: 6px;"></span>
                                    ` : ''}
                                </div>
                                <p style="color: #cbd5e1; font-size: 14px; line-height: 1.6; margin-bottom: 12px;">${n.message}</p>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: #9ca3af; font-size: 12px;"> ${formatDateSafe(n.created_at)}</span>
                                    ${!n.is_read ? `
                                        <button onclick="markNotificationRead(${n.id})" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 8px; font-size: 12px; cursor: pointer;">
                                            Mark as Read
                                        </button>
                                    ` : `
                                        <span style="color: #10b981; font-size: 12px;"> Read</span>
                                    `}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Lucky Draw Page
        function renderLuckyDraw() {
            const prizes = [
                { emoji: '', label: 'Diamond', color: '#fef3c7' },
                { emoji: '', label: 'Gift', color: '#fed7aa' },
                { emoji: '', label: 'Star', color: '#fdba74' },
                { emoji: '', label: 'Cash', color: '#fb923c' },
                { emoji: '', label: 'Trophy', color: '#00CED1' },
                { emoji: '', label: 'Bonus', color: '#00ACC1' },
                { emoji: '', label: 'Super', color: '#c2410c' },
                { emoji: '', label: 'Mega', color: '#9a3412' }
            ];

            return `
                <div class="page" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); min-height: 100vh;">
                    <div class="header" style="background: transparent;">
                        <button class="back-btn" onclick="navigateTo('home')"></button>
                        <h1> Lucky Draw</h1>
                        <div style="width: 24px;"></div>
                    </div>

                    <div class="content-box" style="padding-bottom: 120px;">
                        <!-- Header Banner -->
                        <div style="background: linear-gradient(135deg, #00CED1, #00ACC1); border-radius: 20px; padding: 24px; margin-bottom: 32px; text-align: center; color: white; box-shadow: 0 10px 30px rgba(0, 206, 209, 0.3);">
                            <div style="font-size: 48px; margin-bottom: 12px;"></div>
                            <h2 style="font-size: 28px; font-weight: bold; margin-bottom: 8px;">Spin & Win Big!</h2>
                            <p style="font-size: 16px; opacity: 0.9;">Try your luck and win amazing prizes</p>
                        </div>

                        <!-- Stats Cards -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 32px;">
                            <div style="background: linear-gradient(135deg, #1e293b, #334155); border: 1px solid rgba(0, 206, 209, 0.3); border-radius: 16px; padding: 20px; text-align: center;">
                                <div style="font-size: 32px; margin-bottom: 8px;"></div>
                                <div style="font-size: 28px; font-weight: bold; color: #00CED1; margin-bottom: 4px;">0</div>
                                <div style="font-size: 14px; color: #9ca3af;">Spins Available</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #1e293b, #334155); border: 1px solid rgba(0, 206, 209, 0.3); border-radius: 16px; padding: 20px; text-align: center;">
                                <div style="font-size: 32px; margin-bottom: 8px;"></div>
                                <div style="font-size: 28px; font-weight: bold; color: #10b981; margin-bottom: 4px;">0</div>
                                <div style="font-size: 14px; color: #9ca3af;">Total Wins</div>
                            </div>
                        </div>

                        <!-- Lucky Wheel -->
                        <div style="background: linear-gradient(135deg, #1e293b, #334155); border: 1px solid rgba(0, 206, 209, 0.3); border-radius: 24px; padding: 40px 20px; margin-bottom: 32px; position: relative; overflow: hidden;">
                            <!-- Decorative background elements -->
                            <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: radial-gradient(circle, rgba(0, 206, 209, 0.1) 0%, transparent 70%); border-radius: 50%;"></div>
                            <div style="position: absolute; bottom: -50px; left: -50px; width: 200px; height: 200px; background: radial-gradient(circle, rgba(0, 206, 209, 0.1) 0%, transparent 70%); border-radius: 50%;"></div>
                            
                            <div style="position: relative; z-index: 1;">
                                <!-- Wheel Container -->
                                <div class="lucky-wheel-container" style="margin-bottom: 40px;">
                                    <div class="wheel-pointer"></div>
                                    <div class="lucky-wheel" id="luckyWheel">
                                        ${prizes.map((prize, index) => {
                                            const angle = (360 / prizes.length) * index;
                                            return `
                                                <div class="wheel-segment" style="transform: rotate(${angle}deg); color: ${index % 2 === 0 ? '#94a3b8' : 'white'};">
                                                    <span style="transform: translateX(60%) rotate(${22.5}deg); font-size: 36px;">${prize.emoji}</span>
                                                </div>
                                            `;
                                        }).join('')}
                                        <div class="wheel-center"></div>
                                    </div>
                                </div>

                                <!-- Spin Button -->
                                <div style="text-align: center;">
                                    <button class="spin-button" id="spinButton" onclick="spinWheel()" disabled>
                                        <span style="font-size: 28px; margin-right: 8px;"></span>
                                        SPIN NOW
                                    </button>
                                    <p style="color: #9ca3af; font-size: 14px; margin-top: 16px;">You need spin tickets to play</p>
                                </div>
                            </div>
                        </div>

                        <!-- How to Get Spins -->
                        <div style="background: linear-gradient(135deg, #334155, #475569); border-radius: 20px; padding: 24px; margin-bottom: 32px; border: 2px solid #f59e0b;">
                            <h3 style="color: #fbbf24; font-size: 20px; font-weight: bold; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 24px;"></span>
                                How to Get Spin Tickets?
                            </h3>
                            <div style="color: #a16207; font-size: 15px; line-height: 1.8;">
                                <div style="margin-bottom: 12px; display: flex; align-items: start; gap: 12px;">
                                    <span style="font-size: 20px;"></span>
                                    <span><strong>Complete Tasks:</strong> Earn 1 spin for every 5 tasks completed</span>
                                </div>
                                <div style="margin-bottom: 12px; display: flex; align-items: start; gap: 12px;">
                                    <span style="font-size: 20px;"></span>
                                    <span><strong>Make Deposits:</strong> Get bonus spins with deposits</span>
                                </div>
                                <div style="margin-bottom: 12px; display: flex; align-items: start; gap: 12px;">
                                    <span style="font-size: 20px;"></span>
                                    <span><strong>Invite Friends:</strong> Receive spins for each referral</span>
                                </div>
                                <div style="display: flex; align-items: start; gap: 12px;">
                                    <span style="font-size: 20px;"></span>
                                    <span><strong>Daily Bonus:</strong> Login daily for free spins</span>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Winners -->
                        <div style="background: linear-gradient(135deg, #1e293b, #334155); border: 1px solid rgba(0, 206, 209, 0.3); border-radius: 20px; padding: 24px; margin-bottom: 32px;">
                            <h3 style="color: white; font-size: 20px; font-weight: bold; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 24px;"></span>
                                Recent Winners
                            </h3>
                            <div style="color: #9ca3af; text-align: center; padding: 40px 20px;">
                                <div style="font-size: 48px; margin-bottom: 12px;"></div>
                                <p style="font-size: 16px;">No winners yet!</p>
                                <p style="font-size: 14px; margin-top: 8px; opacity: 0.8;">Be the first to win big</p>
                            </div>
                        </div>

                        <!-- Prize Pool -->
                        <div style="background: linear-gradient(135deg, #1e293b, #334155); border: 1px solid rgba(0, 206, 209, 0.3); border-radius: 20px; padding: 24px;">
                            <h3 style="color: white; font-size: 20px; font-weight: bold; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 24px;"></span>
                                Prize Pool
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                ${prizes.map(prize => `
                                    <div style="background: rgba(0, 206, 209, 0.1); border: 1px solid rgba(0, 206, 209, 0.3); border-radius: 12px; padding: 16px; text-align: center;">
                                        <div style="font-size: 40px; margin-bottom: 8px;">${prize.emoji}</div>
                                        <div style="color: white; font-weight: bold; font-size: 14px;">${prize.label}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    ${renderBottomNav()}
                </div>
            `;
        }

        function spinWheel() {
            // This function will be implemented later with logic
            const wheel = document.getElementById('luckyWheel');
            const button = document.getElementById('spinButton');
            
            if (!wheel || !button) return;
            
            // Disable button during spin
            button.disabled = true;
            
            // Add spinning animation
            wheel.classList.add('spinning');
            
            // Remove animation after completion
            setTimeout(() => {
                wheel.classList.remove('spinning');
                button.disabled = false;
                // Show result (placeholder)
                showToast(' Spin complete! Logic coming soon...', 'info');
            }, 4000);
        }

        // Main Render
        let renderTimeout = null;
        let lastModalState = { negative: false, triggered: false };
        
        function render() {
            // Debounce renders to prevent flickering modals
            if (renderTimeout) {
                clearTimeout(renderTimeout);
            }
            
            renderTimeout = setTimeout(() => {
                renderTimeout = null;
                actualRender();
            }, 10); // 10ms debounce
        }
        
        function actualRender() {
            const app = document.getElementById('app');
            if (!app) {
                return;
            }
            
            let content = '';
            
            try {
                if (state.currentPage === 'chat') {
                    content = renderChatPage();
                } else if (state.currentPage === 'login') {
                    content = renderLogin();
                } else if (state.currentPage === 'register') {
                    content = renderRegister();
                } else if (state.currentPage === 'home') {
                    content = renderHome();
                } else if (state.currentPage === 'optimization') {
                    content = renderOptimization();
                } else if (state.currentPage === 'records') {
                    content = renderRecords();
                } else if (state.currentPage === 'mycenter') {
                    content = renderMyCenter();
                } else if (state.currentPage === 'deposit') {
                    content = renderDeposit();
                } else if (state.currentPage === 'withdraw') {
                    content = renderWithdraw();
                } else if (state.currentPage === 'paymentMethods') {
                    content = renderPaymentMethods();
                } else if (state.currentPage === 'luckyDraw') {
                    content = renderLuckyDraw();
                } else {
                    content = renderSimplePage(state.currentPage);
                }
                
                // Don't render chat button and support options when on chat page
                if (state.currentPage === 'chat') {
                    app.innerHTML = content;
                } else {
                    app.innerHTML = content + renderPopup() + renderNegativeBalanceModal() + renderNegativeBalanceTriggeredModal() + renderSetCompleteModal() + renderRegistrationBonusModal() + renderGlobalPopupModal() + renderIndividualPopupModal() + renderTermsModal() + renderTrackingModal() + renderSupportOptions() + renderChatButton();
                }
                
                // Add modal-shown class after animation to prevent flicker on re-render
                setTimeout(() => {
                    const modals = document.querySelectorAll('.error-modal');
                    modals.forEach(modal => modal.classList.add('modal-shown'));
                }, 350); // After 0.3s animation completes
                
                // Initialize scroll animations if on home page
                if (state.currentPage === 'home') {
                    initPageAnimations();
                }
                
            } catch (error) {
                app.innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <h2>Error Loading Page</h2>
                        <p>${error.message}</p>
                        <button onclick="location.reload()" class="btn" style="margin-top: 20px;">Reload Page</button>
                    </div>
                `;
            }
        }

        // Image rotation for optimization grid
        setInterval(() => {
            if (state.currentPage === 'optimization') {
                const imageCount = state.productImages.length || 9;
                state.currentAppIndex = (state.currentAppIndex + 1) % imageCount;
                render();
            }
        }, 2000);

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>